/*! @license pzpr.js v3.5.2-pre (c) 2009-2015 sabo2, MIT license
 *   https://bitbucket.org/sabo2/pzprv3 */
pzpr.classmgr.makeCustom(["nagare"],{MouseEvent:{mouseinput:function(){this.owner.playmode?this.btn.Left?this.mousestart||this.mousemove?this.inputLine():this.mouseend&&this.notInputted()&&this.clickmark():this.btn.Right&&(this.mousestart?this.inputmark_mousedown():2===this.inputData||3===this.inputData?this.inputpeke():this.mousemove&&this.inputmark_mousemove()):this.owner.editmode&&(this.mousestart||this.mousemove?this.inputarrow_cell():this.mouseend&&this.notInputted()&&this.inputShadeCell())},clickmark:function(){var a=this.getpos(.22);if(!this.prevPos.equals(a)){var b=a.getb();if(!b.isnull){var c={0:2,2:0},d=this.owner.getConfig("dirauxmark");d&&(c=b.isvert?this.btn.Left?{0:2,2:13,13:14,14:0}:{0:14,14:13,13:2,2:0}:this.btn.Left?{0:2,2:11,11:12,12:0}:{0:12,12:11,11:2,2:0}),b.setQsub(c[b.qsub]||0),d||b.setLineVal(0),b.draw()}}},inputmark_mousedown:function(){var a=this.getpos(.22),b=a.getb();this.owner.getConfig("dirauxmark")&&b.isnull||(this.inputData=b.isnull||2!==b.qsub?2:3,this.inputpeke())},inputmark_mousemove:function(){var a=this.getpos(0);if(!a.getc().isnull){var b=this.getnb(this.prevPos,a);if(!b.isnull){var c=null,d=this.getdir(this.prevPos,a);null===this.inputData&&(this.inputData=b.qsub!==10+d?11:0),11===this.inputData?c=10+d:0===this.inputData&&b.qsub===10+d&&(c=0),null!==c&&(b.setQsub(c),b.draw())}this.prevPos=a}},inputarrow_cell_main:function(a,b){a.setQdir(a.qdir!==b?b:0)},inputShadeCell:function(){var a=this.getcell();a.isnull||a===this.mouseCell||(a!==this.cursor.getc()&&this.owner.getConfig("cursor")?this.setcursor(a):(a.setQues(1===a.ques?0:1),a.drawaround()))}},KeyEvent:{enablemake:!0,moveTarget:function(a){return a.match(/shift/)?!1:this.moveTCell(a)},keyinput:function(a){this.key_inputdirec(a)||this.key_inputques_nagare(a)},key_inputques_nagare:function(a){if("q"===a||"w"===a){var b=this.cursor.getc();b.setQues(1!==b.ques?1:0),b.drawaround()}}},Cell:{wind:0,noLP:function(){return 1===this.ques}},Border:{wind:0,enableLineNG:!0,setLine:function(){this.setLineVal(1),2===this.qsub&&this.setQsub(0)},removeLine:function(){this.setLineVal(0),2===this.qsub&&this.setQsub(0)}},Board:{hasborder:1,generateWind:function(){for(var a=0;a<this.cellmax;a++)this.cell[a].wind=0;for(var a=0;a<this.bdmax;a++)this.border[a].wind=0;this.owner.checker.checkRowsColsPartly(this.setWind,function(a){return 1===a.ques},null)},setWind:function(a,b){var c=this.owner.board,d=a.getRectSize(),e=b.isvert?c.getc(d.x1,d.y1-2):c.getc(d.x1-2,d.y1),f=b.isvert?c.getc(d.x2,d.y2+2):c.getc(d.x2+2,d.y2),g=e.qdir===(b.isvert?e.DN:e.RT),h=f.qdir===(b.isvert?e.UP:e.LT);if(g||h){var i=0;g&&h?i=b.isvert?3:12:g?i=b.isvert?2:8:h&&(i=b.isvert?1:4);for(var j=0;j<a.length;j++)a[j].wind+=i;e.isnull||(e.wind+=i),f.isnull||(f.wind+=i);for(var k=c.borderinside(d.x1,d.y1,d.x2,d.y2),j=0;j<k.length;j++)k[j].wind+=i}return!0},getTraceInfo:function(){for(var a=[],b=this.getLineShapeInfo(),c=1;c<=b.max;c++){var d,e=b.path[c],f=this.searchTraceInfo(e.cells[0],e.dir1),g=this.searchTraceInfo(e.cells[1],e.dir2),h=f.clist.length,i=g.clist.length;if(i>h)d=f;else if(h>i)d=g;else{var j=f.blist.length,k=g.blist.length;d=k>j?f:g}a.push(d)}return a},searchTraceInfo:function(a,b){for(var c={clist:new this.owner.CellList,blist:new this.owner.BorderList},d=a.getaddr(),e=0,f=0;;)if(d.movedir(b,1),d.oncell()){var g=d.getc();if(a===g)break;g.qdir!==g.NDIR&&g.qdir!==b&&(c.clist[e++]=g);var h=g.adjborder;if(2!==g.lcnt)break;1!==b&&h.bottom.isLine()?b=2:2!==b&&h.top.isLine()?b=1:3!==b&&h.right.isLine()?b=4:4!==b&&h.left.isLine()&&(b=3)}else{var i=d.getb();if(!i.isLine())break;i.wind&(15^[0,1,2,4,8][b])&&(c.blist[f++]=i)}return c.clist.length=e,c.blist.length=f,c}},LineManager:{isCenterLine:!0,getLineShapeBase:function(){var a=this.owner.board.cell;return[a.filter(this.getLineShapeSeparator),a.filter(function(a){return a.isLineCurve()})]},getLineShapeSeparator:function(a){return 1===a.lcnt||a.lcnt>=3}},BoardExec:{adjustBoardData:function(a,b){if(this.adjustCellArrow(a,b),a&this.TURNFLIP)for(var c=this.getTranslateDir(a),d=this.owner.board.borderinside(b.x1,b.y1,b.x2,b.y2),e=0;e<d.length;e++){var f,g=d[e];f=c[g.qsub-10],f&&g.setQsub(f+10)}}},Flags:{redline:!0,irowake:1},Graphic:{cellcolor_func:"ques",gridcolor_type:"LIGHT",errbcolor1_type:"DARK",paint:function(){this.drawBGCells(),this.drawDashedGrid(),this.drawShadedCells(),this.drawCellArrows(),this.drawLines(),this.drawPekes(),this.drawBorderAuxDir(),this.drawChassis(),this.drawTarget()},getCellArrowColor:function(a){return 0===a.ques?this.quescolor:"white"},drawBorderAuxDir:function(){var a=this.vinc("border_dirsub","crispEdges"),b=.1*this.cw;a.lineWidth=.1*this.cw,a.strokeStyle=this.borderQsubcolor2;for(var c=this.range.borders,d=0;d<c.length;d++){var e=c[d],f=e.bx*this.bw,g=e.by*this.bh,h=e.qsub-10;if(a.vid="b_daux_"+e.id,h>=1&&8>=h){switch(a.beginPath(),h){case e.UP:a.setOffsetLinePath(f,g,2*-b,+b,0,-b,2*+b,+b,!1);break;case e.DN:a.setOffsetLinePath(f,g,2*-b,-b,0,+b,2*+b,-b,!1);break;case e.LT:a.setOffsetLinePath(f,g,+b,2*-b,-b,0,+b,2*+b,!1);break;case e.RT:a.setOffsetLinePath(f,g,-b,2*-b,+b,0,-b,2*+b,!1)}a.stroke()}else a.vhide()}}},Encode:{decodePzpr:function(){this.decodeNagare()},encodePzpr:function(){this.encodeNagare()},decodeNagare:function(){var a=0,b=0,c=this.outbstr,d=this.owner.board;for(b=0;b<c.length;b++){var e=d.cell[a],f=c.charAt(b);if(this.include(f,"1","9")){var g=parseInt(f,10);e.ques=g/5|0,e.qdir=g%5}else this.include(f,"a","z")&&(a+=parseInt(f,36)-10);if(a++,a>=d.cellmax)break}this.outbstr=c.substr(b+1)},encodeNagare:function(){for(var a="",b=0,c=this.owner.board,d=0;d<c.cellmax;d++){var e="",f=c.cell[d],g=f.ques,h=f.qdir;1===g||h>=1&&4>=h?e=(5*g+h).toString():b++,0===b?a+=e:(e||26===b)&&(a+=(9+b).toString(36)+e,b=0)}b>0&&(a+=(9+b).toString(36)),this.outbstr+=a}},FileIO:{decodeData:function(){this.decodeCell(function(a,b){if("."!==b){var c={u:1,d:2,l:3,r:4,N:5,U:6,D:7,L:8,R:9}[b];a.ques=c/5|0,a.qdir=c%5}}),this.decodeBorder(function(a,b){var c=b.charAt(b.length-1);c>="a"&&"z">=c&&("u"===c?a.qsub=11:"d"===c?a.qsub=12:"l"===c?a.qsub=13:"r"===c&&(a.qsub=14),b=b.substr(0,b.length-1)),""!==b&&"0"!==b&&("-"===b.charAt(0)?(a.line=-parseInt(b)-1,a.qsub=2):a.line=parseInt(b))})},encodeData:function(){this.encodeCell(function(a){if(1===a.ques||a.qdir>=1&&a.qdir<=4){var b=5*a.ques+a.qdir;return["u ","d ","l ","r ","N ","U ","D ","L ","R "][b-1]}return". "}),this.encodeBorder(function(a){var b="";return 2===a.qsub?b+=""+(-1-a.line):a.line>0&&(b+=""+a.line),a.qsub>=11&&(b+=["u","d","l","r"][a.qsub-11]),""!==b?b+" ":"0 "})}},AnsCheck:{checklist:["checkLineExist+","checkBothSideWind","checkArrowAgainst","checkLineOnShadeCell","checkCrossLine+","checkBranchLine+","checkAcrossArrow","checkLineArrowDirection","checkLineWindDirection","checkAcrossWind","checkAllArrow","checkDeadendLine++","checkOneLoop"],getTraceInfo:function(){return this.generateWind(),this._info.trace=this._info.trace||this.owner.board.getTraceInfo()},generateWind:function(){this._info.wind||(this.owner.board.generateWind(),this._info.wind=!0)},checkBothSideWind:function(){this.generateWind(),this.checkAllCell(function(a){return 1===a.ques&&(3===(3&a.wind)||12===(12&a.wind))},"windBothSide")},checkArrowAgainst:function(){this.generateWind();for(var a=this.owner.board.cell,b=0;b<a.length;b++){var c=a[b],d=c.wind&(15^[0,1,2,4,8][c.qdir]);if(0!==c.qdir&&1!==c.ques&&d){if(this.failcode.add("arAgainstWind"),this.checkOnly)break;this.setCellErrorToWindBase(c,d)}}},checkAcrossWind:function(){this.generateWind();for(var a=this.owner.board.cell,b=0;b<a.length;b++){var c=a[b],d=0!==(3&c.wind)&&2===c.isLineStraight(),e=0!==(12&c.wind)&&1===c.isLineStraight();if(d||e){if(this.failcode.add("lrAcrossWind"),this.checkOnly)break;this.setCellErrorToWindBase(c,c.wind&((d?3:0)|(e?12:0)))}}},checkAcrossArrow:function(){this.checkAllCell(function(a){var b=a.adjborder;return(1===a.qdir||2===a.qdir)&&(b.left.isLine()||b.right.isLine())||(3===a.qdir||4===a.qdir)&&(b.top.isLine()||b.bottom.isLine())},"lrAcrossArrow")},checkAllArrow:function(){this.checkAllCell(function(a){return 0===a.ques&&a.qdir>0&&0===a.lcnt},"arNoLine")},checkLineWindDirection:function(){for(var a=this.getTraceInfo(),b=0;b<a.length;b++){var c=a[b].blist;if(0!==c.length){if(this.failcode.add("lrAgainstWind"),this.checkOnly)break;this.owner.board.border.setnoerr();for(var d=0;d<c.length;d++)this.setBorderErrorToWindBase(c[d],c[d].wind)}}},checkLineArrowDirection:function(){for(var a=this.getTraceInfo(),b=0;b<a.length;b++){var c=a[b].clist;if(0!==c.length){if(this.failcode.add("lrAgainstArrow"),this.checkOnly)break;c.seterr(1)}}},setCellErrorToWindBase:function(a,b){var c;if(a.seterr(1),1&b)for(c=a;!c.isnull;){if(1===c.ques){c.seterr(1);break}c=c.adjacent.bottom}if(2&b)for(c=a;!c.isnull;){if(1===c.ques){c.seterr(1);break}c=c.adjacent.top}if(4&b)for(c=a;!c.isnull;){if(1===c.ques){c.seterr(1);break}c=c.adjacent.right}if(8&b)for(c=a;!c.isnull;){if(1===c.ques){c.seterr(1);break}c=c.adjacent.left}},setBorderErrorToWindBase:function(a,b){var c;if(a.seterr(1),1&b)for(c=a.sidecell[1];!c.isnull;){if(1===c.ques){c.seterr(1);break}c=c.adjacent.bottom}if(2&b)for(c=a.sidecell[0];!c.isnull;){if(1===c.ques){c.seterr(1);break}c=c.adjacent.top}if(4&b)for(c=a.sidecell[1];!c.isnull;){if(1===c.ques){c.seterr(1);break}c=c.adjacent.right}if(8&b)for(c=a.sidecell[0];!c.isnull;){if(1===c.ques){c.seterr(1);break}c=c.adjacent.left}}},FailCode:{windBothSide:["風が向かい合わせに吹いています。","The wind blows from both sides."],arNoLine:["線が通っていない矢印があります。","A line doesn't go through some arrows."],arAgainstWind:["矢印の向きが風の指示と合っていません。","The direction of the arrow is against the wind."],lrAcrossWind:["線が風で流されずに横切っています。","The line passes across the wind."],lrAcrossArrow:["線が矢印を横切っています。","The line passes across an arrow."],lrAgainstWind:["線が風上に向かって進んでいます。","The line passes against the wind."],lrAgainstArrow:["線が矢印に反して進んでいます。","The line passes against an arrow."]}});