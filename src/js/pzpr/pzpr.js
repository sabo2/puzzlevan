/*! @license pzpr.js v0.3.2 (c) 2009-2016 sabo2, MIT license
 *   https://bitbucket.org/sabo2/pzprv3 */
!function(){var a={version:"0.3.2"};"object"==typeof module&&module.exports?module.exports=a:this.pzpr=a,function(){var b=this.document,d={exports:{}},e=d.exports;!function(a,d){var e="undefined"!=typeof b?b:void 0,f=2*Math.PI,g=[],h=function(){for(var a=[],b=256;512>b;b++)a[b-256]=b.toString(16).substr(1);return a}(),i={version:"0.7.0",env:{node:"object"==typeof a&&"object"==typeof d&&"function"==typeof require,browser:"object"==typeof b&&"object"==typeof window&&"object"==typeof location},wrapper:{},addWrapper:function(a,b){var c,d=function(){this.initialize&&this.initialize.apply(this,arguments)};for(c in this.wrapperbase)d.prototype[c]=this.wrapperbase[c];for(c in b)d.prototype[c]=b[c];this.wrapper[a]=d.prototype.constructor=d,this.addType(a)},_order:[],enable:{},addType:function(a){this._order.push(a),this.enable[a]=!0,this.current||(this.current=a)},TypeList:function(a){for(var b=0;b<i._order.length;b++)this[i._order[b]]=i._order[b]===a},current:"",select:function(a){return this.enable[a]?(this.current=a,!0):!1},ME:null,initME:function(){var a=e.createElement("div");a.style.display="inline",a.style.position="absolute",a.style.top="0px",a.style.left="-9000px",a.innerHTML="",e.body.appendChild(a),void 0!==a.offsetHeight?this.ME=a:e.body.removeChild(a)},getoffsetHeight:function(a,b){var c;if(b.match(/(.+\s)?([0-9]+)px (.+)$/))c=+RegExp.$2;else if(this.ME){var d=this.ME;d.style.font=b,d.style.lineHeight="100%",d.innerHTML=a,c=d.offsetHeight}return c},color:g,parse:function(a){if(!g[a])if("rgb("===a.substr(0,4)){var b=a.match(/\d+/g);g[a]=["#",h[b[0]],h[b[1]],h[b[2]]].join("")}else g[a]=a;return g[a]},getRectSize:function(a){return{width:a.offsetWidth||a.clientWidth||0,height:a.offsetHeight||a.clientHeight||0}},_counter:-1,getcanvasid:function(){return this._counter++,"_candle_"+this._counter},start:function(a,b,c){this.ME||"undefined"==typeof window||this.initME();var d;if(a.getContext)d=a.getContext("2d");else{var e=b;if(this.enable[e]||(e=this.current),!e||!this.enable[e])throw"No canvas environment is installed";d=new this.wrapper[e](a)}c&&c(d)}};"object"==typeof a&&"object"==typeof d?a.exports=i:this.Candle=i,function(){function a(){if(this.parentNode){var a=this.parentNode._children,b=a.indexOf(this);return b>=0?a[b+1]:null}}function b(a){a.parentNode&&a.parentNode.removeChild(a),this._children.push(a),a.parentNode=this}function c(a){var b=this._children.indexOf(a);return b>=0&&(this._children.splice(b,1),a.parentNode=null),a}function d(a,b){a.parentNode&&a.parentNode.removeChild(a);var c=-1;b&&(c=this._children.indexOf(b)),-1===c?this.appendChild(a):this._children.splice(c,0,a)}function f(a,b){a=a.replace(/\*/g,"[^/]+"),a=a.replace(/([\w#]+|\*)/g,"[^/]*$1[^/]*"),a=a.replace(/\s+/g,"/([^/]+/)?"),a=new RegExp(a+"[^/]*$");for(var c=this.firstChild?[this.firstChild]:[],d=[];c.length>0;){var e=c.pop();if(j(e,this).match(a)&&(d.push(e),b))break;e.nextSibling&&c.push(e.nextSibling),e.childNodes.length>0&&c.push(e.firstChild)}return d}function g(a){return f.call(this,a,!1)}function h(a){return f.call(this,a,!0)[0]||null}function j(a,b){for(var c="";a&&a!==b;){var d="";a.createElement||(d=a.tagName+(a._attr.id?"#"+a._attr.id:"")),c=d+(c?"/"+c:""),a=a.parentNode}return c}function k(){return this._children.reduce(function(a,b,c,d){return a+b.outerHTML},"")}function l(){var a=this.tagName,b="",c="";for(var d in this._attr)b+=" "+d+'="'+this._attr[d]+'"';for(var e in this.style)c+=e+":"+this.style[e]+";";return c&&(b+=' style="'+c+'"'),0===this._children.length?"<"+a+b+"/>":"<"+a+b+">"+this.innerHTML+"</"+a+">"}function m(a,b){for(;;){var c=b.match(/^\s*([^:]+?):([^;]+?);?/);if(!c)break;a.style[c[1]]=c[2],b=RegExp["$'"]}}function n(a,b){for(;;){var c=b.match(/^\s*([\w\-\:]+)(\=)?(?:['"](.+?)['"]|([^\s]+))?\s*/);if(!c)break;var d=c[1],e=c[3]||c[4]||"";b=RegExp["$'"],d&&("="===c[2]?"style"!==d?a.setAttribute(d,e):a.style=m(a,e):a.setAttribute(d,!0))}}function o(a,b){var c=[a],d=b.split(/(<.+?>)/g);return d.forEach(function(a){var b=c[c.length-1],d=null;if(!a.match(/^<\?xml/))if(a.match(/^<\w/)){var e=a.match(/<(\w+)\s*(.*)\/?>/);d=new p(e[1]),n(d,e[2]),b.appendChild(d),a.match(/\/>$/)||c.push(d)}else if(a.match(/^<\//))c.pop();else{if(a.match(/^[\s\t\r\n]*$/))return;b.appendChild(new q(a))}}),a}if(!e){var p=function(a){this.tagName=a,this._attr={},this.style={},this._children=[]};p.prototype={tagName:"",style:null,_attr:null,_children:null,parentNode:null,nodeType:1,get nodeName(){return this.tagName},get firstChild(){return this._children[0]},get lastChild(){return this._children[this._children.length-1]},get childNodes(){return this._children},get nextSibling(){return a.call(this)},appendChild:b,removeChild:c,insertBefore:d,setAttribute:function(a,b){this._attr[a]=b},setAttributeNS:function(a,b,c){this._attr[b]=c},getAttribute:function(a){return a in this._attr?this._attr[a]:null},getAttributeNS:function(a,b){return b in this._attr?this._attr[b]:null},removeAttribute:function(a){delete this._attr[a]},get id(){return this._attr.id||""},get innerHTML(){return k.call(this)},get outerHTML(){return l.call(this)},get textContent(){return this.innerHTML.replace(/<.+?>/g,"")},set textContent(a){this._children.forEach(function(a){this.removeChild(a)}.bind(this)),this.appendChild(new q(a))},querySelector:h,querySelectorAll:g};var q=function(a){this.data=a};q.prototype={_attr:{},parentNode:null,nodeType:3,nodeName:"#text",data:"",firstChild:null,chilsNodes:[],get nextSibling(){return a.call(this)},get outerHTML(){return this.data}};var r=i.MockDocument=function(){this._children=[]};r.prototype={_children:null,nodeType:9,nodeName:"#document",createElement:function(a){return new p(a)},createElementNS:function(a,b){return new p(b)},createTextNode:function(a){return new q(a)},get firstChild(){return this._children[0]},get lastChild(){return this._children[this._children.length-1]},get childNodes(){return this._children},appendChild:b,removeChild:c,insertBefore:d,get innerHTML(){return k.call(this)},get outerHTML(){return k.call(this)},querySelector:h,querySelectorAll:g,getElementById:function(a){return this.querySelector("#"+a)}};var s=i.MockXMLSerializer=function(){};s.prototype.serializeToString=function(a){return a.outerHTML};var t=i.MockDOMParser=function(){};t.prototype.parseFromString=function(a,b){var c=new r;return o(c,a)},i.document=e=new r,i.XMLSerializer=s,i.DOMParser=t}}(),i.wrapperbase={initialize:function(a){this.fillStyle="black",this.strokeStyle="black",this.lineWidth=1,this.font="14px system",this.textAlign="center",this.textBaseline="middle",this.canvas=a,this.canvasid=i.getcanvasid(),this.child=null,this.initElement(),this.initFunction(),this.initLayer();var b=this;this.canvas.getContext=function(a){return b}},rectcenter:function(a,b,c,d){this.rect(a-c,b-d,2*c,2*d)},fillRectCenter:function(a,b,c,d){this.fillRect(a-c,b-d,2*c,2*d)},strokeRectCenter:function(a,b,c,d){this.strokeRect(a-c,b-d,2*c,2*d)},shapeRectCenter:function(a,b,c,d){this.shapeRect(a-c,b-d,2*c,2*d)},vhide:function(){}},function(){function a(a){return e.createElementNS(g,a)}function b(){var a="undefined"!=typeof navigator?navigator.userAgent||"":"";d=a.match(/Chrome/)?{"candle-top":-.72,top:-.95,hanging:-.72,middle:-.35,alphabetic:0,bottom:.25}:a.match(/AppleWebKit/)?{"candle-top":-.7,top:-.9,hanging:-.9,middle:-.35,alphabetic:0,bottom:.25}:a.match(/Trident/)?{"candle-top":-.74,top:-1.02,hanging:-1.02,middle:-.32,alphabetic:0,bottom:.45}:a.match(/Win/)?{"candle-top":-.7,top:-.85,hanging:-.85,middle:-.34,alphabetic:0,bottom:.15}:{"candle-top":-.76,top:-.9,hanging:-.9,middle:-.38,alphabetic:0,bottom:.08}}if("undefined"!=typeof e&&e.createElementNS&&("object"!=typeof window||!window.opera)){var d,g=i.SVGNS="http://www.w3.org/2000/svg",h=i.XLINKNS="http://www.w3.org/1999/xlink",j="M",k="L",l="A",m="z",n="d",o="fill",p="stroke",q="stroke-width",r="shape-rendering",s="none",t={left:"start",center:"middle",right:"end"};i.addWrapper("svg",{initialize:function(a){this.use=new i.TypeList("svg"),d||b(),this.vid="",this.elements={},this._textcache={},this.target=null,this.layers={},this.cpath=[],this.lastpath="",this.freezepath=!1,i.wrapperbase.initialize.call(this,a)},initElement:function(){i.env.browser&&(this.canvas.style.overflow="hidden");var a=i.getRectSize(this.canvas),b=this.child=e.createElementNS(g,"svg");b.setAttribute("xmlns",g),b.setAttribute("xmlns:xlink",h),b.setAttribute("font-size","10px"),b.setAttribute("font-family","sans-serif"),b.setAttribute("width",a.width),b.setAttribute("height",a.height),b.setAttribute("viewBox",[0,0,a.width,a.height].join(" ")),this.canvas.appendChild&&this.canvas.appendChild(b)},initFunction:function(){function a(a){return i.env.browser?window.btoa(a):Buffer.isBuffer(a)?a.toString("base64"):new Buffer(a.toString(),"binary").toString("base64")}function b(a){return(a.outerHTML||(new c).serializeToString(a)).replace(/^<\?xml.+?\?>[\r\n]*/,"")}var d='<?xml version="1.0" encoding="UTF-8"?>\n',e=this.child;this.canvas.toDataURL=function(c,d){return"data:image/svg+xml;base64,"+a(b(e))},this.canvas.toBlob=function(a,c,f){a(new Blob([d+b(e)],{type:"image/svg+xml"}))},this.canvas.toBuffer=function(a,c){return d+b(e)}},initLayer:function(){this.setLayer();var a=i.getRectSize(this.canvas);this.rect(0,0,a.width,a.height),this.addVectorElement(!1,!1)},clear:function(){for(var a=this.child,b=a.firstChild;b;)a.removeChild(b),b=a.firstChild;this.vid="",this.elements={},this.layers={},this.target=this.child,this.setLayer(),this._textcache={}},setLayer:function(b,c){if(c=c||{},this.vid="",b){var d=this.layers[b];d||(d=this.layers[b]=a("g"),this.child.appendChild(d)),this.target=d}else this.target=this.child;c.rendering&&this.setRendering(c.rendering),this.freezepath=!!c&&c.freeze},setRendering:function(a){this.target.setAttribute(r,a)},changeSize:function(a,b){i.env.browser&&(this.canvas.style.width=a+"px",this.canvas.style.height=b+"px");var c=this.child;c.setAttribute("width",a),c.setAttribute("height",b);var d=c.getAttribute("viewBox").split(/ /);c.setAttribute("viewBox",[d[0],d[1],a,b].join(" "))},translate:function(a,b){var c=this.child.getAttribute("viewBox").split(/ /);c[0]=-a,c[1]=-b,this.child.setAttribute("viewBox",c.join(" "))},beginPath:function(){this.cpath=[],this.lastpath=""},closePath:function(){this.cpath.push(m),this.lastpath=m},moveTo:function(a,b){this.cpath.push(j,a,b),this.lastpath=j},lineTo:function(a,b){this.lastpath!==k&&this.cpath.push(k),this.cpath.push(a,b),this.lastpath=k},rect:function(a,b,c,d){this.cpath.push(j,a,b,k,a+c,b,a+c,b+d,a,b+d,m),this.lastpath=m},arc:function(a,b,c,d,e,g){var h,i,k,m;e-d>=f?(h=a+c,i=b,k=a+c,m=b):(h=a+c*Math.cos(d),i=b+c*Math.sin(d),k=a+c*Math.cos(e),m=b+c*Math.sin(e)),e-d>=f&&(i+=.125);var n=d>e!=Math.abs(e-d)>Math.PI,o=g^n?1:0,p=0===o^n?1:0;this.cpath.push(j,h,i,l,c,c,0,o,p,k,m),this.lastpath=l},fill:function(){this.addVectorElement(!0,!1)},stroke:function(){this.addVectorElement(!1,!0)},shape:function(){this.addVectorElement(!0,!0)},fillRect:function(a,b,c,d){var e=this.cpath;this.cpath=[],this.rect(a,b,c,d),this.addVectorElement(!0,!1),this.cpath=e},strokeRect:function(a,b,c,d){var e=this.cpath;this.cpath=[],this.rect(a,b,c,d),this.addVectorElement(!1,!0),this.cpath=e},shapeRect:function(a,b,c,d){var e=this.cpath;this.cpath=[],this.rect(a,b,c,d),this.addVectorElement(!0,!0),this.cpath=e},setLinePath:function(){for(var a=arguments,b=a.length,c=b-(1|b?1:2),d=[],e=0;c>e;e+=2)d[e>>1]=[a[e],a[e+1]];this.beginPath(),this.setLinePath_com.call(this,d),a[b-1]&&this.cpath.push(m)},setOffsetLinePath:function(){for(var a=arguments,b=a.length,c=b-(1|b?1:2),d=[],e=0;c-2>e;e+=2)d[e>>1]=[a[e+2]+a[0],a[e+3]+a[1]];this.beginPath(),this.setLinePath_com.call(this,d),a[b-1]&&this.cpath.push(m)},setLinePath_com:function(a){for(var b=0,c=a.length;c>b;b++)this.cpath.push(0===b?j:k),this.cpath.push(a[b][0],a[b][1])},strokeLine:function(a,b,c,d){var e=this.cpath;this.cpath=[j,a,b,k,c,d],this.addVectorElement(!1,!0),this.cpath=e},strokeDashedLine:function(a,b,c,d,e){var f=this.cpath;this.cpath=[j,a,b,k,c,d];var g=this.addVectorElement(!1,!0);g.setAttribute("stroke-dasharray",e.join(" ")),this.cpath=f},strokeCross:function(a,b,c){var d=this.cpath;this.cpath=[j,a-c,b-c,k,a+c,b+c,j,a-c,b+c,k,a+c,b-c],this.addVectorElement(!1,!0),this.cpath=d},fillCircle:function(a,b,c){var d=this.cpath;this.cpath=[],this.arc(a,b,c,0,f,!1),this.cpath.push(m),this.addVectorElement(!0,!1),this.cpath=d},strokeCircle:function(a,b,c){var d=this.cpath;this.cpath=[],this.arc(a,b,c,0,f,!1),this.cpath.push(m),this.addVectorElement(!1,!0),this.cpath=d},shapeCircle:function(a,b,c){var d=this.cpath;this.cpath=[],this.arc(a,b,c,0,f,!1),this.cpath.push(m),this.addVectorElement(!0,!0),this.cpath=d},getDefsElement:function(){var a=this.child.querySelector("defs");return a||(a=e.createElementNS(g,"defs"),this.child.insertBefore(a,this.child.firstChild||null)),a},getImageElement:function(b){for(var c=this.getDefsElement(),d=null,e=c.querySelectorAll("image"),f=0;f<e.length;f++)if(e[f].getAttributeNS(h,"href")===b.src){d=e[f];break}return d||(d=a("image"),d.setAttribute("id",(d.ownerDocument?this.canvasid+"_":"")+"img"+e.length),d.setAttribute("width",b.width),d.setAttribute("height",b.height),d.setAttributeNS(h,"xlink:href",b.src),c.appendChild(d)),d},getImageSymbol:function(a,b,c,d,f){for(var i=this.getDefsElement(),j=[b,c,d,f].join(" "),k=null,l=i.querySelectorAll("symbol"),m=0;m<l.length;m++)if(l[m].getAttribute("viewBox")===j){k=l[m];break}if(!k){k=e.createElementNS(g,"symbol"),k.setAttribute("id",(k.ownerDocument?this.canvasid+"_":"")+"symimg"+l.length),k.setAttribute("viewBox",j);var n=e.createElementNS(g,"use");n.setAttributeNS(h,"xlink:href","#"+this.getImageElement(a).getAttribute("id")),k.appendChild(n),i.appendChild(k)}return k},fillText:function(a,b,c){var d=this.vid?this.elements[this.vid]:null;if(a&&this.fillStyle&&"none"!==this.fillStyle){var e=this.fillText_main(d,a,b,c);!d&&this.vid&&(this.elements[this.vid]=e)}else d&&this.hide(d);this.vid=""},fillText_main:function(b,c,e,f){var g=!b,h=this.vid?this._textcache[this.vid]||{}:{};if(g?b=a("text"):this.show(b),b.getAttribute(o)!==this.fillStyle&&b.setAttribute(o,this.fillStyle),h.x!==e||h.y!==f||h.ta!==this.textAlign||h.tb!==this.textBaseline||h.font!==this.font){var j=f-i.getoffsetHeight(c,this.font)*d[this.textBaseline.toLowerCase()],k=t[this.textAlign.toLowerCase()];b.getAttribute("x")!==e&&b.setAttribute("x",e),b.getAttribute("y")!==j&&b.setAttribute("y",j),b.getAttribute("text-anchor")!==k&&b.setAttribute("text-anchor",k),h.x=e,h.y=f,h.ta=this.textAlign,h.tb=this.textBaseline}if(h.font!==this.font){if(this.font.match(/(.+\s)?([0-9]+)px (.+)$/)){var l=RegExp.$1,m=RegExp.$2,n=RegExp.$3;b.setAttribute("font-size",m),n.match(/^sans\-serif$/i)?b.removeAttribute("font-family"):b.setAttribute("font-family",n),l.match(/(italic|oblique)/)?b.setAttribute("font-style",RegExp.$1):b.removeAttribute("font-style"),l.match(/(bold|bolder|lighter|[1-9]00)/)?b.setAttribute("font-weight",RegExp.$1):b.removeAttribute("font-weight")}else b.setAttribute("font",this.font);h.font=this.font}return b.textContent!==c&&(b.textContent=c),this.vid&&(this._textcache[this.vid]=h),g&&this.target.appendChild(b),b},drawImage:function(a,b,c,d,e,f,g,h,i){var j=this.vid?this.elements[this.vid]:null;if(a){void 0===d&&(d=a.width,e=a.height),void 0===f&&(f=b,b=0,g=c,c=0,h=d,i=e);var k=this.drawImage_main(j,a,b,c,d,e,f,g,h,i);!j&&this.vid&&(this.elements[this.vid]=k)}else j&&this.hide(j);this.vid=""},drawImage_main:function(b,c,d,e,f,g,i,j,k,l){var m=!b;m?b=a("use"):this.show(b);var n=this.getImageSymbol(c,d,e,f,g).getAttribute("id");return b.getAttribute("x")!==i&&b.setAttribute("x",i),b.getAttribute("y")!==j&&b.setAttribute("y",j),b.getAttribute("width")!==k&&b.setAttribute("width",k),b.getAttribute("height")!==l&&b.setAttribute("height",l),b.getAttributeNS(h,"xlink:href")!=="#"+n&&b.setAttributeNS(h,"xlink:href","#"+n),m&&this.target.appendChild(b),b},addVectorElement:function(a,b){a=a&&!!this.fillStyle&&"none"!==this.fillStyle,b=b&&!!this.strokeStyle&&"none"!==this.strokeStyle;var c=this.vid?this.elements[this.vid]:null,d=null;return a||b?(d=this.addVectorElement_main(c,a,b),!c&&this.vid&&(this.elements[this.vid]=d)):c&&this.hide(c),this.vid="",d},addVectorElement_main:function(b,c,d){var e=!b;if(e?(b=a("path"),b.setAttribute(o,s),b.setAttribute(p,s)):this.show(b),!this.freezepath||e){var f=this.cpath.join(" "),g=d?this.lineWidth:null;b.getAttribute(n)!==f&&b.setAttribute(n,f),b.getAttribute(q)!==g&&b.setAttribute(q,g)}var h=c?this.fillStyle:s,i=d?this.strokeStyle:s;return b.getAttribute(o)!==h&&b.setAttribute(o,h),b.getAttribute(p)!==i&&b.setAttribute(p,i),e&&this.target.appendChild(b),b},vhide:function(a){var b=this.elements[this.vid];b&&this.hide(b)},show:function(a){a.removeAttribute("display")},hide:function(a){a.setAttribute("display","none")}})}}(),function(){function a(){var a="undefined"!=typeof navigator?navigator.userAgent||"":"";c=0,c=a.match(/Chrome/)?-.72:a.match(/AppleWebKit/)?-.7:a.match(/Trident/)?-.74:a.match(/Win/)?-.7:-.76}if(i.env.browser){if(!function(){var a=e.createElement("canvas");return!!a.getContext&&(!a.probablySupportsContext||a.probablySupportsContext("2d"))}())return}else try{i.Canvas=require("canvas")}catch(b){return}var c;i.addWrapper("canvas",{initialize:function(b){this.context=null,this.use=new i.TypeList("canvas"),this.currentLayerId="_empty",this.isedgearray={_empty:!1},this.isedge=!1,c||a(),this.x0=0,this.y0=0,i.wrapperbase.initialize.call(this,b)},setkey:function(a){return this},hidekey:function(a){return this},release:function(a){return this},initElement:function(){var a=this.child=i.env.browser?e.createElement("canvas"):new i.Canvas;i.env.browser&&(this.canvas.style.overflow="hidden");var b=i.getRectSize(this.canvas);a.width=b.width,a.height=b.height,i.env.browser&&(a.style.width=b.width+"px",a.style.height=b.height+"px",this.canvas.appendChild(a)),this.context=a.getContext("2d")},initFunction:function(){function a(a){return i.env.browser?window.atob(a):new Buffer(RegExp.$2,"base64").toString("binary")}var b=this.child;this.canvas.toDataURL=function(a,c){return b.toDataURL(a||void 0,c)},this.canvas.toBlob=function(c,d,e){if("function"==typeof b.toBlob)b.toBlob(c,d,e);else{b.toDataURL(d||void 0,e).match(/data:(.*);base64,(.*)/);for(var f=a(RegExp.$2),g=f.length,h=new Uint8Array(g),i=0;g>i;i++)h[i]=f.charCodeAt(i);c(new Blob([h.buffer],{type:RegExp.$1}))}},this.canvas.toBuffer=function(c,d){var e=b.toDataURL(c||void 0,d).replace(/^data:image\/\w+?;base64,/,"");if(i.env.node)return new Buffer(e,"base64");var f;if("undefined"!=typeof Uint8Array){var g=a(e);f=new Uint8Array(g.length);for(var h=0;h<g.length;h++)f[h]=g.charCodeAt(h)}else f=a(e);return f}},initLayer:function(){this.setLayer()},clear:function(){if(this.setProperties(!0,!0),this.context.setTransform(1,0,0,1,0,0),this.context.translate(this.x0,this.y0),i.env.browser){var a=i.getRectSize(this.canvas);this.context.clearRect(0,0,a.width,a.height)}},setLayer:function(a,b){var c=this.currentLayerId=a?a:"_empty";this.isedge=this.isedgearray[void 0!==this.isedgearray[c]?c:"_empty"],this.setEdgeStyle(),b=b||{},b.rendering&&this.setRendering(b.rendering)},setEdgeStyle:function(){if(i.env.browser){var a=this.canvas.style;"imageRendering"in a&&(a.imageRendering="",this.isedge&&(a.imageRendering="pixelated",a.imageRendering||(a.imageRendering="-webkit-optimize-contrast"),a.imageRendering||(a.imageRendering="-moz-crisp-edges"),a.imageRendering||(a.imageRendering="-o-crisp-edges")))}},setRendering:function(a){this.isedge=this.isedgearray[this.currentLayerId]="crispEdges"===a,this.setEdgeStyle()},changeSize:function(a,b){if(i.env.browser){var c=this.canvas;c.style.width=a+"px",c.style.height=b+"px"}var d=this.child;if(i.env.browser){var e=parseInt(d.style.left),f=parseInt(d.style.top);a+=0>e?-e:0,b+=0>f?-f:0,d.style.width=a+"px",d.style.height=b+"px"}d.width=a,d.height=b},translate:function(a,b){this.x0=a,this.y0=b,this.context.translate(a,b)},setProperties:function(a,b){a=a&&!!this.fillStyle&&"none"!==this.fillStyle,b=b&&!!this.strokeStyle&&"none"!==this.strokeStyle;var c=this.context;return a&&(c.fillStyle=this.fillStyle),b&&(c.strokeStyle=this.strokeStyle),c.lineWidth=this.lineWidth,c.font=this.font,c.textAlign=this.textAlign,c.textBaseline=this.textBaseline,a||b},beginPath:function(){this.context.beginPath()},closePath:function(){this.context.closePath()},moveTo:function(a,b){this.context.moveTo(a,b)},lineTo:function(a,b){this.context.lineTo(a,b)},rect:function(a,b,c,d){this.context.rect(a,b,c,d)},arc:function(a,b,c,d,e,f){this.context.arc(a,b,c,d,e,f)},fill:function(){this.setProperties(!0,!1)&&this.context.fill()},stroke:function(){this.setProperties(!1,!0)&&this.context.stroke()},shape:function(){if(this.setProperties(!0,!0)){var a=this.context;this.fillStyle&&"none"!==this.fillStyle&&a.fill(),this.strokeStyle&&"none"!==this.strokeStyle&&a.stroke()}},fillRect:function(a,b,c,d){this.setProperties(!0,!1)&&this.context.fillRect(a,b,c,d)},strokeRect:function(a,b,c,d){this.setProperties(!1,!0)&&this.context.strokeRect(a,b,c,d)},shapeRect:function(a,b,c,d){if(this.setProperties(!0,!0)){var e=this.context;this.fillStyle&&"none"!==this.fillStyle&&e.fillRect(a,b,c,d),this.strokeStyle&&"none"!==this.strokeStyle&&e.strokeRect(a,b,c,d)}},setLinePath:function(){for(var a=arguments,b=a.length,c=b-(1|b?1:2),d=[],e=0;c>e;e+=2)d[e>>1]=[a[e],a[e+1]];this.context.beginPath(),this.setLinePath_com.call(this,d),a[b-1]&&this.context.closePath()},setOffsetLinePath:function(){for(var a=arguments,b=a.length,c=b-(1|b?1:2)-2,d=[],e=0;c>e;e+=2)d[e>>1]=[a[e+2]+a[0],a[e+3]+a[1]];this.context.beginPath(),this.setLinePath_com.call(this,d),a[b-1]&&this.context.closePath()},setLinePath_com:function(a){for(var b=0,c=a.length;c>b;b++){var d=a[b];0===b?this.context.moveTo(d[0],d[1]):this.context.lineTo(d[0],d[1])}},strokeLine:function(a,b,c,d){if(this.setProperties(!1,!0)){var e=this.context;e.beginPath(),e.moveTo(a,b),e.lineTo(c,d),e.stroke()}},strokeDashedLine:function(a,b,c,d,e){this.strokeDashedLine=this.context.setLineDash?function(a,b,c,d,e){var f=this.context;this.setProperties(!1,!0)&&(f.beginPath(),f.moveTo(a,b),f.lineTo(c,d),f.setLineDash(e),f.stroke(),f.setLineDash([]))}:function(a,b,c,d,e){e.length%2===1&&(e=e.concat(e));var f=Math.sqrt((c-a)*(c-a)+(d-b)*(d-b)),g=0,h=0,i=null,j=null;if(a!==c&&(i=(d-b)/(c-a),j=i*i+1),this.setProperties(!1,!0)){var k=this.context;for(k.beginPath(),k.moveTo(a,b);f>g;){var l,m;if(null!==i){var n=Math.sqrt(g*g/j);l=a+n,m=b+i*n}else l=a,m=b+g;0===(1&h)?k.moveTo(l,m):k.lineTo(l,m),g+=e[h],h++,h>=e.length&&(h=0)}k.stroke()}},this.strokeDashedLine(a,b,c,d,e)},strokeCross:function(a,b,c){if(this.setProperties(!1,!0)){var d=this.context;d.beginPath(),d.moveTo(a-c,b-c),d.lineTo(a+c,b+c),d.moveTo(a-c,b+c),d.lineTo(a+c,b-c),d.stroke()}},fillCircle:function(a,b,c){if(this.setProperties(!0,!1)){var d=this.context;d.beginPath(),d.arc(a,b,c,0,f,!1),d.fill()}},strokeCircle:function(a,b,c){if(this.setProperties(!1,!0)){var d=this.context;d.beginPath(),d.arc(a,b,c,0,f,!1),d.stroke()}},shapeCircle:function(a,b,c){if(this.setProperties(!0,!0)){var d=this.context;d.beginPath(),d.arc(a,b,c,0,f,!1),this.fillStyle&&"none"!==this.fillStyle&&d.fill(),this.strokeStyle&&"none"!==this.strokeStyle&&d.stroke()}},fillText:function(a,b,d){a&&this.setProperties(!0,!1)&&("candle-top"===this.textBaseline&&(d-=i.getoffsetHeight(a,this.font)*c,this.context.textBaseline="alphabetic"),this.context.fillText(a,b,d))},drawImage:function(){arguments[0]&&this.context.drawImage.apply(this.context,arguments)}})}()}(d,e),a.Candle=d.exports}(),document=this.document||a.Candle.document;var b=this.DOMParser||a.Candle.DOMParser,c=this.XMLSerializer||a.Candle.XMLSerializer;a.env=function(){var b=a.Candle.env.browser,c=b?navigator.userAgent:"",d={Presto:"object"==typeof window&&!!window.opera},e=c.indexOf("Gecko")>-1&&-1===c.indexOf("KHTML"),f=e&&c.match(/rv\:(\d+\.\d+)/)&&+RegExp.$1<8,g=c.indexOf("like Mac OS X")>-1,h=c.indexOf("Android")>-1,i={iOS:g,Android:h,mobile:g||h},j=function(){var a=0;try{window.sessionStorage&&(a|=16)}catch(b){}try{window.localStorage&&(a|=8)}catch(b){}try{window.indexedDB&&(a|=4)}catch(b){}try{if(window.openDatabase){var c=openDatabase("pzprv3_manage","1.0","manager",5242880);c&&(a|=2)}}catch(b){}return f&&!location.hostname&&(a=0),{session:!!(16&a),localST:!!(8&a),WebIDB:!!(4&a),WebSQL:!!(2&a)}}(),k={touchevent:b&&(!!window.ontouchstart||!!document.createTouch),pointerevent:b&&!!navigator.pointerEnabled,mspointerevent:b&&!!navigator.msPointerEnabled,anchor_download:b&&void 0!==document.createElement("a").download};return{bz:d,OS:i,storage:j,API:k,browser:b,node:a.Candle.env.node}}(),a.lang=function(){var b=a.env.node?process.env.LANG:navigator.browserLanguage||navigator.language||navigator.userLanguage;return b&&"ja"!==b.substr(0,2)?"en":"ja"}(),function(){function b(a){if(e){e=!1;for(var b=0;b<f.length;b++)f[b]();f=[]}}function c(a){g&&g.key&&g.key.e_keydown(a)}function d(a){g&&g.key&&g.key.e_keyup(a)}a.on=function(a,b){"load"===a&&(e?f.push(b):b())};var e=!0,f=[];a.env.browser&&("complete"===document.readyState?setTimeout(b,10):(document.addEventListener("DOMContentLoaded",b,!1),window.addEventListener("load",b,!1)));var g=null;a.on("load",function(){a.util.addEvent(document,"keydown",a,c),a.util.addEvent(document,"keyup",a,d)}),a.connectKeyEvents=function(a){g=a}}(),a.common={},a.custom={"":{}},a.classmgr={makeCommon:function(a){this.createCommon(a)},createCommon:function(b){for(var c in b){var d=this.searchName(c),e=a.common[d.real];e||(e=this.createClass(a.common[d.base]),e.prototype.common=e.prototype,e.prototype.pid=""),this.extendPrototype(e.prototype,b[c]),a.common[d.real]=a.custom[""][d.real]=e}},makeCustom:function(b,c){for(var d=0;d<b.length;d++){var e=b[d];a.custom[e]=this.createCustom(e,c)}},getExtension:function(a,b){var c={};for(var d in b){var e=b[d],f=d,g=[],h=!1,f=d.match("#")?d.substr(0,d.indexOf("#")):d;if(f.match("@")){g=f.substr(f.indexOf("@")+1).split(/,/),f=f.substr(0,f.indexOf("@"));for(var i=0;i<g.length;i++)if(g[i]===a){h=!0;break}if(!h)continue}c[f]||(c[f]={});for(var j in e)c[f][j]=e[j]}return c},createCustom:function(b,c){var d={},e=this.getExtension(b,c);for(var f in e){var g=this.searchName(f),h=d[g.real];h||(h=this.createClass(d[g.base]||a.common[g.base]),h.prototype.pid=b),this.extendPrototype(h.prototype,e[f]),d[g.real]=h}for(var i in a.common)d[i]||(d[i]=this.createClass(a.common[i]),d[i].prototype.pid=b);return d},searchName:function(a){a=a.replace(/\s+/g,"");var b=a.indexOf(":"),c="",d=a;return b>=0&&(c=a.substr(b+1),d=a.substr(0,b)),{base:c||d,real:d}},createClass:function(a){function b(){}return a&&this.extendPrototype(b.prototype,a.prototype),b},extendPrototype:function(a,b){b=b||{};for(var c in b)null!==b[c]&&"object"==typeof b[c]&&b[c].constructor===Object?(a[c]||(a[c]={}),this.extendPrototype(a[c],b[c])):a[c]=b[c]},includeCustomFile:function(b){var c=a.variety(b).script;if(!this.includedFile[c]){this.includedFile[c]=!0;var d=a.util.getpath()+"./pzpr-variety/"+c+".js";if(a.env.browser&&!a.env.node){var e=document.createElement("script");e.type="text/javascript",e.src=d+"?"+a.version,document.getElementsByTagName("head")[0].appendChild(e)}else{var f=require(d);this.makeCustom(f[0],f[1])}}},includedFile:{},setPuzzleClass:function(b,c,d){if(!a.variety(c).valid)throw b.emit("fail-open"),"Invalid Puzzle Variety Selected";if(b.pid!==c){if(!a.custom[c]&&(this.includeCustomFile(c),!a.custom[c]))return void setTimeout(function(){a.classmgr.setPuzzleClass(b,c,d)},10);this.setClasses(b,c)}d()},setClasses:function(b,c){b.klass={};var d=a.custom[c];for(var e in d){var f=b.klass[e]=function(){var a=Array.prototype.slice.apply(arguments);this.initialize&&this.initialize.apply(this,a)},g=d[e].prototype;for(var h in g)f.prototype[h]=g[h]}this.setPrototypeRef(b,"puzzle",b),this.setPrototypeRef(b,"klass",b.klass),b.pid=c,b.info=a.variety(c)},setPrototypeRef:function(a,b,c){for(var d in a.klass)a.klass[d].prototype[b]=c}},function(){function b(a){if(c[a])return a;for(var b in c)if(c[b].alias)for(var d in c[b].alias)if(c[b].alias[d]===a)return b;return""}var c={},d=[],e=a.variety=function(a){return c[b(a)]||{valid:!1}};e.extend=function(a){for(var b in a)this[b]=a[b]},e.extend({info:c,toPID:b,exists:function(a){return e(a).valid},each:function(a){for(var b in c)a(b)},getList:function(){return d.slice()}}),delete e.extend,function(a,b){for(var d in b){c[d]=new a(d,b[d]);try{Object.freeze(c[d]),Object.freeze(c[d].exists),Object.freeze(c[d].alias)}catch(e){}}}(function(a,b){this.valid=!0,this.pid=a,this.script=b[4]?b[4]:a,this.ja=b[2],this.en=b[3],this.exists={pzprapp:!!b[0],kanpen:!!b[1],pencilbox:!!b[1]},this.exists.pencilbox=this.exists.pencilbox&&"nanro"!==a&&"ayeheya"!==a&&"kurochute"!==a,this.alias=b[5]?b[5]:{},this.urlid=this.alias.pzprurl||a,this.kanpenid=b[1]?this.alias.kanpen||a:"",d.push(a)},{aho:[0,0,"アホになり切れ","Aho-ni-Narikire","shikaku"],amibo:[0,0,"あみぼー","Amibo","amibo"],ayeheya:[0,1,"∀人∃ＨＥＹＡ","ekawayeh","heyawake"],bag:[1,0,"バッグ","BAG (Corral)","",{alias:"correl"}],barns:[1,0,"バーンズ","Barns"],bdblock:[1,0,"ボーダーブロック","Border Block"],bonsan:[1,0,"ぼんさん","Bonsan","bonsan"],bosanowa:[1,0,"ボサノワ","Bosanowa"],box:[0,0,"ボックス","Box"],cbblock:[0,0,"コンビブロック","Combi Block"],chocona:[0,0,"チョコナ","Chocona","shimaguni"],cojun:[0,0,"コージュン","Cojun","ripple"],country:[1,0,"カントリーロード","Country Road"],creek:[1,0,"クリーク","Creek"],dosufuwa:[0,0,"ドッスンフワリ","Dosun-Fuwari"],factors:[0,0,"因子の部屋","Rooms of Factors"],fillmat:[1,0,"フィルマット","Fillmat","fillmat"],fillomino:[0,1,"フィルオミノ","Fillomino","",{kanpen2:"fillomino01"}],firefly:[1,0,"ホタルビーム","Hotaru Beam (Glow of Fireflies)"],fivecells:[0,0,"ファイブセルズ","FiveCells","nawabari"],fourcells:[0,0,"フォーセルズ","FourCells","nawabari"],goishi:[0,1,"碁石ひろい","Goishi"],gokigen:[1,0,"ごきげんななめ","Gokigen-naname","gokigen"],hakoiri:[1,0,"はこいり○△□","Hokoiri-masashi"],hanare:[0,0,"はなれ組","Hanare-gumi","hanare"],hashikake:[0,1,"橋をかけろ","Hashiwokakero (Bridges)","",{pzprurl:"hashi",kanpen:"hashi",alias:"bridges"}],herugolf:[0,0,"ヘルゴルフ","Herugolf"],heyawake:[0,1,"へやわけ","Heyawake","heyawake"],heyabon:[1,1,"へやぼん","Heya-Bon","bonsan",{kanpen:"satogaeri"}],hitori:[0,1,"ひとりにしてくれ","Hitori"],icebarn:[1,0,"アイスバーン","Icebarn","icebarn"],icelom:[0,0,"アイスローム","Icelom","icebarn"],icelom2:[0,0,"アイスローム２","Icelom2","icebarn"],ichimaga:[0,0,"イチマガ","Ichimaga","ichimaga"],ichimagam:[0,0,"磁石イチマガ","Magnetic Ichimaga","ichimaga"],ichimagax:[0,0,"一回曲がって交差もするの","Crossing Ichimaga","ichimaga"],juosan:[0,0,"縦横さん","Juosan"],kazunori:[0,0,"かずのりのへや","Kazunori Room"],kaero:[1,0,"お家に帰ろう","Return Home"],kakuro:[0,1,"カックロ","Kakuro"],kakuru:[0,0,"カックル","Kakuru"],kinkonkan:[1,0,"キンコンカン","Kin-Kon-Kan"],kouchoku:[0,0,"交差は直角に限る","Kouchoku"],kramma:[0,0,"快刀乱麻","KaitoRamma","kramma"],kramman:[0,0,"新・快刀乱麻","New KaitoRamma","kramma"],kurochute:[0,1,"クロシュート","Kurochute"],kurodoko:[0,1,"黒どこ(黒マスはどこだ)","Kurodoko"],kurotto:[0,0,"クロット","Kurotto"],kusabi:[0,0,"クサビリンク","Kusabi"],lightup:[0,1,"美術館","Akari (Light Up)","",{pzprurl:"akari",kanpen:"bijutsukan"}],lits:[1,1,"ＬＩＴＳ","LITS","lits"],lookair:[0,0,"るっくえあ","Look-Air"],loopsp:[1,0,"環状線スペシャル","Loop Special"],loute:[0,0,"エルート","L-route"],makaro:[0,0,"マカロ","Makaro"],mashu:[0,1,"ましゅ","Masyu (Pearl Puzzle)","",{kanpen:"masyu",alias:"pearl"}],mejilink:[0,0,"メジリンク","Mejilink"],minarism:[1,0,"マイナリズム","Minarism"],mochikoro:[1,0,"モチコロ","Mochikoro","nurikabe"],mochinyoro:[1,0,"モチにょろ","Mochinyoro","nurikabe"],nagare:[0,0,"流れるループ","Nagareru-Loop"],nagenawa:[0,0,"なげなわ","Nagenawa","nagenawa"],nanro:[0,1,"ナンロー","Nanro"],nawabari:[1,0,"なわばり","Territory","nawabari"],norinori:[0,1,"のりのり","Norinori","lits"],numlin:[0,1,"ナンバーリンク","Numberlink","",{kanpen:"numberlink"}],nuribou:[1,0,"ぬりぼう","Nuribou","nurikabe"],nurikabe:[0,1,"ぬりかべ","Nurikabe","nurikabe"],nurimaze:[0,0,"ぬりめいず","Nuri-Maze","nurimaze"],paintarea:[1,0,"ペイントエリア","Paintarea"],pipelink:[1,0,"パイプリンク","Pipelink","pipelink"],pipelinkr:[1,0,"帰ってきたパイプリンク","Pipelink Returns","pipelink"],
rectslider:[0,0,"四角スライダー","Rectangle-Slider","bonsan"],reflect:[1,0,"リフレクトリンク","Reflect Link"],renban:[0,0,"連番窓口","Renban-Madoguchi"],ringring:[0,0,"リングリング","Ring-ring","nagenawa"],ripple:[0,1,"波及効果","Ripple Effect","ripple",{kanpen:"hakyukoka"}],roma:[0,0,"ろーま","Roma"],sashigane:[0,0,"さしがね","Sashigane","loute"],shakashaka:[0,1,"シャカシャカ","ShakaShaka"],shikaku:[0,1,"四角に切れ","Shikaku (Devide by Box)","shikaku"],shimaguni:[1,0,"島国","Islands","shimaguni"],shugaku:[1,0,"修学旅行の夜","School Trip"],shwolf:[0,0,"ヤギとオオカミ","Sheeps and Wolves","kramma"],slalom:[1,1,"スラローム","Slalom"],slither:[0,1,"スリザーリンク","Slitherlink","",{kanpen:"slitherlink"}],snakes:[1,0,"へびいちご","Hebi-Ichigo"],sudoku:[0,1,"数独","Sudoku"],sukoro:[1,0,"数コロ","Sukoro","sukoro"],sukororoom:[0,0,"数コロ部屋","Sukoro-room","sukoro"],tapa:[0,0,"Tapa","Tapa"],tasquare:[0,0,"たすくえあ","Tasquare"],tatamibari:[1,0,"タタミバリ","Tatamibari"],tateyoko:[1,0,"タテボーヨコボー","Tatebo-Yokobo"],tawa:[0,0,"たわむれんが","Tawamurenga"],tentaisho:[0,1,"天体ショー","Tentaisho"],tilepaint:[1,0,"タイルペイント","Tilepaint"],toichika:[0,0,"遠い誓い","Toichika"],triplace:[0,0,"トリプレイス","Tri-place"],usotatami:[0,0,"ウソタタミ","Uso-tatami","fillmat"],view:[1,0,"ヴィウ","View","sukoro"],wagiri:[0,0,"ごきげんななめ・輪切","Gokigen-naname:wagiri","gokigen"],wblink:[0,0,"シロクロリンク","Shirokuro-link"],yajikazu:[1,0,"やじさんかずさん","Yajisan-Kazusan"],yajirin:[0,1,"ヤジリン","Yajilin","",{pzprurl:"yajilin",kanpen:"yajilin"}],yajitatami:[0,0,"ヤジタタミ","Yajitatami"],yosenabe:[0,0,"よせなべ","Yosenabe"]})}(),function(){var d=0,e=1,f=2,g=3,h=4,i=5,j=0,k=1,l=2,m=3;a.parser={URL_AUTO:d,URL_PZPRV3:e,URL_PZPRAPP:f,URL_KANPEN:g,URL_KANPENP:h,URL_HEYAAPP:i,FILE_AUTO:j,FILE_PZPR:k,FILE_PBOX:l,FILE_PBOX_XML:m,parse:function(a,b){return a instanceof this.URLData||a instanceof this.FileData?a:this.parseFile(a,b)||this.parseURL(a)},parseURL:function(b){return b instanceof this.URLData?b:(b=b.replace(/(\r|\n)/g,""),new a.parser.URLData(b).parse())},parseFile:function(b,c){return b instanceof this.FileData?b:(b.match(/^\<\?xml/)||(b=b.replace(/[\t\r]*\n/g,"\n").replace(/\//g,"\n")),new a.parser.FileData(b,c).parse())}},a.parser.URLData=function(a){this.url=a},a.parser.URLData.prototype={pid:"",type:d,url:"",qdata:"",pflag:null,cols:0,rows:0,body:"",isurl:!0,URL_AUTO:d,URL_PZPRV3:e,URL_PZPRAPP:f,URL_KANPEN:g,URL_KANPENP:h,URL_HEYAAPP:i,parse:function(){return this.parseURLType(),this.parseURLData(),this.changeProperPid(),this},generate:function(){return this.outputURLType()+this.outputURLData()},parseURLType:function(){var b=this.url;if(delete this.url,b.match(/www\.kanpen\.net/)||b.match(/www\.geocities(\.co)?\.jp\/pencil_applet/))b.match(/([0-9a-z]+)\.html/),this.pid=RegExp.$1,b.indexOf("?heyawake=")>=0?(this.qdata=b.substr(b.indexOf("?heyawake=")+10),this.type=i):b.indexOf("?pzpr=")>=0?(this.qdata=b.substr(b.indexOf("?pzpr=")+6),this.type=h):(this.qdata=b.substr(b.indexOf("?problem=")+9),this.type=g);else if(b.match(/www\.geocities(\.co)?\.jp\/heyawake/))this.pid="heyawake",this.qdata=b.substr(b.indexOf("?problem=")+9),this.type=i;else if(b.match(/indi\.s58\.xrea\.com\/(.+)\/(sa|sc)\//))this.pid=RegExp.$1,this.qdata=b.substr(b.indexOf("?")),this.type=f;else{var c=b.indexOf("/",b.indexOf("?"));c>-1?(this.pid=b.substring(b.indexOf("?")+1,c),this.qdata=b.substr(c+1)):this.pid=b.substr(b.indexOf("?")+1),this.type=e}this.pid=a.variety.toPID(this.pid)},outputURLType:function(){var b=a.env.node?"":document.domain,c="",d=this.pid;switch(b?b+=location.pathname:b="pzv.jp/p.html",this.type){case e:c="http://"+b+"?%PID%/";break;case g:c="http://www.kanpen.net/%KID%.html?problem=";break;case h:c="http://www.kanpen.net/%KID%.html?pzpr=";break;case i:c="http://www.geocities.co.jp/heyawake/?problem="}return c.replace("%PID%",a.variety(d).urlid).replace("%KID%",a.variety(d).kanpenid)},parseURLData:function(){var a=this.qdata.split("/"),b=0,c=0;if(delete this.qdata,this.type!==g&&this.type!==i&&(a[0]&&!isNaN(a[0])&&a.unshift(""),this.pflag=a.shift()),this.type===g)"kakuro"===this.pid?(c=+a.shift()-1,b=+a.shift()-1):"sudoku"===this.pid?c=b=+a.shift():(c=+a.shift(),b=+a.shift());else if(this.type===i){var d=a.shift().split("x");b=+d[0],c=+d[1]}else b=+a.shift()||NaN,c=+a.shift()||NaN;this.rows=c,this.cols=b,this.body=a.join("/")},outputURLData:function(){var a=this,b=a.cols,c=a.rows,d=[];return a.type!==g&&a.type!==i&&(a.type===h||a.pflag)&&d.push(a.pflag),a.type===g?"kakuro"===a.pid?(d.push(c+1),d.push(b+1)):"sudoku"===a.pid?d.push(b):(d.push(c),d.push(b)):a.type===i?d.push([b,c].join("x")):(d.push(b),d.push(c)),d.push(a.body),d.join("/")},changeProperPid:function(){if(this.body&&(this.type===e||this.type===f))switch(this.pid){case"ichimaga":this.pflag.indexOf("m")>=0?this.pid="ichimagam":this.pflag.indexOf("x")>=0?this.pid="ichimagax":this.pid="ichimaga";break;case"icelom":this.pflag.indexOf("a")<0&&(this.pid="icelom2");break;case"pipelink":this.body.match(/[0-9]/)&&(this.pid="pipelinkr");break;case"bonsan":if(this.pflag.indexOf("c")<0){var a=this.cols,b=this.rows;this.body.substr(0,(((a-1)*b+4)/5|0)+((a*(b-1)+4)/5|0)||0).match(/[^0]/)&&(this.pid="heyabon")}break;case"kramma":if(this.pflag.indexOf("c")<0)for(var c=(this.cols-1)*(this.rows-1),d=0,g=0;g<this.body.length;g++){var h=this.body.charAt(g);if(h.match(/\w/)){if(d+=parseInt(h,36),c>d){this.pid="kramman";break}}else"."===h&&(d+=36);if(d>=c)break}}}},a.parser.FileData=function(b,c){this.pid=c?c:"",this.fstr=b,this.metadata=new a.MetaData},a.parser.FileData.prototype={pid:"",type:j,filever:0,fstr:"",qdata:"",cols:0,rows:0,body:"",history:"",metadata:null,xmldoc:null,isfile:!0,FILE_AUTO:j,FILE_PZPR:k,FILE_PBOX:l,FILE_PBOX_XML:m,parse:function(){var a=this.parseFileType()&&this.parseFileData();return a&&this.changeProperPid(),a?this:null},generate:function(){return this.outputFileType()+this.outputFileData()},parseFileType:function(){var c=this.fstr.split("\n"),d=c.shift();return delete this.fstr,d.match(/^pzprv3/)?(this.type=k,d.match(/pzprv3\.(\d+)/)&&(this.filever=+RegExp.$1),this.pid=c.shift(),this.qdata=c.join("\n")):d.match(/^\<\?xml/)?(this.type=m,c.unshift(d),this.qdata=c.join("\n"),b?(this.body=(new b).parseFromString(this.qdata,"text/xml"),this.pid=this.body.querySelector("puzzle").getAttribute("type")):this.pid=""):d.match(/^\d+$/)?(this.type=l,c.unshift(d),this.qdata=c.join("\n")):this.pid="",this.pid=a.variety.toPID(this.pid),!!this.pid},outputFileType:function(){return this.type===k?[0===this.filever?"pzprv3":"pzprv3."+this.filever,this.pid,""].join("\n"):(this.type===m&&this.body.querySelector("puzzle").setAttribute("type",a.variety(this.pid).kanpenid),"")},parseFileData:function(){var a=this.qdata.split("\n"),b=0,c=0;if(delete this.qdata,this.type===m?(c=+this.body.querySelector("size").getAttribute("row"),b=+this.body.querySelector("size").getAttribute("col"),("slither"===this.pid||"kakuro"===this.pid)&&(c--,b--)):this.type===l&&"kakuro"===this.pid?(c=+a.shift()-1,b=+a.shift()-1):"sudoku"===this.pid?c=b=+a.shift():(c=+a.shift(),b=+a.shift()),0>=c||0>=b)return!1;if(this.rows=c,this.cols=b,this.type===k){for(var d=null,e="",f=[],g=!1,h=0;h<a.length&&!a[h].match(/^http\:\/\//);h++){if(a[h].match(/info:\{/)){d=h,g=!0;break}if(a[h].match(/history:\{|__HISTORY__/)){d=h;break}f.push(a[h])}if(this.body+=f.join("\n"),null!==d&&JSON)for(var i,j=0,h=d;h<a.length&&(e+=a[h],i=j,j+=(a[h].match(/\{/g)||[]).length,j-=(a[h].match(/\}/g)||[]).length,!(i>0&&0===j));h++);if(JSON)if(g&&"info:"===e.substr(0,5)){var n=JSON.parse(e.substr(5));this.metadata.update(n.metadata),this.history=n.history||""}else"history:"===e.substr(0,8)&&(this.history=JSON.parse(e.substr(8)))}else if(this.type===l)this.body=a.join("\n");else if(this.type===m&&this.body){var o=this.body.querySelector("property"),p=this.metadata;p.author=o.querySelector("author").getAttribute("value"),p.source=o.querySelector("source").getAttribute("value"),p.hard=o.querySelector("difficulty").getAttribute("value");var q=o.querySelector("comment");p.comment=q?q.childNodes[0].data:""}return!0},outputFileData:function(){var a=this,b=a.cols,d=a.rows,e=[],f=this.type===m?this.body.querySelector("puzzle"):null;if(a.type===m){var g=f.querySelector("size");g&&f.removeChild(g),("slither"===a.pid||"kakuro"===a.pid)&&(d++,b++),f.appendChild(this.createXMLNode("size",{row:d,col:b}))}else a.type===l&&"kakuro"===a.pid?(e.push(d+1),e.push(b+1)):"sudoku"===a.pid?e.push(b):(e.push(d),e.push(b));if(a.type!==m&&e.push(a.body),a.type===k&&JSON)if(a.metadata.empty())a.history&&e.push("history:"+JSON.stringify(a.history,null,1));else{var h={metadata:a.metadata.getvaliddata()};a.history&&(h.history=a.history),e.push("info:"+JSON.stringify(h,null,1))}else if(a.type===m){var i=f.querySelector("property");i&&f.removeChild(i),i=this.createXMLNode("property");var j=a.metadata;if(i.appendChild(this.createXMLNode("author",{value:j.author})),i.appendChild(this.createXMLNode("source",{value:j.source})),i.appendChild(this.createXMLNode("difficulty",{value:j.hard})),j.comment){var n=this.createXMLNode("comment");n.appendChild(this.body.createTextNode(j.comment)),i.appendChild(n)}f.appendChild(i),f.appendChild(f.querySelector("board")),f.appendChild(f.querySelector("answer"))}var o;return a.type!==m?o=e.join("\n"):(o=(new c).serializeToString(this.body),o.match(/^\<\?xml/)||(o='<?xml version="1.0" encoding="UTF-8"?>\n'+o)),o},createXMLNode:function(a,b){var c=this.body.createElement(a);if(b)for(var d in b)c.setAttribute(d,b[d]);return c},changeProperPid:function(){if(this.type===k)switch(this.pid){case"ichimaga":var a=this.body.split("\n")[0];"mag"===a?this.pid="ichimagam":"cross"===a&&(this.pid="ichimagax");break;case"icelom":var b=this.body.split("\n")[2];"skipwhite"===b&&(this.pid="icelom2");break;case"pipelink":var c=this.body.split("\n"),d=1,e=this.rows;c.slice(d,d+e).join("").match(/o/)&&(this.pid="pipelinkr");break;case"bonsan":var c=this.body.split("\n"),d=2*this.rows,e=2*this.rows-1;c.slice(d,d+e).join("").match(/1/)&&(this.pid="heyabon");break;case"kramma":var c=this.body.split("\n"),d=this.rows,e=this.rows+1;c.slice(d,d+e).join("").match(/1/)&&(this.pid="kramman")}}}}(),a.MetaData=function(){},a.MetaData.prototype={author:"",source:"",hard:"",comment:"",items:{author:"",source:"",hard:"",comment:""},update:function(a){if(a)for(var b in this.items)"string"==typeof a[b]&&(this[b]=a[b])},getvaliddata:function(){var a={};for(var b in this.items)this[b]&&(a[b]=this[b]);return a},reset:function(){for(var a in this.items)this[a]=""},empty:function(){for(var a in this.items)if(this[a])return!1;return!0}},function(){var b=a.env.API,c="mousedown",d="mousemove",e="mouseup";b.pointerevent?(c="pointerdown",d="pointermove",e="pointerup"):b.mspointerevent?(c="MSPointerDown",d="MSPointerMove",e="MSPointerUp"):b.touchevent&&(c="touchstart",d="touchmove",e="touchend"),a.util={getpath:function(){if(!a.env.browser)return require("path").dirname(__filename)+"/"+(__filename.match("pzpr.js")?"":"../");for(var b=document.getElementsByTagName("script"),c=0;c<b.length;c++){var d=b[c].src.match(/^(.*\/)pzpr\.js(?:\?.*)?$/);if(d)return d[1]+(d[1].match(/\/$/)?"":"/")}return""},currentTime:function(){return(new Date).getTime()},unselectable:function(a){return a.style.MozUserSelect="none",a.style.KhtmlUserSelect="none",a.style.webkitUserSelect="none",a.style.msUserSelect="none",a.style.userSelect="none",a.unselectable="on",this},addEvent:function(a,b,f,g,h){function i(a){g.call(f,a)}return"mousedown"===b?b=c:"mousemove"===b?b=d:"mouseup"===b&&(b=e),a.addEventListener(b,i,!!h),i},getMouseButton:function(a){return void 0!==a.touches?a.touches.length>=1?1===a.touches.length?"left":"right":"":["left","middle","right"][void 0!==a.button?a.button:a.which-1]||""},getPagePos:function(a){return{px:this.pageX(a),py:this.pageY(a)}},pageX:function(a){if(void 0!==a.touches&&a.touches.length>0){var b=a.touches.length,c=0;if(b>0){for(var d=0;b>d;d++)c+=a.touches[d].pageX;return c/b}}return a.pageX||0},pageY:function(a){if(void 0!==a.touches&&a.touches.length>0){var b=a.touches.length,c=0;if(b>0){for(var d=0;b>d;d++)c+=a.touches[d].pageY;return c/b}}return a.pageY||0},getRect:function(b){if(!a.env.browser)return{top:0,bottom:0,left:0,right:0,height:0,width:0};var c,d,e=b.getBoundingClientRect();if(void 0!==window.scrollX)c=window.scrollX,d=window.scrollY;else{var f=document.documentElement;c=f.scrollLeft,d=f.scrollTop}var g=e.left+c,h=e.top+d,i=e.right+c,j=e.bottom+d;return{top:h,bottom:j,left:g,right:i,height:j-h,width:i-g}},checkpid:function(a,b){var c=a.match(/!?[a-z0-9]+/g),d=!0;if(c){d=!1;for(var e=0;e<c.length;e++)"!"!==c[e].charAt(0)?c[e]===b&&(d=!0):d=c[e].substr(1)!==b}return d}}}(),function(){function b(b,d,e,g){"string"==typeof e||g||(g=e,e=void 0),b.ready=!1;var h=b.klass,i=h&&h.Board?h.Board:null,j=a.parser.parse(d,e||b.pid);a.classmgr.setPuzzleClass(b,j.pid,function(){i!==b.klass.Board?c(b):b.painter.suspendAll();try{b.metadata.reset(),j.isurl?(new b.klass.Encode).decodeURL(j):j.isfile&&(new b.klass.FileIO).filedecode(j),b.ready=!0,b.emit("ready"),b.canvas&&f(b),b.resetTime(),g&&g(b)}catch(a){throw b.emit("fail-open"),a}})}function c(b){var c=b.klass;b.board=new c.Board,a.classmgr.setPrototypeRef(b,"board",b.board),b.checker=new c.AnsCheck,b.painter=new c.Graphic,b.cursor=new c.TargetCursor,b.mouse=new c.MouseEvent,b.key=new c.KeyEvent,b.opemgr=new c.OperationManager,b.faillist=new c.FailCode}function d(b,c){"canvas"===c&&a.Candle.enable.canvas&&!CanvasRenderingContext2D.prototype.fillText&&(c="svg"),a.Candle.start(b.canvas,c,function(d){if(a.util.unselectable(d.canvas),d.child.style.pointerEvents="none",d.use.canvas&&!b.subcanvas){var g=b.subcanvas=e("canvas");document.body&&(g.id="_"+(new Date).getTime()+c,g.style.position="absolute",g.style.left="-10000px",g.style.top="0px",document.body.appendChild(g))}b.ready&&f(b)})}function e(b){if(!a.Candle.enable[b])return null;var c=document.createElement("div");return a.Candle.start(c,b),c}function f(a){var b=a.painter,c=a.opt;a.preInitCanvas&&("viewer"!==c.type&&g(a),b.canvasWidth&&b.canvasHeight||(c.width&&c.height?b.resizeCanvas(c.width,c.height):c.cellsize&&b.resizeCanvasByCellSize(c.cellsize)),delete a.preInitCanvas),b.initCanvas()}function g(b){function c(c,d){a.util.addEvent(b.canvas,c,b,d)}c("mousedown",h),c("mousemove",i),c("mouseup",j),b.canvas.oncontextmenu=function(){return!1},c("keydown",k),c("keyup",l)}function h(a){this.mouse&&this.mouse.e_mousedown(a)}function i(a){this.mouse&&this.mouse.e_mousemove(a)}function j(a){this.mouse&&this.mouse.e_mouseup(a)}function k(a){this.key&&this.key.e_keydown(a)}function l(a){this.key&&this.key.e_keyup(a)}function m(a,b){var c=e(b.type),d=new a.klass.Graphic;return d.context=c.getContext("2d"),d.outputImage=!0,"bgcolor"in b&&(d.bgcolor=b.bgcolor),"kramma"===a.pid&&(d.imgtile=a.painter.imgtile),d.resizeCanvasByCellSize(b.cellsize),d.unsuspend(),c}function n(){for(var b={},c=a.Candle.current,d=null,e=null,f=null,g=0;g<arguments.length;g++){var h=arguments[g];switch(typeof h){case"string":c=h;break;case"number":h>1.01?d=h:f=h;break;case"object":"cellsize"in h&&(d=h.cellsize),"bgcolor"in h&&(e=h.bgcolor)}}return b.type=(c||a.Candle.current).match(/svg/)?"svg":"canvas",b.mimetype="svg"!==b.type?"image/"+c:"image/svg+xml",null!==f&&void 0!==f&&(b.quality=f),null!==d&&(b.cellsize=d),null!==e&&(b.bgcolor=e),b}a.Puzzle=function(b,d){this.pzpr=a,void 0!==d||b&&b.parentNode||(d=b,b=void 0),this.opt=d||{};var e={player:1,viewer:2}[this.opt.type||0]||0;this.playeronly=!!e,this.editmode=!this.playeronly,this.playmode=!this.editmode,this.resetTime(),this.preInitCanvas=!0,this.listeners={},this.metadata=new a.MetaData,this.config=new this.Config(this),void 0!==this.opt.config&&this.config.setAll(this.opt.config),void 0!==this.opt.mode&&this.setMode(this.opt.mode),b&&this.setCanvas(b),a.classmgr.setClasses(this,""),c(this)},a.Puzzle.prototype={pid:null,info:{},klass:null,ready:!1,editmode:!1,playmode:!1,playeronly:!1,starttime:0,canvas:null,subcanvas:null,listeners:null,config:null,metadata:null,MODE_EDITOR:1,MODE_PLAYER:3,open:function(a,c,d){return b(this,a,c,d),this},on:function(a,b){this.addListener(a,b,!1)},once:function(a,b){this.addListener(a,b,!0)},addListener:function(a,b,c){this.listeners[a]||(this.listeners[a]=[]),this.listeners[a].push({func:b,once:!!c})},emit:function(){var a=Array.prototype.slice.apply(arguments),b=a.shift(),c=this.listeners[b];if(c){a.unshift(this);for(var d=0;d<c.length;d++){var e=c[d];c[d].once&&(c.splice(d,1),d--),e.func.apply(window,a)}}},setCanvas:function(b,c){if(b){var e=a.util.getRect(b),f=document.createElement("div");f.style.width=e.width+"px",f.style.height=e.height+"px",b.appendChild(f),this.canvas=f,d(this,c||this.opt.graphic||"")}},setCanvasSize:function(a,b){this.painter?this.painter.resizeCanvas(a,b):(this.opt.width=a,this.opt.height=b)},setCanvasSizeByCellSize:function(a){this.painter?this.painter.resizeCanvasByCellSize(a):this.opt.cellsize=a},redraw:function(a){a?this.painter.resizeCanvas():this.painter.paintAll()},irowake:function(){this.board.irowakeRemake(),this.execConfig("irowake")&&this.redraw()},toDataURL:function(a,b,c){var d=n(a,b,c),e=m(this,d),f=e.toDataURL(d.mimetype,d.quality);return e.parentNode&&e.parentNode.removeChild(e),f},toBlob:function(a,b,c,d){var e=n(b,c,d),f=m(this,e);f.toBlob(function(b){a(b),f.parentNode&&f.parentNode.removeChild(f)},e.mimetype,e.quality)},toBuffer:function(a,b,c){var d=n(a,b,c),e=m(this,d),f=e.toBuffer(d.mimetype,d.quality);return e.parentNode&&e.parentNode.removeChild(e),f},getURL:function(a){return(new this.klass.Encode).encodeURL(a)},getFileData:function(a,b){return(new this.klass.FileIO).fileencode(a,b)},clone:function(b){b=b||{};var c={type:b.type||this.opt.type||"",width:b.width||this.painter.canvasWidth,height:b.height||this.painter.canvasHeight},d=new a.Puzzle(c).open(this.getFileData(1,{history:!!b.history}));return d.restoreConfig(this.saveConfig()),d},resetTime:function(){this.starttime=a.util.currentTime()},getTime:function(){return a.util.currentTime()-this.starttime},undo:function(){return this.opemgr.undo()},redo:function(){return this.opemgr.redo()},undoall:function(){for(;this.opemgr.undo(););},redoall:function(){for(;this.opemgr.redo(););},ismodified:function(){return this.opemgr.isModified()},check:function(a){return a&&(this.key.keyreset(),this.mouse.mousereset()),this.checker.check(a)},ansclear:function(){this.board.ansclear(),this.board.rebuildInfo(),this.redraw()},subclear:function(){this.board.subclear(),this.redraw()},errclear:function(){this.board.errclear()},clear:function(){this.playeronly?(this.ansclear(),this.opemgr.allerase()):(this.board.initBoardSize(),this.redraw())},setMode:function(a){this.playeronly||("string"!=typeof a||(a={edit:1,play:3}[a.substr(0,4)],void 0!==a))&&(this.editmode=a===this.MODE_EDITOR,this.playmode=!this.editmode,this.klass&&(this.cursor.adjust_modechange(),this.key.keyreset(),this.mouse.mousereset(),this.board.haserror?this.board.errclear():this.redraw()),this.emit("config","mode",a))},getConfig:function(a){return this.config.get(a)},setConfig:function(a,b){return this.config.set(a,b)},resetConfig:function(a){return this.config.reset(a)},validConfig:function(a){return this.config.getexec(a)},execConfig:function(a){return this.config.get(a)&&this.config.getexec(a)},getCurrentConfig:function(){return this.config.getList()},saveConfig:function(){return this.config.getAll()},restoreConfig:function(a){this.config.setAll(a)}}}(),function(){var b=a.Puzzle.prototype.Config=function(a){this.puzzle=a,this.init()};b.prototype={list:null,init:function(){this.list={},this.add("font",1,[1,2]),this.add("cursor",!0),this.add("irowake",!1),this.add("irowakeblk",!1),this.add("dispmove",!0),this.add("disptype_yajilin",1,[1,2]),this.add("disptype_pipelinkr",1,[1,2]),this.add("disptype_bosanowa",1,[1,2,3]),this.add("snakebd",!1),this.add("squarecell",!0),this.add("color_qanscolor",""),this.add("color_bgcolor","white"),this.add("use",a.env.API.touchevent?2:1,[1,2]),this.add("use_tri",1,[1,2,3]),this.add("bgcolor",!1),this.add("dirauxmark",!0),this.add("enline",!0),this.add("lattice",!0),this.add("lrcheck",!1),this.add("redline",!1),this.add("redblk",!1),this.add("redroad",!1),this.list.lrcheck["volatile"]=!0,this.list.redline["volatile"]=!0,this.list.redblk["volatile"]=!0,this.list.redroad["volatile"]=!0,this.add("autocmp",!1),this.add("autoerr",!1),this.add("multierr",!1),this.add("allowempty",!1),this.add("bdpadding",!0),this.add("discolor",!1),this.add("uramashu",!1),this.list.uramashu["volatile"]=!0},add:function(a,b,c){var d={val:b,defval:b,"volatile":!1};c&&(d.option=c),this.list[a]=d},get:function(a){return this.list[a]?this.list[a].val:null},set:function(a,b){this.list[a]&&(b=this.setproper(a,b),this.configevent(a,b),this.puzzle.emit("config",a,b))},reset:function(a){this.list[a]&&this.set(a,this.list[a].defval)},getList:function(){var a={};for(var b in this.list)this.getexec(b)&&(a[b]=this.get(b));return a},getAll:function(){var a={};for(var b in this.list){var c=this.list[b];c.val===c.defval||c["volatile"]||(a[b]=c.val)}return a},setAll:function(a){this.init();for(var b in a)this.set(b,a[b])},setproper:function(a,b){var c=this.list[a];switch(typeof c.defval){case"boolean":c.val=!!b;break;case"number":c.val=+b;break;case"string":c.val=""+b}return c.val},getexec:function(a){var b=this.puzzle,c=b.pid,d=!b.playeronly,e=!1;switch(a){case"use":e=b.mouse.use;break;case"use_tri":e="shakashaka"===c;break;case"dispmove":e=b.board.linegraph.moveline;break;case"disptype_pipelinkr":e="pipelinkr"===c;break;case"disptype_bosanowa":e="bosanowa"===c;break;case"disptype_yajilin":e="yajirin"===c;break;case"bgcolor":e=b.mouse.bgcolor;break;case"irowake":e=b.painter.irowake;break;case"irowakeblk":e=b.painter.irowakeblk;break;case"snakebd":e="snakes"===c;break;case"redline":e=b.mouse.redline;break;case"redblk":e=b.mouse.redblk;break;case"redroad":e="roma"===c;break;case"autocmp":e=""!==b.painter.autocmp;break;case"autoerr":e="hitori"===c||"gokigen"===c||"wagiri"===c;break;case"dirauxmark":e="nagare"===c;break;case"enline":case"lattice":e="kouchoku"===c;break;case"bdpadding":e=d&&"goishi"===c;break;case"discolor":e=d&&"tentaisho"===c;break;case"uramashu":e="mashu"===c;break;default:e=!!this.list[a]}return e},configevent:function(a,b){var c=this.puzzle;if(c.klass&&this.getexec(a))switch(a){case"irowake":case"cursor":case"autocmp":case"autoerr":case"snakebd":case"dispmove":case"disptype_pipelinkr":case"disptype_yajilin":c.redraw();break;case"font":c.painter.initFont(),c.redraw();break;case"multierr":c.checker.resetCache();break;case"disptype_bosanowa":c.setCanvasSizeByCellSize();break;case"color_qanscolor":c.painter.setColor("qanscolor",b);break;case"color_bgcolor":c.painter.setColor("bgcolor",b);break;case"uramashu":c.board.revCircleConfig(b),c.redraw()}}}}(),a.classmgr.makeCommon({Position:{bx:null,by:null,NDIR:0,UP:1,DN:2,LT:3,RT:4,equals:function(a){return this.bx===a.bx&&this.by===a.by},getaddr:function(){return new this.klass.Address(this.bx,this.by)},relcell:function(a,b){return this.board.getc(this.bx+a,this.by+b)},relcross:function(a,b){return this.board.getx(this.bx+a,this.by+b)},relbd:function(a,b){return this.board.getb(this.bx+a,this.by+b)},relexcell:function(a,b){return this.board.getex(this.bx+a,this.by+b)},relobj:function(a,b){return this.board.getobj(this.bx+a,this.by+b)},reldirbd:function(a,b){return this.getaddr().movedir(a,b).getb()},draw:function(){this.puzzle.painter.paintRange(this.bx-1,this.by-1,this.bx+1,this.by+1)},drawaround:function(){this.puzzle.painter.paintRange(this.bx-3,this.by-3,this.bx+3,this.by+3)},isinside:function(){var a=this.board;return this.bx>=a.minbx&&this.bx<=a.maxbx&&this.by>=a.minby&&this.by<=a.maxby},getdir:function(a,b){var c=a.bx-this.bx,d=a.by-this.by;return 0===c&&d===-b?this.UP:0===c&&d===b?this.DN:c===-b&&0===d?this.LT:c===b&&0===d?this.RT:this.NDIR},getvert:function(a,b){var c=this.getdir(a,b);return c===this.UP||c===this.DN?!0:c===this.LT||c===this.RT?!1:void 0},getnb:function(a){return a.bx-this.bx===0&&a.by-this.by===-2?this.relbd(0,-1):a.bx-this.bx===0&&a.by-this.by===2?this.relbd(0,1):a.bx-this.bx===-2&&a.by-this.by===0?this.relbd(-1,0):a.bx-this.bx===2&&a.by-this.by===0?this.relbd(1,0):this.board.emptyborder},getborderobj:function(a){return 0===(1&a.bx)&&this.bx===a.bx&&1===Math.abs(this.by-a.by)||0===(1&a.by)&&this.by===a.by&&1===Math.abs(this.bx-a.bx)?(this.onborder()?this:a).getb():this.board.nullobj}},"Address:Position":{initialize:function(a,b){arguments.length>=2&&this.init(a,b)},reset:function(){this.bx=null,this.by=null},clone:function(){return new this.constructor(this.bx,this.by)},set:function(a){return this.bx=a.bx,this.by=a.by,this},init:function(a,b){return this.bx=a,this.by=b,this},move:function(a,b){return this.bx+=a,this.by+=b,this},oncell:function(){return!!(1&this.bx&&1&this.by)},oncross:function(){return!(1&this.bx||1&this.by)},onborder:function(){return!!(this.bx+this.by&1)},getc:function(){return this.board.getc(this.bx,this.by)},getx:function(){return this.board.getx(this.bx,this.by)},getb:function(){return this.board.getb(this.bx,this.by)},getex:function(){return this.board.getex(this.bx,this.by)},getobj:function(){return this.board.getobj(this.bx,this.by)},movedir:function(a,b){switch(a){case this.UP:this.by-=b;break;case this.DN:this.by+=b;break;case this.LT:this.bx-=b;break;case this.RT:this.bx+=b}return this}},"RawAddress:Address":{}}),a.classmgr.makeCommon({"BoardPiece:Position":{group:"none",id:null,isnull:!0,ques:0,qdir:0,qnum:-1,qnum2:-1,qchar:0,qans:0,anum:-1,line:0,qsub:0,qcmp:0,error:0,qinfo:0,propques:["ques","qdir","qnum","qnum2","qchar"],propans:["qans","anum","line"],propsub:["qsub","qcmp"],propinfo:["error","qinfo"],propnorec:{color:1,error:1,qinfo:1},maxnum:255,minnum:1,initAdjacent:function(){this.adjacent={top:this.relobj(0,-2),bottom:this.relobj(0,2),left:this.relobj(-2,0),right:this.relobj(2,0)}},initAdjBorder:function(){this.adjborder={top:this.relbd(0,-1),bottom:this.relbd(0,1),left:this.relbd(-1,0),right:this.relbd(1,0)}},setQues:function(a){this.setdata("ques",a)},setQans:function(a){this.setdata("qans",a)},setQdir:function(a){this.setdata("qdir",a)},setQnum:function(a){this.setdata("qnum",a)},setQnum2:function(a){this.setdata("qnum2",a)},setQchar:function(a){this.setdata("qchar",a)},setAnum:function(a){this.setdata("anum",a)},setLineVal:function(a){this.setdata("line",a)},setQsub:function(a){this.setdata("qsub",a)},setQcmp:function(a){this.setdata("qcmp",a)},setdata:function(a,b){this[a]!==b&&(this.prehook[a]&&this.prehook[a].call(this,b)||(this.addOpe(a,this[a],b),this[a]=b,this.posthook[a]&&this.posthook[a].call(this,b)))},addOpe:function(a,b,c){b!==c&&this.puzzle.opemgr.add(new this.klass.ObjectOperation(this,a,b,c))},getmaxnum:function(){return"function"==typeof this.maxnum?this.maxnum():this.maxnum},getminnum:function(){return"function"==typeof this.minnum?this.minnum():this.minnum},prehook:{},posthook:{},seterr:function(a){this.board.isenableSetError()&&(this.error=a)},setinfo:function(a){this.qinfo=a}},"Cell:BoardPiece":{group:"cell",lcnt:0,base:null,disInputHatena:!1,numberWithMB:!1,numberAsObject:!1,numberRemainsUnshaded:!1,adjacent:{},adjborder:{},prehook:{ques:function(a){return this.klass.Border.prototype.enableLineCombined&&this.setCombinedLine(a),!1},qnum:function(a){return this.getminnum()>0&&0===a},qnum2:function(a){return this.getminnum()>0&&0===a},anum:function(a){return this.getminnum()>0&&0===a}},posthook:{ques:function(a){this.board.setInfoByCell(this)},qnum:function(a){this.board.setInfoByCell(this)},qnum2:function(a){this.board.setInfoByCell(this)},anum:function(a){this.board.setInfoByCell(this)},qans:function(a){this.board.setInfoByCell(this)},qsub:function(a){this.numberWithMB&&this.board.setInfoByCell(this)}},isShade:function(){return!this.isnull&&1===this.qans},isUnshade:function(){return!this.isnull&&1!==this.qans},setShade:function(){this.setQans(1)},clrShade:function(){this.setQans(0)},getNum:function(){return-1!==this.qnum?this.qnum:this.anum},setNum:function(a){if(!(this.getminnum()>0&&0===a))if(this.puzzle.editmode)a=!this.numberAsObject&&-2!==a||this.qnum!==a?a:-1,this.setQnum(a),this.setAnum(-1),this.numberRemainsUnshaded&&this.setQans(0),"white"===this.puzzle.painter.bcolor&&this.setQsub(0);else if(-1===this.qnum){var b=a>-1&&(!this.numberAsObject||this.anum!==a)?a:-1,c=-1>a&&(!this.numberAsObject||this.qsub!==-a-1)?-a-1:0;this.setAnum(b),this.setQsub(c),this.setQdir(0)}},isNum:function(){return!this.isnull&&(-1!==this.qnum||-1!==this.anum)},noNum:function(){return!this.isnull&&-1===this.qnum&&-1===this.anum},isValidNum:function(){return!this.isnull&&(this.qnum>=0||this.anum>=0&&-1===this.qnum)},isNumberObj:function(){return-1!==this.qnum||-1!==this.anum||this.numberWithMB&&1===this.qsub},sameNumber:function(a){return this.isValidNum()&&this.getNum()===a.getNum()},is51cell:function(){return 51===this.ques},set51cell:function(a){this.setQues(51),this.setQnum(0),this.setQnum2(0),this.setAnum(-1)},remove51cell:function(a){this.setQues(0),this.setQnum(0),this.setQnum2(0),this.setAnum(-1)},ice:function(){return 6===this.ques},isEmpty:function(){return this.isnull||7===this.ques},isValid:function(){return!this.isnull&&7!==this.ques},isDeparture:function(){return!this.isnull&&!!this.base&&this.base.isnull&&this.isNum()},isDestination:function(){return!this.isnull&&!!this.base&&!this.base.isnull},isLineStraight:function(){return 2===this.lcnt&&this.adjborder.top.isLine()&&this.adjborder.bottom.isLine()?1:2===this.lcnt&&this.adjborder.left.isLine()&&this.adjborder.right.isLine()?2:0},isLineCurve:function(){return 2===this.lcnt&&!this.isLineStraight()},setCombinedLine:function(){if(this.klass.Border.prototype.enableLineCombined)for(var a=this.bx,b=this.by,c=this.board.borderinside(a-1,b-1,a+1,b+1),d=0;d<c.length;d++){var e=c[d];0===e.line&&e.isLineEX()&&e.setLineVal(1)}},isLPobj:{1:{11:1,12:1,14:1,15:1},2:{11:1,12:1,16:1,17:1},3:{11:1,13:1,15:1,16:1},4:{11:1,13:1,14:1,17:1}},noLPobj:{1:{1:1,4:1,5:1,13:1,16:1,17:1,21:1},2:{1:1,2:1,3:1,13:1,14:1,15:1,21:1},3:{1:1,2:1,5:1,12:1,14:1,17:1,22:1},4:{1:1,3:1,4:1,12:1,15:1,16:1,22:1}},isLP:function(a){return!!this.isLPobj[a][this.ques]},noLP:function(a){return!!this.noLPobj[a][this.ques]},countDir4Cell:function(a){for(var b=this.adjacent,c=0,d=[b.top,b.bottom,b.left,b.right],e=0;4>e;e++)"cell"===d[e].group&&!d[e].isnull&&a(d[e])&&c++;return c},getdir4clist:function(){for(var a=this.adjacent,b=[],c=[a.top,a.bottom,a.left,a.right],d=0;4>d;d++)"cell"!==c[d].group||c[d].isnull||b.push([c[d],d+1]);return b},getdir4cblist:function(){for(var a=this.adjacent,b=this.adjborder,c=[],d=[a.top,a.bottom,a.left,a.right],e=[b.top,b.bottom,b.left,b.right],f=0;4>f;f++)("cell"===d[f].group&&!d[f].isnull||!e[f].isnull)&&c.push([d[f],e[f],f+1]);return c},eraseMovedLines:function(){if(null!==this.path){for(var a=this.path.clist,b=0,c=0,d=a.length;d>c;c++)for(var e=c+1;d>e;e++){var f=a[c].getnb(a[e]);f.isnull||(f.removeLine(),b++)}b>0&&a.draw()}}},"Cross:BoardPiece":{group:"cross",lcnt:0,adjborder:{},setCrossBorderError:function(){this.seterr(1),this.board.borderinside(this.bx-1,this.by-1,this.bx+1,this.by+1).seterr(1)}},"Border:BoardPiece":{initialize:function(){this.sidecell=[null,null],this.sidecross=[null,null],this.sideobj=[]},group:"border",isvert:!1,inside:!1,path:null,enableLineNG:!1,enableLineCombined:!1,initSideObject:function(){var a=2===this.board.hasborder&&2===this.board.hasexcell;this.isvert?(this.sidecell[0]=!a||this.bx>0?this.relcell(-1,0):this.relexcell(-1,0),this.sidecell[1]=!a||this.bx<2*this.board.cols?this.relcell(1,0):this.relexcell(1,0),this.sidecross[0]=this.relcross(0,-1),this.sidecross[1]=this.relcross(0,1)):(this.sidecell[0]=!a||this.by>0?this.relcell(0,-1):this.relexcell(0,-1),this.sidecell[1]=!a||this.by<2*this.board.rows?this.relcell(0,1):this.relexcell(0,1),this.sidecross[0]=this.relcross(-1,0),this.sidecross[1]=this.relcross(1,0)),this.sideobj=this.board.borderAsLine?this.sidecross:this.sidecell},prehook:{qans:function(a){return 0!==this.ques},line:function(a){
return this.checkStableLine(a)}},posthook:{ques:function(a){this.board.setInfoByBorder(this)},qans:function(a){this.board.setInfoByBorder(this)},line:function(a){this.board.setInfoByLine(this)}},draw:function(){this.puzzle.painter.paintRange(this.bx-2,this.by-2,this.bx+2,this.by+2)},isLine:function(){return this.line>0},setLine:function(a){this.setLineVal(1),this.setQsub(0)},setPeke:function(a){this.setLineVal(0),this.setQsub(2)},removeLine:function(a){this.setLineVal(0),this.setQsub(0)},isBorder:function(){return this.ques>0||this.qans>0},setBorder:function(){this.puzzle.editmode?(this.setQues(1),this.setQans(0)):1!==this.ques&&this.setQans(1)},removeBorder:function(){this.puzzle.editmode?(this.setQues(0),this.setQans(0)):1!==this.ques&&this.setQans(0)},isVert:function(){return this.isvert},isHorz:function(){return!this.isvert},checkStableLine:function(a){return this.enableLineNG?this.enableLineCombined?0!==a&&this.isLineNG()||0===a&&this.isLineEX():0!==a&&this.isLineNG():!1},isLineEX:function(){var a=this.sidecell[0],b=this.sidecell[1];return this.isVert()?a.isLP(a.RT)&&b.isLP(b.LT):a.isLP(a.DN)&&b.isLP(b.UP)},isLineNG:function(){var a=this.sidecell[0],b=this.sidecell[1];return this.isVert()?a.noLP(a.RT)||b.noLP(b.LT):a.noLP(a.DN)||b.noLP(b.UP)}},"EXCell:BoardPiece":{group:"excell",adjacent:{},is51cell:function(){return 51===this.ques},ice:function(){return!1}}}),a.classmgr.makeCommon({PieceList:{initialize:function(a){a&&this.extend(a)},length:0,add:Array.prototype.push,extend:function(a){var b=a.length,c=this.length;this.length+=b;for(var d=0;b>d;d++)this[c+d]=a[d]},unshift:Array.prototype.unshift,pop:Array.prototype.pop,reverse:Array.prototype.reverse,each:Array.prototype.forEach,some:Array.prototype.some,include:function(a){return this.some(function(b){return b===a})},filter:function(a){for(var b=new this.constructor,c=this.length,d=0,e=0;c>e;e++)a(this[e])&&(b[d]=this[e],d++);return b.length=d,b},notnull:function(a){return this.filter(function(a){return!a.isnull})},map:function(a){for(var b=new this.constructor,c=b.length=this.length,d=0;c>d;d++)b[d]=a(this[d]);return b},indexOf:Array.prototype.indexOf,remove:function(a){var b=this.indexOf(a);b>=0&&Array.prototype.splice.call(this,b,1)},seterr:function(a){if(this.board.isenableSetError())for(var b=0;b<this.length;b++)this[b].error=a},setnoerr:function(){if(this.board.isenableSetError())for(var a=0;a<this.length;a++)0===this[a].error&&(this[a].error=-1)},setinfo:function(a){for(var b=0;b<this.length;b++)this[b].qinfo=a},allclear:function(a){this.propclear(this.getprop("all"),a)},ansclear:function(){this.propclear(this.getprop("ans"),!0)},subclear:function(){this.propclear(this.getprop("sub"),!0)},errclear:function(){this.propclear(this.getprop("err"),!1)},propclear:function(a,b){for(var c=this.length>0?this[0].propnorec:{},d=0;d<this.length;d++)for(var e=this[d],f=0;f<a.length;f++){var g=a[f],h=e.constructor.prototype[g];e[g]!==h&&(b&&!c[g]&&e.addOpe(g,e[g],h),e[g]=h)}},getprop:function(a){var b=[];if(this.length>0){var c={all:3,ans:2,sub:1,err:0}[a];c>=3&&(b=b.concat(this[0].propques)),c>=2&&(b=b.concat(this[0].propans)),c>=1&&(b=b.concat(this[0].propsub)),c>=0&&(b=b.concat(this[0].propinfo))}return b}},"CellList:PieceList":{getRectSize:function(){for(var a=this.board,b={x1:a.maxbx+1,x2:a.minbx-1,y1:a.maxby+1,y2:a.minby-1,cols:0,rows:0,cnt:0},c=0;c<this.length;c++){var d=this[c];b.x1>d.bx&&(b.x1=d.bx),b.x2<d.bx&&(b.x2=d.bx),b.y1>d.by&&(b.y1=d.by),b.y2<d.by&&(b.y2=d.by),b.cnt++}return b.cols=(b.x2-b.x1+2)/2,b.rows=(b.y2-b.y1+2)/2,b},getQnumCell:function(){for(var a=0,b=this.length;b>a;a++)if(this[a].isNum())return this[a];return this.board.emptycell},getTopCell:function(){for(var a=this.board,b=null,c=a.maxbx,d=a.maxby,e=0;e<this.length;e++){var f=this[e];f.bx>c||f.bx===c&&f.by>=d||(b=this[e],c=f.bx,d=f.by)}return b},eraseLines:function(){for(var a=0,b=0,c=this.length;c>b;b++)for(var d=b+1;c>d;d++){var e=this.puzzle.mouse.getnb(this[b].getaddr(),this[d].getaddr());e.isnull||(e.removeLine(),a++)}a>0&&this.draw()},draw:function(){var a=this.getRectSize();this.puzzle.painter.paintRange(a.x1-1,a.y1-1,a.x2+1,a.y2+1)}},"CrossList:PieceList":{},"BorderList:PieceList":{cellinside:function(){for(var a=new this.klass.CellList,b=[],c=0;c<this.length;c++){var d=this[c],e=d.sidecell[0],f=d.sidecell[1];e.isnull||b[e.id]===!0||(a.add(e),b[e.id]=!0),f.isnull||b[f.id]===!0||(a.add(f),b[f.id]=!0)}return a},crossinside:function(){for(var a=new this.klass.CrossList,b=[],c=0;c<this.length;c++){var d=this[c],e=d.sidecross[0],f=d.sidecross[1];e.isnull||b[e.id]===!0||(a.add(e),b[e.id]=!0),f.isnull||b[f.id]===!0||(a.add(f),b[f.id]=!0)}return a}},"EXCellList:PieceList":{}}),a.classmgr.makeCommon({Board:{initialize:function(){var a=this.klass;this.minbx=0,this.minby=0,this.maxbx=0,this.maxby=0,this.diserror=0,this.haserror=!1,this.cell=new a.CellList,this.cross=new a.CrossList,this.border=new a.BorderList,this.excell=new a.EXCellList,this.nullobj=new a.BoardPiece,this.emptycell=new a.Cell,this.emptycross=new a.Cross,this.emptyborder=new a.Border,this.emptyexcell=new a.EXCell;try{Object.freeze(this.nullobj),Object.freeze(this.emptycell),Object.freeze(this.emptycross),Object.freeze(this.emptyborder),Object.freeze(this.emptyexcell)}catch(b){}this.createExtraObject(),this.disrecinfo=0,this.infolist={cell:[],border:[],line:[],all:[]},this.linegraph=this.addInfoList(a.LineGraph),this.roommgr=this.addInfoList(a.AreaRoomGraph),this.sblkmgr=this.addInfoList(a.AreaShadeGraph),this.ublkmgr=this.addInfoList(a.AreaUnshadeGraph),this.nblkmgr=this.addInfoList(a.AreaNumberGraph),this.addExtraInfo(),this.exec=new a.BoardExec,this.exec.insex.cross=1===this.hascross?{2:!0}:{0:!0}},addInfoList:function(a){var b=new a;if(b.enabled){for(var c=0;c<b.relation.length;c++)this.infolist[b.relation[c]].push(b);this.infolist.all.push(b)}return b},addExtraInfo:function(){},cols:10,rows:10,hascross:2,hasborder:0,hasexcell:0,borderAsLine:!1,disable_subclear:!1,initBoardSize:function(a,b){(void 0===a||isNaN(a))&&(a=this.cols,b=this.rows),this.allclear(!1),this.initGroup("cell",a,b),this.initGroup("cross",a,b),this.initGroup("border",a,b),this.initGroup("excell",a,b),this.cols=a,this.rows=b,this.setminmax(),this.setposAll(),this.initExtraObject(a,b),this.rebuildInfo(),this.puzzle.cursor.initCursor(),this.puzzle.opemgr.allerase()},createExtraObject:function(){},initExtraObject:function(a,b){},initGroup:function(a,b,c){var d=this.getGroup(a),e=this.estimateSize(a,b,c),f=d.length;if(f>e)for(var g=f-1;g>=e;g--)d.pop();else if(e>f){for(var h=new d.constructor,g=f;e>g;g++){var i=this.newObject(a,g);d.add(i),h.add(i)}h.allclear(!1)}return d.length=e,e-f},getGroup:function(a){return"cell"===a?this.cell:"cross"===a?this.cross:"border"===a?this.border:"excell"===a?this.excell:new this.klass.PieceList},estimateSize:function(a,b,c){if("cell"===a)return b*c;if("cross"===a)return(b+1)*(c+1);if("border"===a){if(1===this.hasborder)return 2*b*c-(b+c);if(2===this.hasborder)return 2*b*c+(b+c)}else if("excell"===a){if(1===this.hasexcell)return b+c+1;if(2===this.hasexcell)return 2*b+2*c+4}return 0},newObject:function(a,b){var c=this.nullobj,d=this.klass;return"cell"===a?c=new d.Cell:"cross"===a?c=new d.Cross:"border"===a?c=new d.Border:"excell"===a&&(c=new d.EXCell),c!==this.nullobj&&void 0!==b&&(c.id=b),c},setposAll:function(){this.setposCells(),this.setposCrosses(),this.setposBorders(),this.setposEXcells()},setposGroup:function(a){"cell"===a?this.setposCells():"cross"===a?this.setposCrosses():"border"===a?this.setposBorders():"excell"===a&&this.setposEXcells()},setposCells:function(){for(var a=this.cols,b=0;b<this.cell.length;b++){var c=this.cell[b];c.id=b,c.isnull=!1,c.bx=b%a*2+1,c.by=(b/a<<1)+1,c.initAdjacent(),c.initAdjBorder()}},setposCrosses:function(){for(var a=this.cols,b=0;b<this.cross.length;b++){var c=this.cross[b];c.id=b,c.isnull=!1,c.bx=b%(a+1)*2,c.by=b/(a+1)<<1,c.initAdjBorder()}},setposBorders:function(){for(var a=this.cols,b=this.rows,c=2*a*b-a-b,d=0;d<this.border.length;d++){var e=this.border[d],f=d;e.id=d,e.isnull=!1,f>=0&&(a-1)*b>f&&(e.bx=f%(a-1)*2+2,e.by=(f/(a-1)<<1)+1),f-=(a-1)*b,f>=0&&a*(b-1)>f&&(e.bx=f%a*2+1,e.by=(f/a<<1)+2),f-=a*(b-1),2===this.hasborder&&(f>=0&&a>f&&(e.bx=2*f+1,e.by=0),f-=a,f>=0&&a>f&&(e.bx=2*f+1,e.by=2*b),f-=a,f>=0&&b>f&&(e.bx=0,e.by=2*f+1),f-=b,f>=0&&b>f&&(e.bx=2*a,e.by=2*f+1),f-=b),e.isvert=!(1&e.bx),e.inside=c>d,e.initSideObject()}},setposEXcells:function(){for(var a=this.cols,b=this.rows,c=0;c<this.excell.length;c++){var d=this.excell[c],e=c;d.id=c,d.isnull=!1,1===this.hasexcell?(e>=0&&a>e&&(d.bx=2*e+1,d.by=-1),e-=a,e>=0&&b>e&&(d.bx=-1,d.by=2*e+1),e-=b,0===e&&(d.bx=-1,d.by=-1),e--):2===this.hasexcell&&(e>=0&&a>e&&(d.bx=2*e+1,d.by=-1),e-=a,e>=0&&a>e&&(d.bx=2*e+1,d.by=2*b+1),e-=a,e>=0&&b>e&&(d.bx=-1,d.by=2*e+1),e-=b,e>=0&&b>e&&(d.bx=2*a+1,d.by=2*e+1),e-=b,0===e&&(d.bx=-1,d.by=-1),e--,0===e&&(d.bx=2*a+1,d.by=-1),e--,0===e&&(d.bx=-1,d.by=2*b+1),e--,0===e&&(d.bx=2*a+1,d.by=2*b+1),e--),d.initAdjacent()}},setminmax:function(){var a=this.hasexcell>0,b=2===this.hasexcell;this.minbx=a?-2:0,this.minby=a?-2:0,this.maxbx=b?2*this.cols+2:2*this.cols,this.maxby=b?2*this.rows+2:2*this.rows,this.puzzle.cursor.setminmax()},allclear:function(a){this.cell.allclear(a),this.cross.allclear(a),this.border.allclear(a),this.excell.allclear(a)},ansclear:function(){this.puzzle.opemgr.newOperation(),this.cell.ansclear(),this.cross.ansclear(),this.border.ansclear(),this.excell.ansclear(),this.rebuildInfo()},subclear:function(){this.puzzle.opemgr.newOperation(),this.cell.subclear(),this.cross.subclear(),this.border.subclear(),this.excell.subclear()},errclear:function(){this.haserror&&(this.cell.errclear(),this.cross.errclear(),this.border.errclear(),this.excell.errclear(),this.haserror=!1,this.puzzle.redraw(!0))},getObjectPos:function(a,b,c){var d=this.nullobj;return"cell"===a?d=this.getc(b,c):"cross"===a?d=this.getx(b,c):"border"===a?d=this.getb(b,c):"excell"===a&&(d=this.getex(b,c)),d},getc:function(a,b){var c=null,d=this.cols,e=this.rows;return!(0>a||a>d<<1||0>b||b>e<<1)&&1&a&&1&b&&(c=(a>>1)+(b>>1)*d),null!==c?this.cell[c]:this.emptycell},getx:function(a,b){var c=null,d=this.cols,e=this.rows;return 0>a||a>d<<1||0>b||b>e<<1||1&a||1&b||(c=(a>>1)+(b>>1)*(d+1)),0!==this.hascross&&null!==c?this.cross[c]:this.emptycross},getb:function(a,b){var c=null,d=this.cols,e=this.rows;return this.hasborder&&a>=1&&2*d-1>=a&&b>=1&&2*e-1>=b?!(1&a)&&1&b?c=(a>>1)-1+(b>>1)*(d-1):1&a&&!(1&b)&&(c=(a>>1)+((b>>1)-1)*d+(d-1)*e):2===this.hasborder&&(0===b&&1&a&&a>=1&&2*d-1>=a?c=(d-1)*e+d*(e-1)+(a>>1):b===2*e&&1&a&&a>=1&&2*d-1>=a?c=(d-1)*e+d*(e-1)+d+(a>>1):0===a&&1&b&&b>=1&&2*e-1>=b?c=(d-1)*e+d*(e-1)+2*d+(b>>1):a===2*d&&1&b&&b>=1&&2*e-1>=b&&(c=(d-1)*e+d*(e-1)+2*d+e+(b>>1))),null!==c?this.border[c]:this.emptyborder},getex:function(a,b){var c=null,d=this.cols,e=this.rows;return 1===this.hasexcell?-1===a&&-1===b?c=d+e:-1===b&&a>0&&2*d>a?c=a>>1:-1===a&&b>0&&2*e>b&&(c=d+(b>>1)):2===this.hasexcell&&(-1===b&&a>0&&2*d>a?c=a>>1:b===2*e+1&&a>0&&2*d>a?c=d+(a>>1):-1===a&&b>0&&2*e>b?c=2*d+(b>>1):a===2*d+1&&b>0&&2*e>b?c=2*d+e+(b>>1):-1===a&&-1===b?c=2*d+2*e:a===2*d+1&&-1===b?c=2*d+2*e+1:-1===a&&b===2*e+1?c=2*d+2*e+2:a===2*d+1&&b===2*e+1&&(c=2*d+2*e+3)),null!==c?this.excell[c]:this.emptyexcell},getobj:function(a,b){if(a+b&1)return this.getb(a,b);if(!(1&a||1&b))return this.getx(a,b);var c=this.getc(a,b);return c===this.emptycell&&this.hasexcell?this.getex(a,b):c},operate:function(a){this.exec.execadjust(a)},objectinside:function(a,b,c,d,e){return"cell"===a?this.cellinside(b,c,d,e):"cross"===a?this.crossinside(b,c,d,e):"border"===a?this.borderinside(b,c,d,e):"excell"===a?this.excellinside(b,c,d,e):new this.klass.PieceList},cellinside:function(a,b,c,d){for(var e=new this.klass.CellList,f=1|b;d>=f;f+=2)for(var g=1|a;c>=g;g+=2){var h=this.getc(g,f);h.isnull||e.add(h)}return e},crossinside:function(a,b,c,d){var e=new this.klass.CrossList;if(this.hascross)for(var f=b+(1&b);d>=f;f+=2)for(var g=a+(1&a);c>=g;g+=2){var h=this.getx(g,f);h.isnull||e.add(h)}return e},borderinside:function(a,b,c,d){var e=new this.klass.BorderList;if(this.hasborder)for(var f=b;d>=f;f++)for(var g=a+(a+f&1^1);c>=g;g+=2){var h=this.getb(g,f);h.isnull||e.add(h)}return e},excellinside:function(a,b,c,d){var e=new this.klass.EXCellList;if(this.hasexcell)for(var f=1|b;d>=f;f+=2)for(var g=1|a;c>=g;g+=2){var h=this.getex(g,f);h.isnull||e.add(h)}return e},disableInfo:function(){this.puzzle.opemgr.disableRecord(),this.disrecinfo++},enableInfo:function(){this.puzzle.opemgr.enableRecord(),this.disrecinfo>0&&this.disrecinfo--},isenableInfo:function(){return 0===this.disrecinfo},rebuildInfo:function(){this.infolist.all.forEach(function(a){a.rebuild()})},setInfoByCell:function(a){this.isenableInfo()&&this.infolist.cell.forEach(function(b){b.setCell(a)})},setInfoByBorder:function(a){this.isenableInfo()&&this.infolist.border.forEach(function(b){b.setBorder(a)})},setInfoByLine:function(a){this.isenableInfo()&&this.infolist.line.forEach(function(b){b.setLine(a)})},irowakeRemake:function(){this.linegraph.newIrowake()},disableSetError:function(){this.diserror++},enableSetError:function(){this.diserror--},isenableSetError:function(){return this.diserror<=0}}}),function(){var b=1,c=2,d=3,e=4,f=16,g=32,h=64,i=128;a.classmgr.makeCommon({BoardExec:{UP:b,DN:c,LT:d,RT:e,EXPAND:f,REDUCE:g,TURN:h,FLIP:i,TURNFLIP:h|i,EXPANDUP:f|b,EXPANDDN:f|c,EXPANDLT:f|d,EXPANDRT:f|e,REDUCEUP:g|b,REDUCEDN:g|c,REDUCELT:g|d,REDUCERT:g|e,TURNL:1|h,TURNR:2|h,FLIPX:1|i,FLIPY:2|i,boardtype:{expandup:[g|b,f|b],expanddn:[g|c,f|c],expandlt:[g|d,f|d],expandrt:[g|e,f|e],reduceup:[f|b,g|b],reducedn:[f|c,g|c],reducelt:[f|d,g|d],reducert:[f|e,g|e],turnl:[2|h,1|h],turnr:[1|h,2|h],flipy:[2|i,2|i],flipx:[1|i,1|i]},qnumw:[],qnumh:[],insex:{cell:{1:!0},cross:{},border:{1:!0,2:!0},excell:{1:!0}},execadjust:function(a){var b=this.puzzle,c=this.board;if(0===a.indexOf("reduce"))if("reduceup"===a||"reducedn"===a){if(c.rows<=1)return}else if(("reducelt"===a||"reducert"===a)&&c.cols<=1)return;b.opemgr.newOperation(),b.painter.suspendAll();var d={x1:0,y1:0,x2:2*c.cols,y2:2*c.rows};this.execadjust_main(this.boardtype[a][1],d),this.addOpe(d,a),c.setminmax(),c.rebuildInfo(),b.painter.resizeCanvas(),b.emit("adjust"),b.painter.unsuspend()},execadjust_main:function(a,b){var c=this.board;if(this.adjustBoardData(a,b),c.roommgr.hastop&&a&g&&this.reduceRoomNumber(a,b),a&h){var d=c.cols;c.cols=c.rows,c.rows=d,b={x1:0,y1:0,x2:2*c.cols,y2:2*c.rows}}else a&f&&(a===this.EXPANDUP||a===this.EXPANDDN?c.rows++:(a===this.EXPANDLT||a===this.EXPANDRT)&&c.cols++);["cell","cross","border","excell"].forEach(function(d){a&f?c.exec.expandGroup(d,a):a&g?c.exec.reduceGroup(d,a):c.exec.turnflipGroup(d,a,b)}),a&g&&(a===this.REDUCEUP||a===this.REDUCEDN?c.rows--:(a===this.REDUCELT||a===this.REDUCERT)&&c.cols--),c.setposAll(),this.adjustBoardData2(a,b)},addOpe:function(a,b){var c,d=this.boardtype[b][1],e=this.puzzle;c=d&this.TURNFLIP?new e.klass.BoardFlipOperation(a,b):new e.klass.BoardAdjustOperation(b),e.opemgr.add(c)},expandGroup:function(a,b){var c=this.board,d=c.initGroup(a,c.cols,c.rows),e=c.getGroup(a),f=new e.constructor;c.setposGroup(a);for(var g=e.length-1;g>=0;g--){var h=e[g];this.isdel(b,h)?(h=c.newObject(a,g),e[g]=h,f.add(h),d--):d>0&&(e[g]=e[g-d])}f.allclear(!1),"border"===a&&this.expandborder(b)},reduceGroup:function(a,b){var c=this.board;"border"===a&&this.reduceborder(b);for(var d=0,e=c.getGroup(a),f=new e.constructor,g=0;g<e.length;g++){var h=e[g];this.isdel(b,h)?(h.id=g,f.add(h),d++):d>0&&(e[g-d]=e[g])}var i=this.puzzle.opemgr;i.undoExec||i.redoExec||(i.forceRecord=!0,f.allclear(!0),i.forceRecord=!1);for(var g=0;d>g;g++)e.pop()},isdel:function(a,b){return!!this.insex[b.group][this.distObj(a,b)]},turnflipGroup:function(a,b,c){var d=this.board;if("excell"===a)if(1===d.hasexcell&&b&this.FLIP){var e={x1:c.x1,y1:c.y1,x2:c.x2,y2:c.y2};b===this.FLIPY?e.x1=e.x2=-1:b===this.FLIPX&&(e.y1=e.y2=-1),c=e}else 2===d.hasexcell&&(c={x1:-1,y1:-1,x2:c.x2+1,y2:c.y2+1});for(var f=d.objectinside(a,c.x1,c.y1,c.x2,c.y2),g={},h=c.x1+c.x2,i=c.y1+c.y2,j=0;j<f.length;j++){var k=f[j],l=null;switch(b){case this.FLIPY:l=d.getObjectPos(a,k.bx,i-k.by).id;break;case this.FLIPX:l=d.getObjectPos(a,h-k.bx,k.by).id;break;case this.TURNL:l=d.getObjectPos(a,k.by,i-k.bx).id;break;case this.TURNR:l=d.getObjectPos(a,h-k.by,k.bx).id}g[l]=k}var m=d.getGroup(a);for(var n in g)m[+n]=g[n]},distObj:function(a,b){var c=this.board;return b.isnull?-1:(a&=15,a===this.UP?b.by:a===this.DN?2*c.rows-b.by:a===this.LT?b.bx:a===this.RT?2*c.cols-b.bx:-1)},expandborder:function(a){var b=this.board,c=b.borderAsLine;if(c||!b.puzzle.opemgr.undoExec){var d=new this.klass.BorderList;b.setposBorders();for(var e=c?2:1,f=0;f<b.border.length;f++){var g=b.border[f];if(this.distObj(a,g)===e){var h=c?this.outerBorder(f,a):this.innerBorder(f,a);this.copyBorder(g,h),d.add(h)}}c&&d.allclear(!1)}},reduceborder:function(a){var b=this.board;if(b.borderAsLine)for(var c=0;c<b.border.length;c++){var d=b.border[c];if(0===this.distObj(a,d)){var e=this.innerBorder(c,a);this.copyBorder(d,e)}}},copyBorder:function(a,b){a.ques=b.ques,a.qans=b.qans,this.board.borderAsLine&&(a.line=b.line,a.qsub=b.qsub)},innerBorder:function(a,b){var c=this.board.border[a];return b&=15,b===this.UP?c.relbd(0,2):b===this.DN?c.relbd(0,-2):b===this.LT?c.relbd(2,0):b===this.RT?c.relbd(-2,0):null},outerBorder:function(a,b){var c=this.board.border[a];return b&=15,b===this.UP?c.relbd(0,-2):b===this.DN?c.relbd(0,2):b===this.LT?c.relbd(-2,0):b===this.RT?c.relbd(2,0):null},reduceRoomNumber:function(a,b){for(var c=[],d=this.board,e=0;e<d.cell.length;e++){var f=d.cell[e];this.insex.cell[this.distObj(a,f)]&&(-1!==f.qnum&&(c.push({cell:f,area:f.room,pos:[f.bx,f.by],val:f.qnum}),f.qnum=-1),f.room.clist.remove(f))}for(var g=0;g<c.length;g++){var h=c[g],i=h.area,j=i.clist.getTopCell();if(j.isnull){var k=this.puzzle.opemgr;k.undoExec||k.redoExec||(k.forceRecord=!0,h.cell.addOpe("qnum",h.val,-1),k.forceRecord=!1)}else j.qnum=h.val}},adjustBoardData:function(a,b){},adjustBoardData2:function(a,b){}}})}(),a.classmgr.makeCommon({GraphBase:{enabled:!1,relation:[],pointgroup:"",linkgroup:"",removeFromArray:function(a,b){var c=a.indexOf(b);c>=0&&Array.prototype.splice.call(a,c,1)},setComponentRefs:function(a,b){},getObjNodeList:function(a){return[]},resetObjNodeList:function(a){},isnodevalid:function(a){return!1},isedgevalidbylinkobj:function(a){return!0},isedgevalidbynodeobj:function(a,b){return!0},isedgeexistsbylinkobj:function(a){var b=this.getSideNodesBySeparator(a);return b[0]&&b[1]?b[0].nodes.indexOf(b[1])>=0:!1},calcNodeCount:function(a){return this.isnodevalid(a)?1:0},rebuildmode:!1,rebuild:function(){this.enabled&&(this.rebuildmode=!0,this.components=[],this.modifyNodes=[],this.rebuild2(),this.searchGraph(),this.rebuildmode=!1)},rebuild2:function(){for(var a=this.board[this.pointgroup],b=this.board[this.linkgroup],c=0;c<a.length;c++)this.setComponentRefs(a[c],null),this.resetObjNodeList(a[c]),this.isnodevalid(a[c])&&this.createNode(a[c]);if(this.linkgroup)for(var d=0;d<b.length;d++)this.setComponentRefs(b[d],null),this.isedgevalidbylinkobj(b[d])&&this.addEdgeByLinkObj(b[d]);else for(var c=0;c<a.length;c++)this.isnodevalid(a[c])&&this.putEdgeByNodeObj(a[c])},createComponent:function(){var a=new this.klass.GraphComponent;return this.components.push(a),a},deleteComponent:function(a){for(var b=0;b<a.nodes.length;b++)this.modifyNodes.push(a.nodes[b]),this.setComponentRefs(a.nodes[b].obj,null),a.nodes[b].component=null;this.removeFromArray(this.components,a)},createNode:function(a){var b=new this.klass.GraphNode(a);return this.getObjNodeList(a).push(b),this.modifyNodes.push(b),b},deleteNode:function(a){var b=a.obj;this.setComponentRefs(b,null),this.removeFromArray(this.getObjNodeList(b),a),this.removeFromArray(this.modifyNodes,a);var c=a.component;null!==c&&(this.removeFromArray(c.nodes,a),this.resetExtraData(b),0===c.nodes.length&&this.deleteComponent(c))},createNodeIfEmpty:function(a){0===this.getObjNodeList(a).length&&this.createNode(a)},deleteNodeIfEmpty:function(a){var b=this.getObjNodeList(a);0!==b[0].nodes.length||this.isnodevalid(a)||this.deleteNode(b[0])},addEdge:function(a,b){a.nodes.indexOf(b)>=0||(a.nodes.push(b),b.nodes.push(a),this.rebuildmode||(this.modifyNodes.indexOf(a)<0&&this.modifyNodes.push(a),this.modifyNodes.indexOf(b)<0&&this.modifyNodes.push(b)))},removeEdge:function(a,b){a.nodes.indexOf(b)<0||(this.removeFromArray(a.nodes,b),this.removeFromArray(b.nodes,a),this.rebuildmode||(this.modifyNodes.indexOf(a)<0&&this.modifyNodes.push(a),this.modifyNodes.indexOf(b)<0&&this.modifyNodes.push(b)))},getSideObjByLinkObj:function(a){return a.sideobj},getSideObjByNodeObj:function(a){for(var b=a.getdir4clist(),c=[],d=0;d<b.length;d++){var e=b[d][0];this.isnodevalid(e)&&c.push(e)}return c},getSideNodesByLinkObj:function(a){for(var b=[],c=this.getSideObjByLinkObj(a),d=0;d<c.length;d++){var e=c[d],f=this.getObjNodeList(e),g=f[0];f[1]&&a.isvert&&(g=f[1]),b.push(g)}return b},getSideNodesBySeparator:function(a){for(var b=[],c=a.sideobj,d=0;d<c.length;d++){var e=this.getObjNodeList(c[d]);b.push(e?e[0]:null)}return b},setEdgeByLinkObj:function(a){var b=this.isedgevalidbylinkobj(a);b!==this.isedgeexistsbylinkobj(a)&&(this.modifyNodes=[],b?this.addEdgeByLinkObj(a):this.removeEdgeByLinkObj(a),this.remakeComponent())},setEdgeBySeparator:function(a){var b=this.isedgevalidbylinkobj(a);b!==this.isedgeexistsbylinkobj(a)&&(this.modifyNodes=[],b?this.addEdgeBySeparator(a):this.removeEdgeBySeparator(a),this.remakeComponent())},setEdgeByNodeObj:function(a){this.modifyNodes=[],this.putEdgeByNodeObj(a),this.remakeComponent()},putEdgeByNodeObj:function(a){(0!==this.calcNodeCount(a)||0!==this.getObjNodeList(a).length)&&(this.removeEdgeByNodeObj(a),this.addEdgeByNodeObj(a))},addEdgeByLinkObj:function(a){var b=this.getSideObjByLinkObj(a);this.createNodeIfEmpty(b[0]),this.createNodeIfEmpty(b[1]);var c=this.getSideNodesByLinkObj(a);this.addEdge(c[0],c[1])},removeEdgeByLinkObj:function(a){var b=this.getSideNodesByLinkObj(a);this.removeEdge(b[0],b[1]),this.deleteNodeIfEmpty(b[0].obj),this.deleteNodeIfEmpty(b[1].obj),this.linkgroup&&this.setComponentRefs(a,null)},addEdgeBySeparator:function(a){var b=this.getSideNodesBySeparator(a);this.addEdge(b[0],b[1])},removeEdgeBySeparator:function(a){var b=this.getSideNodesBySeparator(a);this.removeEdge(b[0],b[1])},removeEdgeByNodeObj:function(a){for(var b=this.getSideObjByNodeObj(a),c=this.getObjNodeList(a)[0],d=0;d<b.length;d++){var e=this.getObjNodeList(b[d])[0];c&&e&&this.removeEdge(c,e)}c&&this.deleteNode(c)},addEdgeByNodeObj:function(a){for(var b=0,c=this.calcNodeCount(a);c>b;b++)this.createNode(a);for(var d=this.getSideObjByNodeObj(a),e=this.getObjNodeList(a)[0],b=0;b<d.length;b++)if(this.isedgevalidbynodeobj(a,d[b])){var f=this.getObjNodeList(d[b])[0];e&&f&&this.addEdge(e,f)}},remakeComponent:function(){var a=this.getAffectedComponents();1===a.length&&this.checkDividedComponent(a[0]),this.modifyNodes&&this.modifyNodes.length>0&&this.remakeMaximalComonents(a)},getAffectedComponents:function(){for(var a=[],b=0;b<this.modifyNodes.length;b++){var c=this.modifyNodes[b].component;null!==c&&(c.isremake||(a.push(c),c.isremake=!0))}return a},checkDividedComponent:function(a){for(var b=0,c=this.modifyNodes.length;c>b;b++){var d=this.modifyNodes[b];d.component=null,this.setComponentRefs(d.obj,null),this.removeFromArray(a.nodes,d)}var e=new this.klass.GraphComponent;if(this.searchSingle(this.modifyNodes[0],e),e.nodes.length===this.modifyNodes.length){for(var b=0;b<this.modifyNodes.length;b++){var d=this.modifyNodes[b];d.component=a,this.setComponentRefs(d.obj,a),a.nodes.push(d)}this.modifyNodes=[],this.setComponentInfo(a),a.isremake=!1}},remakeMaximalComonents:function(a){for(var b=this.getLongColor(a),c=0;c<a.length;c++)this.deleteComponent(a[c]);var d=this.searchGraph();this.setLongColor(d,b)},searchGraph:function(){for(var a=this.modifyNodes,b=[],c=0,d=a.length;d>c;c++)a[c].component=null;for(var c=0,d=a.length;d>c;c++)if(null===a[c].component){var e=this.createComponent();this.searchSingle(a[c],e),this.setComponentInfo(e),b.push(e)}return this.modifyNodes=[],b},searchSingle:function(a,b){for(var c=[a];c.length>0;){var d=c.pop();if(null===d.component){d.component=b,b.nodes.push(d);for(var e=0;e<d.nodes.length;e++)c.push(d.nodes[e])}}},setComponentInfo:function(a){for(var b=0,c=0;c<a.nodes.length;c++){var d=a.nodes[c];b+=d.nodes.length,this.setComponentRefs(d.obj,a)}a.circuits=(b>>1)-a.nodes.length+1,this.setExtraData(a)},resetExtraData:function(a){},setExtraData:function(a){},getLongColor:function(a){return""},setLongColor:function(a,b){}},GraphComponent:{initialize:function(){this.nodes=[],this.color="",this.circuits=-1},getLinkObjByNodes:function(a,b){var c=a.obj.bx,d=a.obj.by,e=b.obj.bx,f=b.obj.by;return c>e||c===e&&d>f?null:this.board.getobj(c+e>>1,d+f>>1)},getnodeobjs:function(){for(var a=new(this.board.getGroup(this.nodes[0].obj.group).constructor),b=0;b<this.nodes.length;b++)a.add(this.nodes[b].obj);return a},getedgeobjs:function(){for(var a=[],b=0;b<this.nodes.length;b++)for(var c=this.nodes[b],d=0;d<c.nodes.length;d++){var e=this.getLinkObjByNodes(c,c.nodes[d]);e&&a.push(e)}return a},setedgeerr:function(a){for(var b=this.getedgeobjs(),c=0;c<b.length;c++)b[c].seterr(a)},setedgeinfo:function(a){for(var b=this.getedgeobjs(),c=0;c<b.length;c++)b[c].setinfo(a)}},GraphNode:{initialize:function(a){this.obj=a,this.nodes=[],this.component=null}}}),a.classmgr.makeCommon({"LineGraph:GraphBase":{initialize:function(){this.moveline&&this.relation.push("cell")},enabled:!1,relation:["line"],pointgroup:"cell",linkgroup:"border",isLineCross:!1,makeClist:!1,moveline:!1,setComponentRefs:function(a,b){a.path=b},isedgeexistsbylinkobj:function(a){return null!==a.path},getObjNodeList:function(a){return a.pathnodes},resetObjNodeList:function(a){a.pathnodes=[],this.moveline&&this.resetExtraData(a)},isnodevalid:function(a){return a.lcnt>0||this.moveline&&a.isNum()},isedgevalidbylinkobj:function(a){return a.isLine()},iscrossing:function(a){return this.isLineCross},rebuild2:function(){var b=this.board[this.pointgroup];this.ltotal=[b.length];for(var c=0;c<b.length;c++)b[c].lcnt=0;a.common.GraphBase.prototype.rebuild2.call(this)},incdecLineCount:function(a,b){a.group!==this.pointgroup||a.isnull||(this.ltotal[a.lcnt]--,b?a.lcnt++:a.lcnt--,this.ltotal[a.lcnt]=(this.ltotal[a.lcnt]||0)+1)},setLine:function(a){this.enabled&&this.setEdgeByLinkObj(a)},setCell:function(a){this.moveline&&(a.path?this.setComponentInfo(a.path):this.resetExtraData(a))},createNodeIfEmpty:function(a){var b=this.getObjNodeList(a);if(this.incdecLineCount(a,!0),0===b.length)this.createNode(a);else if(!b[1]&&2===b[0].nodes.length&&this.iscrossing(a)){this.createNode(a);var c=b[0].nodes,d=[a.getvert(c[0].obj,2),a.getvert(c[1].obj,2)];if(d[0]!==d[1]){var e=c[d[0]?1:0];this.removeEdge(b[0],e),this.addEdge(b[1],e)}else d[0]||d[1]||b.push(b.shift())}},deleteNodeIfEmpty:function(a){var b=this.getObjNodeList(a);if(this.incdecLineCount(a,!1),1!==b.length||0!==b[0].nodes.length||this.isnodevalid(a)){if(b[1]&&b[0].nodes.length+b[1].nodes.length===2&&this.iscrossing(a)){if(1===b[1].nodes.length){var c=b[1].nodes[0];this.removeEdge(b[1],c),this.addEdge(b[0],c)}else 2===b[1].nodes.length&&b.push(b.shift());this.deleteNode(b[1])}}else this.deleteNode(b[0])},resetExtraData:function(a){this.moveline&&(a.base=a.isNum()?a:this.board.emptycell)},setExtraData:function(a){a.color||(a.color=this.puzzle.painter.getNewLineColor());for(var b=a.getedgeobjs(),c=0;c<b.length;c++)this.setComponentRefs(b[c],a);(this.makeClist||this.moveline)&&(a.clist=new this.klass.CellList(a.getnodeobjs()),this.moveline&&this.setMovedBase(a))},setMovedBase:function(a){var b=this.board.emptycell;a.departure=a.destination=b,a.movevalid=!1;var c=a.clist;if(!(c.length<1)){var d=null,e=null,f=0;if(1===c.length)d=e=c[0],f=2;else for(var g=0;g<c.length;g++){var h=c[g];h.base=b,1===h.lcnt&&(f++,h.isNum()?d=h:e=h)}null!==d&&null!==e&&2===f&&(a.departure=e.base=d,a.destination=e,a.movevalid=!0)}},getLongColor:function(a){for(var b=a[0],c=1;c<a.length;c++)b.nodes.length<a[c].nodes.length&&(b=a[c]);return b?b.color:this.puzzle.painter.getNewLineColor()},setLongColor:function(a,b){if(0!==a.length){for(var c=this.puzzle,d=a[0],e=1;e<a.length;e++)d.nodes.length<a[e].nodes.length&&(d=a[e]);for(var e=0;e<a.length;e++){var f=a[e];f.color=f===d?b:f.color}c.execConfig("irowake")&&this.repaintNodes(a)}},repaintNodes:function(a){for(var b=new this.klass.BorderList,c=0;c<a.length;c++)b.extend(a[c].getedgeobjs());this.puzzle.painter.repaintLines(b)},newIrowake:function(){for(var a=this.components,b=0;b<a.length;b++)a[b].color=this.puzzle.painter.getNewLineColor()}}}),a.classmgr.makeCommon({"AreaGraphBase:GraphBase":{relation:["cell"],pointgroup:"cell",isedgevalidbynodeobj:function(a,b){return this.isedgevalidbylinkobj(this.board.getb(a.bx+b.bx>>1,a.by+b.by>>1))},setCell:function(a){this.enabled&&this.setEdgeByNodeObj(a)},setExtraData:function(a){a.clist=new this.klass.CellList(a.getnodeobjs())},getSideAreaInfo:function(a){for(var b=[],c=this.components.length,d={},e=this.board,f=0;f<this.components.length;f++)this.components[f].id=f;for(var g=0;g<e.border.length;g++){var h=e.border[g].sidecell[0],i=e.border[g].sidecell[1];if(!h.isnull&&!i.isnull){var j=h[a],k=i[a];if(j!==k&&null!==j&&null!==k){var l=j.id<k.id?j.id*c+k.id:k.id*c+j.id;d[l]||(d[l]=!0,b.push([j,k]))}}}return b}},"AreaShadeGraph:AreaGraphBase":{setComponentRefs:function(a,b){a.sblk=b},getObjNodeList:function(a){return a.sblknodes},resetObjNodeList:function(a){a.sblknodes=[]},isnodevalid:function(a){return a.isShade()}},"AreaUnshadeGraph:AreaGraphBase":{setComponentRefs:function(a,b){a.ublk=b},getObjNodeList:function(a){return a.ublknodes},resetObjNodeList:function(a){a.ublknodes=[]},isnodevalid:function(a){return a.isUnshade()}},"AreaNumberGraph:AreaGraphBase":{setComponentRefs:function(a,b){a.nblk=b},getObjNodeList:function(a){return a.nblknodes},resetObjNodeList:function(a){a.nblknodes=[]},isnodevalid:function(a){return a.isNumberObj()}},"AreaRoomGraph:AreaGraphBase":{relation:["cell","border"],pointgroup:"cell",hastop:!1,setComponentRefs:function(a,b){a.room=b},getObjNodeList:function(a){return a.roomnodes},resetObjNodeList:function(a){a.roomnodes=[]},isnodevalid:function(a){return 7!==a.ques},isedgevalidbylinkobj:function(a){return!a.isBorder()},rebuild2:function(){this.klass.AreaGraphBase.prototype.rebuild2.call(this);var a=this.board,b=a.border;this.ltotal=[];for(var c=0;c<a.cross.length;c++){var d=a.cross[c],e=d.bx,f=d.by,g=1===a.hasborder?e===a.minbx||e===a.maxbx||f===a.minby||f===a.maxby:!1;d.lcnt=g?2:0,this.ltotal[d.lcnt]=(this.ltotal[d.lcnt]||0)+1}for(var h=0;h<b.length;h++)this.isedgevalidbylinkobj(b[h])||this.incdecBorderCount(b[h],!0)},incdecBorderCount:function(a,b){for(var c=0;2>c;c++){var d=a.sidecross[c];d.isnull||(this.ltotal[d.lcnt]--,b?d.lcnt++:d.lcnt--,this.ltotal[d.lcnt]=(this.ltotal[d.lcnt]||0)+1)}},setBorder:function(a){this.enabled&&this.setEdgeBySeparator(a)},addEdgeBySeparator:function(a){var b=this.getSideNodesBySeparator(a);this.addEdge(b[0],b[1]),this.hastop&&this.setTopOfRoom_combine(b[0].obj,b[1].obj),this.incdecBorderCount(a,!1)},removeEdgeBySeparator:function(a){var b=this.getSideNodesBySeparator(a);this.removeEdge(b[0],b[1]),this.incdecBorderCount(a,!0)},setTopOfRoom_combine:function(a,b){var c,d,e=a.room.top,f=b.room.top;a.bx>b.bx||a.bx===b.bx&&a.id>b.id?(c=e,d=f):(c=f,d=e),c.isNum()&&(d.noNum()&&(d.setQnum(c.qnum),d.draw()),c.setQnum(-1),c.draw())},setExtraData:function(a){if(a.clist=new this.klass.CellList(a.getnodeobjs()),this.hastop&&(a.top=a.clist.getTopCell(),this.rebuildmode)){for(var b=-1,c=a.clist,d=a.top,e=0,f=c.length;f>e;e++){var g=c[e];g.room===a&&-1!==g.qnum&&(-1===b&&(b=g.qnum),d!==g&&(g.qnum=-1))}-1!==b&&-1===d.qnum&&(d.qnum=b)}}}}),function(){var b=1,c=2,d=3,e=4,f=5;a.classmgr.makeCommon({Graphic:{initialize:function(){this.gridcolor=this.gridcolor_list[this.gridcolor_type]||this.gridcolor,
this.bcolor=this.bcolor_list[this.bcolor_type]||this.bcolor,this.dotcolor=this.dotcolor_list[this.dotcolor_type]||this.dotcolor,this.errbcolor1=this.errbcolor1_list[this.errbcolor1_type]||this.errbcolor1,this.linecolor=this.linecolor_list[this.linecolor_type]||this.linecolor,this.resetRange(),this.initColor(),this.initFont()},context:null,subcontext:null,cellcolor_func:"",bgcellcolor_func:"",bordercolor_func:"",numbercolor_func:"",circlefillcolor_func:"",circlestrokecolor_func:"",quescolor:"black",qanscolor:"black",errcolor1:"rgb(224, 0, 0)",bcolor:"white",bcolor_type:"",bcolor_list:{GREEN:"rgb(160, 255, 160)"},qsubcolor1:"rgb(160,255,160)",qsubcolor2:"rgb(255,255,127)",qsubcolor3:"rgb(192,192,192)",dotcolor:"black",dotcolor_type:"",dotcolor_list:{PINK:"rgb(255, 96, 191)"},errbcolor1:"rgb(255, 160, 160)",errbcolor1_type:"",errbcolor1_list:{DARK:"rgb(255, 127, 127)"},errbcolor2:"rgb(64, 255, 64)",icecolor:"rgb(192, 224, 255)",erricecolor:"rgb(224,  96, 160)",circledcolor:"white",qcmpcolor:"silver",arrowQuescolor:"black",arrowQanscolor:"rgb(0, 160, 0)",fontcolor:"black",fontAnscolor:"rgb(0, 160, 0)",fontErrcolor:"rgb(191, 0, 0)",fontShadecolor:"rgb(224, 224, 224)",mbcolor:"rgb(255, 160, 127)",linecolor:"rgb(0, 160, 0)",linecolor_type:"",linecolor_list:{LIGHT:"rgb(0, 192, 0)"},errlinecolor:"rgb(255, 0, 0)",errlinebgcolor:"rgb(160, 160, 160)",movelinecolor:"silver",pekecolor:"rgb(32, 32, 255)",borderQuescolor:"black",borderQanscolor:"rgb(0, 191, 0)",borderQsubcolor:"rgb(255, 0, 255)",borderQsubcolor2:"rgb(64, 64, 64)",errborderbgcolor:"rgb(160, 160, 160)",bbcolor:"rgb(96, 96, 96)",targetColor1:"rgb(255, 64,  64)",targetColor3:"rgb(64,  64, 255)",ttcolor:"rgb(127,255,127)",movecolor:"red",gridcolor:"black",gridcolor_type:"",gridcolor_list:{DARK:"rgb( 48,  48,  48)",LIGHT:"rgb(127, 127, 127)",DLIGHT:"rgb(160, 160, 160)",SLIGHT:"rgb(191, 191, 191)",THIN:"rgb(224, 224, 224)"},bgcolor:"white",globalfontsizeratio:1,fontsizeratio:[.8,.7,.55],fontfamily:"",crosssize:.4,circleratio:[.4,.35],margin:.15,canvasWidth:null,canvasHeight:null,x0:0,y0:0,cw:36,ch:36,bw:18,bh:18,lw:1,lm:1,lwratio:12,addlw:0,lastHdeg:0,lastYdeg:0,minYdeg:.18,maxYdeg:.7,range:null,useBuffer:!1,outputImage:!1,pendingResize:!1,suspended:!0,suspendedAll:!0,hideHatena:!1,autocmp:"",irowake:!1,irowakeblk:!1,initCanvas:function(){var b=this.puzzle,c=this.context=b.canvas?b.canvas.getContext("2d"):null;if(c.use.canvas&&(this.subcontext=b.subcanvas?b.subcanvas.getContext("2d"):null,this.useBuffer=!!this.subcontext),null===this.canvasWidth||null===this.canvasHeight){var d=a.util.getRect(b.canvas);this.resizeCanvas(d.width,d.height)}this.pendingResize=!0,this.resize_canvas_main(),b.emit("canvasReady"),this.unsuspend()},initColor:function(){var a=this.puzzle.config.list;for(var b in a)"color_"===b.substr(0,6)&&this.setColor(b.substr(6),a[b].val)},setColor:function(a,b){b="bgcolor"===a?"string"==typeof b&&"white"!==b?b:this.constructor.prototype[a]:b||this.constructor.prototype[a],this[a]=b,this.suspended||this.paintAll()},initFont:function(){var a=1===this.puzzle.getConfig("font");this.puzzle.pzpr.env.OS.Android?this.fontfamily=a?"Helvetica, Verdana, Arial, ":'"Times New Roman", ':this.fontfamily="",this.fontfamily+=a?"sans-serif":"serif"},resizeCanvas:function(a,b){var c=this.suspended;this.suspendAll(),this.canvasWidth=a||this.canvasWidth,this.canvasHeight=b||this.canvasHeight,this.pendingResize=!0,c||this.unsuspend()},resizeCanvasByCellSize:function(a){var b=this.suspended;this.suspendAll(),this.cw=a||this.cw,this.ch=a||this.ch,this.canvasWidth=this.cw*this.getCanvasCols(),this.canvasHeight=this.ch*this.getCanvasRows(),this.pendingResize=!0,b||this.unsuspend()},resize_canvas_main:function(){this.pendingResize&&(this.pendingResize=!1,this.setParameter(),this.setOffset(),this.puzzle.emit("resize"),this.clearObject())},setParameter:function(){var a=this.canvasWidth,b=this.canvasHeight,c=this.getCanvasCols(),d=this.getCanvasRows(),e=a/c|0,f=b/d|0;this.puzzle.getConfig("squarecell")?this.cw=this.ch=Math.min(e,f):(this.cw=e,this.ch=f),this.bw=this.cw/2,this.bh=this.ch/2,this.lw=Math.max(this.cw/this.lwratio,3),this.lm=this.lw/2},setOffset:function(){var b=this.context,c=this.subcontext,d=this.canvasWidth,e=this.canvasHeight;b.changeSize(0|d,0|e),c&&c.changeSize(0|d,0|e);var f=this.x0=((d-this.cw*this.getBoardCols())/2+this.cw*this.getOffsetCols()|0)+.5,g=this.y0=((e-this.ch*this.getBoardRows())/2+this.ch*this.getOffsetRows()|0)+.5;if(b.use.canvas)b.translate(f,g),c&&c.translate(f,g);else{var h=a.util.getRect(b.canvas);b.translate(f-h.left%1,g-h.top%1)}},clearObject:function(){this.context.clear()},getCanvasCols:function(){return this.getBoardCols()+2*this.margin},getCanvasRows:function(){return this.getBoardRows()+2*this.margin},getBoardCols:function(){var a=this.board;return(a.maxbx-a.minbx)/2},getBoardRows:function(){var a=this.board;return(a.maxby-a.minby)/2},getOffsetCols:function(){return(0-this.board.minbx)/2},getOffsetRows:function(){return(0-this.board.minby)/2},suspend:function(){this.suspended=!0},suspendAll:function(){this.suspendedAll=!0,this.suspended=!0},unsuspend:function(){if(this.context){if(this.resize_canvas_main(),this.suspendedAll){var a=this.board;this.setRange(a.minbx-2,a.minby-2,a.maxbx+2,a.maxby+2),this.suspendedAll=!1}this.suspended&&(this.suspended=!1,this.prepaint())}},prepaint:function(){if(!this.suspended&&this.context){var a=this.board,b=2*this.margin,c=this.range.x1,d=this.range.y1,e=this.range.x2,f=this.range.y2;if(c>e||d>f||c>=a.maxbx+b||d>=a.maxby+b||e<=a.minbx-b||f<=a.minby-b);else if(this.useBuffer){var g=this.context,h=this.subcontext;this.context=h,this.setRangeObject(c-1,d-1,e+1,f+1),this.flushCanvas(),this.paint(),this.context=g;var i=this.x0+c*this.bw-1,j=this.y0+d*this.bh-1,k=this.x0+e*this.bw+2,l=this.y0+f*this.bh+2;0>i&&(i=0),k>h.child.width&&(k=h.child.width),0>j&&(j=0),l>h.child.height&&(l=h.child.height),g.drawImage(h.child,i,j,k-i,l-j,i-this.x0,j-this.y0,k-i,l-j)}else this.setRangeObject(c,d,e,f),this.flushCanvas(),this.paint();this.resetRange()}},paint:function(){},setRange:function(a,b,c,d){this.range.x1>a&&(this.range.x1=a),this.range.y1>b&&(this.range.y1=b),this.range.x2<c&&(this.range.x2=c),this.range.y2<d&&(this.range.y2=d)},setRangeObject:function(a,b,c,d){var e=this.board;this.range.cells=e.cellinside(a,b,c,d),this.range.crosses=e.crossinside(a,b,c,d),this.range.borders=e.borderinside(a,b,c,d),this.range.excells=e.excellinside(a,b,c,d)},resetRange:function(){var a=this.puzzle,b=a.board,c=a.klass;this.range={x1:b.maxbx+1,y1:b.maxby+1,x2:b.minbx-1,y2:b.minby-1,cells:new c.CellList,crosses:new c.CrossList,borders:new c.BorderList,excells:new c.EXCellList}},paintRange:function(a,b,c,d){this.setRange(a,b,c,d),this.prepaint()},paintAll:function(){this.suspended&&(this.suspendedAll=!0);var a=this.board;this.paintRange(a.minbx-2,a.minby-2,a.maxbx+2,a.maxby+2)},getNewLineColor:function(){for(var a=0;;){var b=(384*Math.random()|0)-64;0>b&&(b=0),b>255&&(b=255);var c=(384*Math.random()|0)-64;0>c&&(c=0),c>255&&(c=255);var d=(384*Math.random()|0)-64;0>d&&(d=0),d>255&&(d=255);var e=Math.max(b,Math.max(c,d)),f=Math.min(b,Math.min(c,d)),g=0,h=.5*(e+f)/255,i=e===f?0:(e-f)/(.5>=h?e+f:510-e-f);e===f?g=0:b>=c&&b>=d?g=(60*(c-d)/(e-f)+360)%360:c>=b&&c>=d?g=(120+60*(d-b)/(e-f)+360)%360:d>=c&&d>=b&&(g=(240+60*(b-c)/(e-f)+360)%360);var j=(.29891*b+.58661*c+.11448*d)/255;if(this.minYdeg<j&&j<this.maxYdeg&&Math.abs(this.lastYdeg-j)>.15&&(.02>i||i>.4)&&(360+this.lastHdeg-g)%360>=45&&(360+this.lastHdeg-g)%360<=315)return this.lastHdeg=g,this.lastYdeg=j,"rgb("+b+","+c+","+d+")";if(a++,a>100)return"rgb("+b+","+c+","+d+")"}},repaintBlocks:function(a){a.draw()},repaintLines:function(a){this.range.borders=a,this.drawLines(),this.context.use.canvas&&this.repaintParts(a)},repaintParts:function(a){},flushCanvas:function(){var a=this.vinc("background","crispEdges",!0),b=this.bw,c=this.bh,d=this.board,e=d.minbx,f=d.minby,g=d.maxbx-e,h=d.maxby-f;a.vid="BG",a.fillStyle=this.bgcolor,a.fillRect(e*b-.5,f*c-.5,g*b+1,h*c+1)},vinc:function(a,b,c){var d=this.context,e={freeze:!!c};return e.rendering=b,d.setLayer(a,e),d},CENTER:b,BOTTOMLEFT:c,BOTTOMRIGHT:d,TOPRIGHT:e,TOPLEFT:f,disptext:function(a,g,h,i){i=i||{};var j=this.context,k=i.style?i.style+" ":"",l=i.ratio||this.fontsizeratio,m=l[a.length-1]||l[l.length-1];m*=i.globalratio||this.globalfontsizeratio;var n=this.cw*m|0;j.font=k+n+"px "+this.fontfamily;var o=i.position||b;switch(o){case b:j.textAlign="center";break;case c:case f:j.textAlign="left",g-=this.bw-2;break;case d:case e:j.textAlign="right",g+=this.bw-2}switch(o){case b:j.textBaseline="middle";break;case e:case f:j.textBaseline="candle-top",h-=this.bh-2;break;case d:case c:j.textBaseline="alphabetic",h+=this.bh-2}j.fillText(a,g,h)}}})}(),a.classmgr.makeCommon({MouseEvent:{initialize:function(){this.cursor=this.puzzle.cursor,this.enableMouse=!0,this.mouseCell=null,this.firstCell=null,this.inputPoint=new this.klass.RawAddress,this.firstPoint=new this.klass.RawAddress,this.prevPos=new this.klass.Address,this.btn="",this.inputData=null,this.bordermode=!1,this.mousestart=!1,this.mousemove=!1,this.mouseend=!1,this.mousereset()},RBShadeCell:!1,use:!1,bgcolor:!1,redline:!1,redblk:!1,mousereset:function(){var a=this.mouseCell;this.mouseCell=this.firstCell=this.board.emptycell,this.firstPoint.reset(),this.prevPos.reset(),this.btn="",this.inputData=null,this.bordermode=!1,this.mousestart=!1,this.mousemove=!1,this.mouseend=!1,this.puzzle.execConfig("dispmove")&&a&&!a.isnull&&a.draw()},e_mousedown:function(a){if(!this.enableMouse)return!0;this.setMouseButton(a);var b=this.getBoardAddress(a);this.moveTo(b.bx,b.by),a.stopPropagation(),a.preventDefault()},e_mouseup:function(a){return this.enableMouse?(this.inputEnd(),a.stopPropagation(),void a.preventDefault()):!0},e_mousemove:function(a){if(!this.enableMouse)return!0;if(void 0!==a.touches||void 0===a.which||0!==a.which||a.type.match(/pointermove/i)&&a.buttons>0){var b=this.getBoardAddress(a);this.lineTo(b.bx,b.by)}else this.mousereset();a.stopPropagation(),a.preventDefault()},setMouseButton:function(b){this.btn=a.util.getMouseButton(b);var c=this.puzzle.key;c.checkmodifiers(b),(c.isSHIFT||c.isMETA)!==this.puzzle.getConfig("lrcheck")&&("left"===this.btn?this.btn="right":"right"===this.btn&&(this.btn="left"))},getBoardAddress:function(b){var c=this.puzzle,d=c.painter,e={px:NaN,py:NaN},f=d.context;if(!f)return e;if(!a.env.API.touchevent||a.env.OS.iOS)e=isNaN(b.offsetX)?{px:b.layerX,py:b.layerY}:{px:b.offsetX,py:b.offsetY};else{var g=a.util.getPagePos(b),h=a.util.getRect(d.context.child);e={px:g.px-h.left,py:g.py-h.top}}return{bx:(e.px-d.x0)/d.bw,by:(e.py-d.y0)/d.bh}},moveTo:function(a,b){this.inputPoint.init(a,b),this.mouseevent(0)},lineTo:function(a,b){for(var c=a-this.inputPoint.bx,d=b-this.inputPoint.by,e=2*((c>=0?c:-c)+(d>=0?d:-d))+.9|0,f=c/e,g=d/e,h=0;e-1>h;h++)this.inputPoint.move(f,g),this.mouseevent(1);this.inputPoint.init(a,b),this.mouseevent(1)},inputEnd:function(){this.mouseevent(2),this.mousereset()},inputPath:function(){var a=Array.prototype.slice.call(arguments);this.mousereset(),this.btn="string"==typeof a[0]?a.shift():"left",this.moveTo(a[0],a[1]);for(var b=2;b<a.length-1;b+=2)this.lineTo(a[b],a[b+1]);this.inputEnd()},mouseevent:function(a){this.cancelEvent=!1,this.mousestart=0===a,this.mousemove=1===a,this.mouseend=2===a;var b=this.puzzle;b.emit("mouse"),this.cancelEvent||"left"!==this.btn&&"right"!==this.btn||(this.mousestart?(b.opemgr.newOperation(),b.board.errclear()):b.opemgr.newChain(),this.mousestart&&this.dispRed()||this.mouseinput())},dispRed:function(){var a=this.puzzle,b=a.key.isZ,c=a.validConfig("redline")&&!!(a.getConfig("redline")^b),d=a.validConfig("redblk")&&!!(a.getConfig("redblk")^b);return c?this.dispRedLine():d&&this.dispRedBlk(),c||d},mouseinput:function(){},notInputted:function(){return!this.puzzle.opemgr.changeflag},getcell:function(){return this.getpos(0).getc()},getcell_excell:function(){var a=this.getpos(0),b=a.getex();return b.isnull?a.getc():b},getcross:function(){return this.getpos(.5).getx()},getpos:function(a){var b=this.inputPoint,c=2*a,d=2*(1-a),e=b.bx+4,f=b.by+4,g=e%2,h=f%2;return e=(-2&e)+ +(g>=c)+ +(g>=d)-4,f=(-2&f)+ +(h>=c)+ +(h>=d)-4,new this.klass.Address(e,f)},getborder:function(a){var b=this.inputPoint,c=(-2&b.bx)+1,d=(-2&b.by)+1,e=b.bx+1-c,f=b.by+1-d,g=this.board;if(g.linegraph.isLineCross)if(g.borderAsLine){var h=2*(.5-a),i=2*(.5+a);if(e>h&&i>e&&f>h&&i>f)return g.emptyborder}else{var h=2*a,i=2*(1-a);if((h>e||e>i)&&(h>f||f>i))return g.emptyborder}return 2-f>e?e>f?g.getb(c,d-1):g.getb(c-1,d):e>f?g.getb(c+1,d):g.getb(c,d+1)},isBorderMode:function(){return this.mousestart&&(this.bordermode=!this.getpos(.25).oncell()),this.bordermode},setcursor:function(a){var b=this.cursor.getaddr();this.cursor.setaddr(a),b.draw(),a.draw()}}}),a.classmgr.makeCommon({KeyEvent:{initialize:function(){this.cursor=this.puzzle.cursor,this.enableKey=!0,this.keyreset()},enablemake:!1,enableplay:!1,keyup_event:!1,keyreset:function(){this.isCTRL=!1,this.isMETA=!1,this.isALT=!1,this.isSHIFT=!1,this.isZ=!1,this.isX=!1,this.isY=!1,this.keydown=!1,this.keyup=!1,this.ca="",this.prev=null},isenablemode:function(){return this.puzzle.editmode&&this.enablemake||this.puzzle.playmode&&this.enableplay},e_keydown:function(a){if(this.enableKey){var b=this.getchar(a);this.checkbutton(b,0),b&&this.keyevent(b,0),(a.target===this.puzzle.canvas||this.cancelDefault)&&(a.stopPropagation(),a.preventDefault())}},e_keyup:function(a){if(this.enableKey){var b=this.getchar(a);this.checkbutton(b,1),b&&this.keyevent(b,1),(a.target===this.puzzle.canvas||this.cancelDefault)&&(a.stopPropagation(),a.preventDefault())}},checkmodifiers:function(a){this.isSHIFT=a.shiftKey,this.isCTRL=a.ctrlKey,this.isMETA=a.metaKey,this.isALT=a.altKey},checkbutton:function(a,b){var c=a.split(/\+/).pop();"z"===c&&(this.isZ=0===b),"x"===c&&(this.isX=0===b),"y"===c&&(this.isY=0===b)},getchar:function(a){this.checkmodifiers(a);var b="",c=a.keyCode?a.keyCode:a.charCode;38===c?b="up":40===c?b="down":37===c?b="left":39===c?b="right":c>=48&&57>=c?b=(c-48).toString(36):c>=65&&90>=c?b=(c-55).toString(36):c>=96&&105>=c?b=(c-96).toString(36):c>=112&&123>=c?b="F"+(c-111).toString(10):32===c||46===c?b=" ":8===c?b="BS":(109===c||189===c||173===c)&&(b="-");var d=b?[b]:[];return this.isMETA&&d.unshift("meta"),this.isALT&&d.unshift("alt"),this.isCTRL&&d.unshift("ctrl"),this.isSHIFT&&d.unshift("shift"),b=d.join("+"),"alt+h"===b?b="left":"alt+k"===b?b="up":"alt+j"===b?b="down":"alt+l"===b&&(b="right"),b},inputKeys:function(a){for(var b=0;b<arguments.length;b++)this.keyevent(arguments[b],0),this.keyevent(arguments[b],1)},keyevent:function(a,b){var c=this.puzzle;return this.cancelEvent=!1,this.cancelDefault=!1,this.keydown=0===b,this.keyup=1===b,this.keydown?c.opemgr.newOperation():c.opemgr.newChain(),this.keydown&&!this.isZ&&c.board.errclear(),c.emit("key",a),!this.cancelEvent&&this.keyexec(a)&&this.isenablemode()?this.keydown&&this.moveTarget(a)?void(this.cancelDefault=!0):void((this.keydown||this.keyup&&this.keyup_event)&&this.keyinput(a)):void 0},keyexec:function(a){var b=this.puzzle;return this.keydown&&"alt+c"===a&&!b.playeronly?(b.setMode(b.playmode?b.MODE_EDITOR:b.MODE_PLAYER),!1):!0},keyinput:function(a){this.key_inputqnum(a)},moveTarget:function(a){return this.moveTCell(a)},moveTCell:function(a){return this.moveTC(a,2)},moveTCross:function(a){return this.moveTC(a,2)},moveTBorder:function(a){return this.moveTC(a,1)},moveTC:function(a,b){var c=this.cursor,d=c.getaddr(),e=c.NDIR;switch(a){case"up":c.by-b>=c.miny&&(e=c.UP);break;case"down":c.by+b<=c.maxy&&(e=c.DN);break;case"left":c.bx-b>=c.minx&&(e=c.LT);break;case"right":c.bx+b<=c.maxx&&(e=c.RT);break;default:return!1}return e!==c.NDIR&&(c.movedir(e,b),d.draw(),c.draw()),e!==c.NDIR}},"TargetCursor:Address":{initialize:function(){this.bx=1,this.by=1},minx:null,miny:null,maxx:null,maxy:null,crosstype:!1,setminmax:function(){var a=this.board,b=this.crosstype?0:1;this.minx=a.minbx+b,this.miny=a.minby+b,this.maxx=a.maxbx-b,this.maxy=a.maxby-b,this.adjust_init()},initCursor:function(){this.crosstype?this.init(0,0):this.init(1,1),this.adjust_init()},adjust_init:function(){this.bx<this.minx&&(this.bx=this.minx),this.by<this.miny&&(this.by=this.miny),this.bx>this.maxx&&(this.bx=this.maxx),this.by>this.maxy&&(this.by=this.maxy)},adjust_modechange:function(){},setaddr:function(a){a.bx<this.minx||this.maxx<a.bx||a.by<this.miny||this.maxy<a.by||this.set(a)},targetdir:2,chtarget:function(){return this.targetdir=2===this.targetdir?4:2,this.draw(),!0},detectTarget:function(a){var b=this.board,c=a.adjacent;if(a.isnull)return 0;if("cell"===a.group){if(51!==a.ques||a.id===b.cell.length-1)return 0;if((c.right.isnull||51===c.right.ques)&&(c.bottom.isnull||51===c.bottom.ques))return 0;if(c.right.isnull||51===c.right.ques)return 4;if(c.bottom.isnull||51===c.bottom.ques)return 2}else{if("excell"!==a.group)return 0;if(a.id===b.cols+b.rows)return 0;if(-1===a.by&&51===c.bottom.ques||-1===a.bx&&51===c.right.ques)return 0;if(-1===a.by)return 4;if(-1===a.bx)return 2}return this.targetdir}}}),a.classmgr.makeCommon({Encode:{pflag:"",outpflag:"",outcols:null,outrows:null,outbstr:"",fio:null,checkpflag:function(a){return this.pflag.indexOf(a)>=0},decodeURL:function(b){var c=a.parser.parseURL(b),d=this.puzzle,e=d.board;if(e.initBoardSize(c.cols,c.rows),c.body)switch(this.pflag=c.pflag,this.outbstr=c.body,c.type){case c.URL_PZPRV3:case c.URL_KANPENP:this.decodePzpr(c.URL_PZPRV3);break;case c.URL_PZPRAPP:this.decodePzpr(c.URL_PZPRAPP);break;case c.URL_KANPEN:this.fio=new d.klass.FileIO,this.fio.dataarray=this.outbstr.replace(/_/g," ").split("/"),this.decodeKanpen(),this.fio=null;break;case c.URL_HEYAAPP:this.decodeHeyaApp()}e.rebuildInfo()},encodeURL:function(b){var c=this.puzzle,d=c.pid,e=c.board,f=new a.parser.URLData("");switch(b=b||f.URL_PZPRV3,b===f.URL_KANPEN&&"lits"===d&&(b=f.URL_KANPENP),this.outpflag=null,this.outcols=e.cols,this.outrows=e.rows,this.outbstr="",b){case f.URL_PZPRV3:this.encodePzpr(f.URL_PZPRV3);break;case f.URL_PZPRAPP:throw"no Implemention";case f.URL_KANPENP:if(!c.info.exists.kanpen)throw"no Implemention";this.encodePzpr(f.URL_PZPRAPP),this.outpflag=this.outpflag||"";break;case f.URL_KANPEN:this.fio=new c.klass.FileIO,this.encodeKanpen(),this.outbstr=this.fio.datastr.replace(/\r?\n/g,"/").replace(/ /g,"_"),this.fio=null;break;case f.URL_HEYAAPP:this.encodeHeyaApp();break;default:throw"invalid URL Type"}return f.pid=d,f.type=b,f.pflag=this.outpflag,f.cols=this.outcols,f.rows=this.outrows,f.body=this.outbstr,f.generate()},decodePzpr:function(a){throw"no Implemention"},encodePzpr:function(a){throw"no Implemention"},decodeKanpen:function(){throw"no Implemention"},encodeKanpen:function(){throw"no Implemention"},decodeHeyaApp:function(){throw"no Implemention"},encodeHeyaApp:function(){throw"no Implemention"}}}),a.classmgr.makeCommon({FileIO:{filever:0,lineseek:0,dataarray:null,xmldoc:null,datastr:"",currentType:0,filedecode:function(b){var c=this.puzzle,d=c.board,e=a.parser.parseFile(b,c.pid),f=this.currentType=e.type;d.initBoardSize(e.cols,e.rows),this.filever=e.filever,f!==e.FILE_PBOX_XML?(this.lineseek=0,this.dataarray=e.body.split("\n")):this.xmldoc=e.body,f===e.FILE_PZPR?this.decodeData():f===e.FILE_PBOX?this.kanpenOpen():f===e.FILE_PBOX_XML&&this.kanpenOpenXML(),c.metadata.update(e.metadata),e.history&&f===e.FILE_PZPR&&c.opemgr.decodeHistory(e.history),d.rebuildInfo(),this.dataarray=null},fileencode:function(c,d){var e=this.puzzle,f=e.board,g=new a.parser.FileData("",e.pid);if(this.currentType=c=c||g.FILE_PZPR,d=d||{},this.filever=0,this.datastr="",c===g.FILE_PBOX_XML){this.xmldoc=(new b).parseFromString('<?xml version="1.0" encoding="utf-8" ?><puzzle />',"text/xml");var h=this.xmldoc.querySelector("puzzle");h.appendChild(this.createXMLNode("board")),h.appendChild(this.createXMLNode("answer"))}if(c===g.FILE_PZPR)this.encodeData();else if(c===g.FILE_PBOX)this.kanpenSave();else{if(c!==g.FILE_PBOX_XML)throw"invalid URL Type";this.kanpenSaveXML()}return g.type=c,g.filever=this.filever,g.cols=f.cols,g.rows=f.rows,c!==g.FILE_PBOX_XML?g.body=this.datastr:g.body=this.xmldoc,g.metadata.update(e.metadata),d.history&&c===g.FILE_PZPR&&(g.history=e.opemgr.encodeHistory()),this.datastr="",g.generate()},decodeData:function(){throw"no Implemention"},encodeData:function(){throw"no Implemention"},kanpenOpen:function(){throw"no Implemention"},kanpenSave:function(){throw"no Implemention"},kanpenOpenXML:function(){throw"no Implemention"},kanpenSaveXML:function(){throw"no Implemention"},readLine:function(){return this.lineseek++,this.dataarray[this.lineseek-1]},readLines:function(a){return this.lineseek+=a,this.dataarray.slice(this.lineseek-a,this.lineseek)},getItemList:function(a){for(var b=[],c=this.readLines(a),d=0;d<c.length;d++){for(var e=c[d].split(" "),f=[],g=0;g<e.length;g++)""!==e[g]&&f.push(e[g]);b=b.concat(f)}return b},decodeObj:function(a,b,c,d,e,f){for(var g=c,h=d,i=2,j=this.getItemList((f-d)/i+1),k=0;k<j.length&&(a(this.board.getObjectPos(b,g,h),j[k]),g+=i,g>e&&(g=c,h+=i),!(h>f));k++);},decodeCell:function(a){this.decodeObj(a,"cell",1,1,2*this.board.cols-1,2*this.board.rows-1)},decodeCross:function(a){this.decodeObj(a,"cross",0,0,2*this.board.cols,2*this.board.rows)},decodeBorder:function(b){var c=this.puzzle,d=c.board;1===d.hasborder||"bosanowa"===c.pid||"fourcells"===c.pid&&0===this.filever?(this.decodeObj(b,"border",2,1,2*d.cols-2,2*d.rows-1),this.decodeObj(b,"border",1,2,2*d.cols-1,2*d.rows-2)):2===d.hasborder&&(this.currentType===a.parser.FILE_PZPR?(this.decodeObj(b,"border",0,1,2*d.cols,2*d.rows-1),this.decodeObj(b,"border",1,0,2*d.cols-1,2*d.rows)):this.currentType===a.parser.FILE_PBOX&&(this.decodeObj(b,"border",1,0,2*d.cols-1,2*d.rows),this.decodeObj(b,"border",0,1,2*d.cols,2*d.rows-1)))},encodeObj:function(a,b,c,d,e,f){for(var g=2,h=d;f>=h;h+=g){for(var i=c;e>=i;i+=g)this.datastr+=a(this.board.getObjectPos(b,i,h));this.datastr+="\n"}},encodeCell:function(a){this.encodeObj(a,"cell",1,1,2*this.board.cols-1,2*this.board.rows-1)},encodeCross:function(a){this.encodeObj(a,"cross",0,0,2*this.board.cols,2*this.board.rows)},encodeBorder:function(b){var c=this.puzzle,d=c.board;1===d.hasborder||"bosanowa"===c.pid?(this.encodeObj(b,"border",2,1,2*d.cols-2,2*d.rows-1),this.encodeObj(b,"border",1,2,2*d.cols-1,2*d.rows-2)):2===d.hasborder&&(this.currentType===a.parser.FILE_PZPR?(this.encodeObj(b,"border",0,1,2*d.cols,2*d.rows-1),this.encodeObj(b,"border",1,0,2*d.cols-1,2*d.rows)):this.currentType===a.parser.FILE_PBOX&&(this.encodeObj(b,"border",1,0,2*d.cols-1,2*d.rows),this.encodeObj(b,"border",0,1,2*d.cols,2*d.rows-1)))},decodeCellXMLBoard:function(a){for(var b=this.xmldoc.querySelectorAll("board number"),c=0;c<b.length;c++){var d=b[c],e=this.board.getc(2*+d.getAttribute("c")-1,2*+d.getAttribute("r")-1);e.isnull||a(e,+d.getAttribute("n"))}},encodeCellXMLBoard:function(a){for(var b=this.xmldoc.querySelector("board"),c=this.board,d=0;d<c.cell.length;d++){var e=c.cell[d],f=a(e);null!==f&&b.appendChild(this.createXMLNode("number",{r:(e.by/2|0)+1,c:(e.bx/2|0)+1,n:f}))}},PBOX_ADJUST:0,decodeCellXMLBrow:function(a){this.decodeCellXMLrow_com(a,"board","brow")},encodeCellXMLBrow:function(a){this.encodeCellXMLrow_com(a,"board","brow")},decodeCellXMLArow:function(a){this.decodeCellXMLrow_com(a,"answer","arow")},encodeCellXMLArow:function(a){this.encodeCellXMLrow_com(a,"answer","arow")},decodeCellXMLrow_com:function(a,b,c){for(var d=this.xmldoc.querySelectorAll(b+" "+c),e=this.PBOX_ADJUST,f=0;f<d.length;f++)for(var g=1-e,h=2*+d[f].getAttribute("row")-1-e,i=d[f].childNodes,j=0;j<i.length;j++)if(1===i[j].nodeType){var k=i[j].nodeName,l=i[j].getAttribute("n")||1;"z"===k?k="n0":"n"===k&&(k="n"+ +i[j].getAttribute("v"));for(var m=0;l>m;m++)a(this.board.getobj(g,h),k),g+=2}},encodeCellXMLrow_com:function(a,b,c){for(var d=this.xmldoc.querySelector(b),e=this.PBOX_ADJUST,f=this.board,g=1-e;g<=f.maxby;g+=2){for(var h=this.createXMLNode(c,{row:((g+e)/2|0)+1}),i=1-e;i<=f.maxbx;i+=2){var j,k=f.getobj(i,g),l=a(k);j=l.match(/n(\d\d+)/)||l.match(/n(\-\d+)/)?this.createXMLNode("n",{v:RegExp.$1}):"n0"===l?this.createXMLNode("z"):this.createXMLNode(l),h.appendChild(j)}d.appendChild(h)}},createXMLNode:function(a,b){var c=this.xmldoc.createElement(a);if(b)for(var d in b)c.setAttribute(d,b[d]);return c}}}),a.classmgr.makeCommon({AnsCheck:{initialize:function(){this.inCheck=!1,this.checkOnly=!1,this.makeCheckList()},failcodemode:void 0,failcode:void 0,_info:void 0,checklist:[],makeCheckList:function(){for(var b=this.checklist,c=[],d=0;d<b.length;d++){var e=b[d],f=!0,g=0;e.match("@")&&(f=a.util.checkpid(e.substr(e.indexOf("@")+1),this.puzzle.pid),e=e.substr(0,e.indexOf("@"))),f&&(g=(e.match(/\+/)||[]).length,e=e.replace(/\+/g,""),c.push([this[e],g]))}this.checklist_normal=[];for(var d=0;d<c.length;d++)this.checklist_normal.push(c[d][0]);c=c.sort(function(a,b){return b[1]-a[1]}),this.checklist_auto=[];for(var d=0;d<c.length;d++)this.checklist_auto.push(c[d][0])},check:function(a){var b=this.puzzle,c=this.board;return this.inCheck=!0,a?(this.checkOnly=!1,this.checkAns(!1),this.failcode.complete||(c.haserror=!0,b.redraw(!0))):(void 0===this.failcode||this.failcodemode!==a)&&(c.disableSetError(),this.checkOnly=!0,this.checkAns(a===!1),this.failcodemode=a,c.enableSetError()),this.inCheck=!1,this.failcode},checkAns:function(a){this.failcode=new this.klass.CheckInfo;for(var b=!this.puzzle.getConfig("multierr")||a,c=this.checkOnly&&b?this.checklist_auto:this.checklist_normal,d=0;d<c.length&&(c[d].call(this),!(b&&this.failcode.length>0));d++);a||(this.failcode.text=this.failcode.gettext())},resetCache:function(){this.failcode=this.failcodemode=void 0,this._info={}}},CheckInfo:{initialize:function(a){this.add(a)},complete:!0,text:"",length:0,lastcode:null,add:function(a){a&&(a!==this.lastcode&&(this[this.length++]=this.lastcode=a),this.complete=!1)},gettext:function(b){var c=this.puzzle,d=c.faillist,e=[],f="ja"===(b||a.lang)?0:1;if(0===this.length)return d.complete[f];for(var g=0;g<this.length;g++){var h=d[this[g]]||d.invalid;e.push(h[f])}return e.join("\n")}},FailCode:{complete:["正解です！","Complete!"],invalid:["不明なエラーです","Invalid Error"]}}),a.classmgr.makeCommon({Operation:{initialize:function(){if(this.manager=this.puzzle.opemgr,arguments.length>0){var a=Array.prototype.slice.call(arguments);this.setData.apply(this,a)}},reqReset:!1,setData:function(a,b){this.old=a,this.num=b},decode:function(a){return!1},toString:function(){return""},toJSON:function(){return this.toString()},undo:function(){this.exec(this.old)},redo:function(){this.exec(this.num)},exec:function(a){}},"ObjectOperation:Operation":{group:"",property:"",STRGROUP:{C:"cell",X:"cross",B:"border",E:"excell"},STRPROP:{U:"ques",N:"qnum",Z:"qnum2",C:"qchar",M:"anum",D:"qdir",A:"qans",S:"qsub",K:"qcmp",L:"line"},setData:function(a,b,c,d){this.group=a.group,this.property=b,this.bx=a.bx,this.by=a.by,this.old=c,this.num=d},decode:function(a){return this.group=this.STRGROUP[a[0].charAt(0)],this.property=this.STRPROP[a[0].charAt(1)],this.group&&this.property?(this.bx=+a[1],this.by=+a[2],this.old=+a[3],this.num=+a[4],!0):!1},toString:function(){var a="";for(var b in this.STRGROUP)if(this.group===this.STRGROUP[b]){a+=b;break}for(var b in this.STRPROP)if(this.property===this.STRPROP[b]){a+=b;break}return[a,this.bx,this.by,this.old,this.num].join(",")},isModify:function(a){var b=this.property;return a.group!==this.group||a.property!==this.property||a.num!==this.old||a.bx!==this.bx||a.by!==this.by||"qnum"!==b&&"qnum2"!==b&&"qchar"!==b&&"anum"!==b?!1:(a.num=this.num,!0)},exec:function(a){var b=this.board,c=b.getObjectPos(this.group,this.bx,this.by);if(this.group!==c.group)return!0;switch(c.setdata(this.property,a),c.draw(),this.property){case"qcmp":b.cell.each(function(a){c===a.base&&a.draw()});break;case"qsub":break;default:this.puzzle.checker.resetCache()}}},"BoardAdjustOperation:Operation":{prefix:"AJ",reqReset:!0,setData:function(a){this.old=this.num=a},decode:function(a){return a[0]!==this.prefix?!1:(this.old=this.num=a[1],!0)},toString:function(){return[this.prefix,this.num].join(",")},undo:function(){var a=this.board.exec.boardtype[this.old][0];this.exec(a)},redo:function(){var a=this.board.exec.boardtype[this.num][1];this.exec(a)},exec:function(a){var b=this.puzzle,c=b.board,d={x1:0,y1:0,x2:2*c.cols,y2:2*c.rows};c.exec.execadjust_main(a,d),b.redraw()}},"BoardFlipOperation:Operation":{prefix:"AT",reqReset:!0,area:{},setData:function(a,b){this.area=a,this.old=this.num=b},decode:function(a){return a[0]!==this.prefix?!1:(this.old=this.num=a[1],this.area.x1=+a[2],this.area.y1=+a[3],this.area.x2=+a[4],this.area.y2=+a[5],!0)},toString:function(){var a=this.area;return[this.prefix,this.num,a.x1,a.y1,a.x2,a.y2].join(",")},undo:function(){var a=this.area,b={x1:a.x1,y1:a.y1,x2:a.x2,y2:a.y2},c=this.board.exec.boardtype[this.old][0];if(c&this.TURN){var d=b.x1;b.x1=b.y1,b.y1=d}this.exec(c,b)},redo:function(){var a=this.area,b={x1:a.x1,y1:a.y1,x2:a.x2,y2:a.y2},c=this.board.exec.boardtype[this.num][1];this.exec(c,b)},exec:function(a,b){var c=this.puzzle;c.board.exec.execadjust_main(a,b),c.redraw()}},OperationManager:{initialize:function(){this.lastope=null,this.ope=[],this.position=0,this.broken=!1,this.initpos=0,this.disrec=0,this.disCombine=!1,this.forceRecord=!1,this.changeflag=!1,this.chainflag=!1,this.enableUndo=!1,this.enableRedo=!1,this.undoExec=!1,this.redoExec=!1,this.reqReset=!1;var a=this.klass;this.operationlist=[a.ObjectOperation,a.BoardAdjustOperation,a.BoardFlipOperation],this.addExtraOperation()},addExtraOperation:function(){},disableRecord:function(){this.disrec++},enableRecord:function(){this.disrec>0&&this.disrec--},checkexec:function(){void 0!==this.ope&&(this.enableUndo=this.position>0,this.enableRedo=this.position<this.ope.length,this.puzzle.emit("history"))},allerase:function(){this.lastope=null,this.ope=[],this.position=0,this.broken=!1,this.initpos=0,this.changeflag=!1,this.chainflag=!1,this.checkexec(),this.puzzle.checker.resetCache()},newOperation:function(){this.changeflag=!1,this.chainflag=!1},newChain:function(){this.chainflag=!1},isModified:function(){return this.isbroken||this.initpos<this.position},add:function(a){if(!(!this.puzzle.ready||!this.forceRecord&&this.disrec>0)){if(this.enableRedo){this.position<this.initpos&&(this.broken=!0);for(var b=this.ope.length-1;b>=this.position;b--)this.ope.pop();this.position=this.ope.length,this.chainflag=!1}var c=this.puzzle;!this.disCombine&&this.lastope&&a.isModify&&a.isModify(this.lastope)||(this.chainflag||(this.ope.push([]),this.position++,this.chainflag=!0),this.ope[this.ope.length-1].push(a),this.lastope=a),"qsub"!==a.property&&"qcmp"!==a.property&&c.checker.resetCache(),this.changeflag=!0,this.checkexec()}},decodeHistory:function(a){this.allerase(),this.ope=[],this.initpos=this.position=a.current;for(var b=0,c=a.datas.length;c>b;b++){this.ope.push([]);for(var d=0,e=a.datas[b].length;e>d;d++){for(var f=a.datas[b][d].split(/,/),g=null,h=this.operationlist,i=0;i<h.length;i++){var j=new h[i];if(j.decode(f)){g=j;break}}g&&(this.ope[this.ope.length-1].push(g),this.lastope=g)}}this.checkexec()},encodeHistory:function(){return this.initpos=this.position,{type:"pzpr",version:.3,current:this.position,datas:this.ope}},undo:function(){if(!this.enableUndo)return!1;var a=this.ope[this.position-1];this.reqReset=this.checkReqReset(a),this.preproc(),this.undoExec=!0;for(var b=a.length-1;b>=0;b--)a[b]&&a[b].undo();return this.position--,this.undoExec=!1,this.postproc(),this.enableUndo},redo:function(){if(!this.enableRedo)return!1;var a=this.ope[this.position];this.reqReset=this.checkReqReset(a),this.preproc(),this.redoExec=!0;for(var b=0,c=a.length;c>b;b++)a[b]&&a[b].redo();return this.position++,this.redoExec=!1,this.postproc(),this.enableRedo},checkReqReset:function(a){for(var b=!1,c=0,d=a.length;d>c;c++)if(a[c].reqReset){b=!0;break}return b},preproc:function(a){var b=this.puzzle,c=b.board;this.disableRecord(),b.painter.suspend(),c.errclear(),
this.reqReset&&c.disableInfo()},postproc:function(){var a=this.puzzle,b=a.board;this.reqReset&&(b.setposAll(),b.setminmax(),b.enableInfo(),b.rebuildInfo(),a.redraw(!0),a.emit("adjust")),a.painter.unsuspend(),this.enableRecord(),this.checkexec()}}}),a.classmgr.makeCommon({Graphic:{drawShadedCells:function(){for(var a=this.vinc("cell_front","crispEdges",!0),b=this.range.cells,c=0;c<b.length;c++){var d=b[c],e=this.getCellColor(d);a.vid="c_fullb_"+d.id,e?(a.fillStyle=e,a.fillRectCenter(d.bx*this.bw,d.by*this.bh,this.bw+.5,this.bh+.5)):a.vhide()}},getCellColor:function(a){var b=this.cellcolor_func||"qans";return this.getCellColor="ques"===b?this.getCellColor_ques:"qnum"===b?this.getCellColor_qnum:"qans"===b?this.getCellColor_qans:function(){return null},this.getCellColor(a)},getCellColor_ques:function(a){if(1!==a.ques)return null;var b=a.error||a.qinfo;return 0===b?this.quescolor:1===b?this.errcolor1:void 0},getCellColor_qnum:function(a){if(-1===a.qnum)return null;var b=a.error||a.qinfo;return 0===b?this.quescolor:1===b?this.errcolor1:null},getCellColor_qans:function(a){if(1!==a.qans)return null;var b=a.error||a.qinfo;return 0===b?this.qanscolor:1===b?this.errcolor1:null},drawBGCells:function(){for(var a=this.vinc("cell_back","crispEdges",!0),b=this.range.cells,c=0;c<b.length;c++){var d=b[c],e=this.getBGCellColor(d);a.vid="c_full_"+d.id,e?(a.fillStyle=e,a.fillRectCenter(d.bx*this.bw,d.by*this.bh,this.bw+.5,this.bh+.5)):a.vhide()}},getBGCellColor:function(a){var b=this.bgcellcolor_func||"error1";return this.getBGCellColor="error1"===b?this.getBGCellColor_error1:"error2"===b?this.getBGCellColor_error2:"qans1"===b?this.getBGCellColor_qans1:"qans2"===b?this.getBGCellColor_qans2:"qsub1"===b?this.getBGCellColor_qsub1:"qsub2"===b?this.getBGCellColor_qsub2:"qsub3"===b?this.getBGCellColor_qsub3:"icebarn"===b?this.getBGCellColor_icebarn:function(){return null},this.getBGCellColor(a)},getBGCellColor_error1:function(a){return 1===a.error||1===a.qinfo?this.errbcolor1:null},getBGCellColor_error2:function(a){var b=a.error||a.qinfo;return 1===b?this.errbcolor1:2===b?this.errbcolor2:null},getBGCellColor_qans1:function(a){var b=a.error||a.qinfo;return 1===a.qans?1===b?this.errcolor1:this.qanscolor:1===b?this.errbcolor1:2===b?this.errbcolor2:1===a.qsub&&"white"!==this.bcolor?this.bcolor:null},getBGCellColor_qans2:function(a){var b=a.error||a.qinfo;if(1===a.qans){if(0===b)return this.qanscolor;if(1===b)return this.errcolor1;if(2===b)return this.errcolor2}return 1===b?this.errbcolor1:1===a.qsub&&"white"!==this.bcolor?this.bcolor:null},getBGCellColor_qsub1:function(a){return 1===a.error||1===a.qinfo?this.errbcolor1:1===a.qsub?this.bcolor:null},getBGCellColor_qsub2:function(a){return this.bcolor="silver",1===a.error||1===a.qinfo?this.errbcolor1:1===a.qsub?this.qsubcolor1:2===a.qsub?this.qsubcolor2:null},getBGCellColor_qsub3:function(a){return 1===a.error||1===a.qinfo?this.errbcolor1:1===a.qsub?this.qsubcolor1:2===a.qsub?this.qsubcolor2:3===a.qsub?this.qsubcolor3:null},getBGCellColor_icebarn:function(a){return 1===a.error||1===a.qinfo?6===a.ques?this.erricecolor:this.errbcolor1:6===a.ques?this.icecolor:null},drawBGEXcells:function(){for(var a=this.vinc("excell_back","crispEdges",!0),b=this.range.excells,c=0;c<b.length;c++){var d=b[c],e=this.getBGEXcellColor(d);a.vid="ex_full_"+d.id,e?(a.fillStyle=e,a.fillRectCenter(d.bx*this.bw,d.by*this.bh,this.bw+.5,this.bh+.5)):a.vhide()}},getBGEXcellColor:function(a){return 1===a.error||1===a.qinfo?this.errbcolor1:null},drawDotCells:function(a){var b=this.vinc("cell_dot",a?"crispEdges":"auto",!0);b.fillStyle=this.dotcolor;for(var c=Math.max(this.cw*(a?.075:.06),2),d=this.range.cells,e=0;e<d.length;e++){var f=d[e];if(b.vid="c_dot_"+f.id,1===f.qsub){var g=f.bx*this.bw,h=f.by*this.bh;a?b.fillRectCenter(g,h,c,c):b.fillCircle(g,h,c)}else b.vhide()}},drawCellArrows:function(){var a,b,c,d,e=this.vinc("cell_arrow","auto");"nagare"!==this.pid?(a=.4*this.cw,b=.03*this.cw,c=.16*this.cw,d=.16*this.cw):(a=.35*this.cw,b=.12*this.cw,c=0,d=.35*this.cw),b=b>=1?b:1,d=d>=5?d:5;for(var f=this.range.cells,g=0;g<f.length;g++){var h=f[g],i=h.numberAsObject?h.getNum():h.qdir,j=i>=1&&4>=i?this.getCellArrowColor(h):null;if(e.vid="c_arrow_"+h.id,j){e.fillStyle=j,e.beginPath();var k=h.bx*this.bw,l=h.by*this.bh;switch(i){case h.UP:e.setOffsetLinePath(k,l,0,-a,-d,-c,-b,-c,-b,a,b,a,b,-c,d,-c,!0);break;case h.DN:e.setOffsetLinePath(k,l,0,a,-d,c,-b,c,-b,-a,b,-a,b,c,d,c,!0);break;case h.LT:e.setOffsetLinePath(k,l,-a,0,-c,-d,-c,-b,a,-b,a,b,-c,b,-c,d,!0);break;case h.RT:e.setOffsetLinePath(k,l,a,0,c,-d,c,-b,-a,-b,-a,b,c,b,c,d,!0)}e.fill()}else e.vhide()}},getCellArrowColor:function(a){var b=a.numberAsObject?a.getNum():a.qdir;return b>=1&&4>=b?a.numberAsObject&&-1===a.qnum?this.arrowQanscolor:this.arrowQuescolor:null},drawSlashes:function(){for(var a=this.vinc("cell_slash","auto"),b=Math.max(this.bw/4,2),c=this.puzzle.execConfig("irowake"),d=this.range.cells,e=0;e<d.length;e++){var f=d[e];if(a.vid="c_slash_"+f.id,0!==f.qans){var g=f.error||f.qinfo,h=0;1===g?(a.strokeStyle=this.errcolor1,h=b/2):2===g?a.strokeStyle=this.errcolor2:-1===g?a.strokeStyle=this.errlinebgcolor:(3===g&&(h=b/2),c&&f.path.color?a.strokeStyle=f.path.color:a.strokeStyle=this.qanscolor),a.lineWidth=b+h,a.beginPath();var i=f.bx*this.bw,j=f.by*this.bh;31===f.qans?a.setOffsetLinePath(i,j,-this.bw,-this.bh,this.bw,this.bh,!0):32===f.qans&&a.setOffsetLinePath(i,j,this.bw,-this.bh,-this.bw,this.bh,!0),a.stroke()}else a.vhide()}},drawNumbers:function(){for(var a=this.vinc("cell_number","auto"),b=this.range.cells,c=0;c<b.length;c++){var d=b[c],e=(this.puzzle.execConfig("dispmove")?d.base:d).getNum(),f=e>=0?""+e:this.hideHatena||-2!==e?"":"?";a.vid="cell_text_"+d.id,f?(a.fillStyle=this.getNumberColor(d),this.disptext(f,d.bx*this.bw,d.by*this.bh)):a.vhide()}},drawHatenas:function(){for(var a=this.vinc("cell_hatena","auto"),b=this.range.cells,c=0;c<b.length;c++){var d=b[c];a.vid="cell_text_"+d.id,-2===d.ques||-2===d.qnum?(a.fillStyle=this.getNumberColor_qnum(d),this.disptext("?",d.bx*this.bw,d.by*this.bh)):a.vhide()}},getNumberColor:function(a){var b=this.numbercolor_func||"";return this.getNumberColor="fixed"===b?this.getNumberColor_fixed:"qnum"===b?this.getNumberColor_qnum:"move"===b?this.getNumberColor_move:"anum"===b?this.getNumberColor_anum:this.getNumberColor_mixed,this.getNumberColor(a)},getNumberColor_fixed:function(a){return this.fontcolor},getNumberColor_qnum:function(a){return 1===(a.error||a.qinfo)?this.fontErrcolor:this.fontcolor},getNumberColor_move:function(a){var b=this.puzzle,c=a.error||a.qinfo;return 1===c||4===c?this.fontErrcolor:b.execConfig("dispmove")&&b.mouse.mouseCell===a?this.movecolor:this.fontcolor},getNumberColor_anum:function(a){return 1===(a.error||a.qinfo)?this.fontErrcolor:this.fontAnscolor},getNumberColor_mixed:function(a){var b=a.error||a.qinfo;return a.ques>=1&&a.ques<=5||1===a.qans?this.fontShadecolor:1===b||4===b?this.fontErrcolor:-1===a.qnum&&-1!==a.anum?this.fontAnscolor:this.fontcolor},drawArrowNumbers:function(){for(var a=this.vinc("cell_arrownumber","auto"),b=.4*this.cw,c=.03*this.cw,d=.16*this.cw,e=.12*this.cw,f=.6*-this.bh,g=[.6*this.bw,.7*this.bw,.8*this.bw],h="yajirin"!==this.pid?!1:2===this.puzzle.getConfig("disptype_yajilin"),i=this.range.cells,j=0;j<i.length;j++){var k=i[j],l=k.qnum,m=k.qdir,n=l>=0?""+l:h||-2!==l?"":"?",o=k.bx*this.bw,p=k.by*this.bh,q=n.length-1;if(n&&(a.fillStyle=this.getNumberColor(k)),a.vid="cell_arrow_"+k.id,n&&m!==k.NDIR){switch(a.beginPath(),m){case k.UP:a.setOffsetLinePath(o+g[q],p,0,-b,-e,-d,-c,-d,-c,b,c,b,c,-d,e,-d,!0);break;case k.DN:a.setOffsetLinePath(o+g[q],p,0,b,-e,d,-c,d,-c,-b,c,-b,c,d,e,d,!0);break;case k.LT:a.setOffsetLinePath(o,p+f,-b,0,-d,-e,-d,-c,b,-c,b,c,-d,c,-d,e,!0);break;case k.RT:a.setOffsetLinePath(o,p+f,b,0,d,-e,d,-c,-b,-c,-b,c,d,c,d,e,!0)}a.fill()}else a.vhide();if(a.vid="cell_arnum_"+k.id,n){var r={};m!==k.NDIR&&(r.globalratio=.85*this.globalfontsizeratio),m===k.UP||m===k.DN?o-=.1*this.cw:(m===k.LT||m===k.RT)&&(p+=.1*this.ch),this.disptext(n,o,p,r)}else a.vhide()}},drawCrosses:function(){var a=this.vinc("cross_base","auto",!0),b=this.cw*this.crosssize+1;a.lineWidth=1;for(var c={ratio:[.6]},d=this.range.crosses,e=0;e<d.length;e++){var f=d[e],g=f.bx*this.bw,h=f.by*this.bh;a.vid="x_cp_"+f.id,-1!==f.qnum?(a.fillStyle=1===f.error||1===f.qinfo?this.errcolor1:"white",a.strokeStyle="black",a.shapeCircle(g,h,b)):a.vhide(),a.vid="cross_text_"+f.id,f.qnum>=0?(a.fillStyle=this.fontcolor,this.disptext(""+f.qnum,g,h,c)):a.vhide()}},drawCrossMarks:function(){for(var a=this.vinc("cross_mark","auto",!0),b=this.cw*this.crosssize,c=this.range.crosses,d=0;d<c.length;d++){var e=c[d];a.vid="x_cm_"+e.id,1===e.qnum?(a.fillStyle=1===e.error||1===e.qinfo?this.errcolor1:this.quescolor,a.fillCircle(e.bx*this.bw,e.by*this.bh,b)):a.vhide()}},drawBorders:function(){this.vinc("border","crispEdges",!0),this.drawBorders_common("b_bd")},drawBorders_common:function(a){for(var b=this.context,c=this.range.borders,d=0;d<c.length;d++){var e=c[d],f=this.getBorderColor(e);if(b.vid=a+e.id,f){var g=e.bx*this.bw,h=e.by*this.bh,i=(this.lw+this.addlw)/2;b.fillStyle=f,e.isVert()?b.fillRectCenter(g,h,i,this.bh+i):b.fillRectCenter(g,h,this.bw+i,i)}else b.vhide()}},getBorderColor:function(a){var b=this.bordercolor_func||"ques";return this.getBorderColor="ques"===b?this.getBorderColor_ques:"qans"===b?this.getBorderColor_qans:"ice"===b?this.getBorderColor_ice:function(){return null},this.getBorderColor(a)},getBorderColor_ques:function(a){return a.isBorder()?this.borderQuescolor:null},getBorderColor_qans:function(a){var b=a.error||a.qinfo;return a.isBorder()?1===b?this.errcolor1:-1===b?this.errborderbgcolor:this.borderQanscolor:null},getBorderColor_ice:function(a){var b=a.sidecell[0],c=a.sidecell[1];return a.inside&&!b.isnull&&!c.isnull&&b.ice()^c.ice()?this.quescolor:null},drawQansBorders:function(){this.vinc("border_answer","crispEdges",!0),this.getBorderColor=this.getQansBorderColor,this.drawBorders_common("b_bdans")},drawQuesBorders:function(){this.vinc("border_question","crispEdges",!0),this.getBorderColor=this.getQuesBorderColor,this.drawBorders_common("b_bdques")},getQuesBorderColor:function(a){return 1===a.ques?this.borderQuescolor:null},getQansBorderColor:function(a){return 1===a.qans?this.borderQanscolor:null},drawBorderQsubs:function(){var a=this.vinc("border_qsub","crispEdges",!0);a.fillStyle=this.borderQsubcolor;for(var b=.15*this.cw,c=this.range.borders,d=0;d<c.length;d++){var e=c[d];if(a.vid="b_qsub1_"+e.id,1===e.qsub){var f=e.bx*this.bw,g=e.by*this.bh;e.isHorz()?a.fillRectCenter(f,g,.5,this.bh-b):a.fillRectCenter(f,g,this.bw-b,.5)}else a.vhide()}},drawBoxBorders:function(a){var b=this.vinc("boxborder","crispEdges"),c=this.lm,d=this.cw,e=this.ch;b.strokeStyle=this.bbcolor,b.lineWidth=1;for(var f=this.range.cells,g=0;g<f.length;g++){var h=f[g];if(b.vid="c_bb_"+h.id,1===h.qans){var i=(h.bx-1)*this.bw,j=(h.by-1)*this.bh,k=i-.5,l=i+c+.5,m=i+d-c-.5,n=i+d+.5,o=j-.5,p=j+c+.5,q=j+e-c-.5,r=j+e+.5,s=h.adjborder,t=h.by>2,u=h.by<2*this.board.rows-2,v=h.bx>2,w=h.bx<2*this.board.cols-2,x=!t||1===s.top.ques,y=!u||1===s.bottom.ques,z=!v||1===s.left.ques,A=!w||1===s.right.ques,B=!t||!v||1===h.relbd(-2,-1).ques||1===h.relbd(-1,-2).ques,C=!t||!w||1===h.relbd(2,-1).ques||1===h.relbd(1,-2).ques,D=!u||!v||1===h.relbd(-2,1).ques||1===h.relbd(-1,2).ques,E=!u||!w||1===h.relbd(2,1).ques||1===h.relbd(1,2).ques;b.beginPath(),(x||B)&&b.moveTo(l,p),!x&&B&&b.lineTo(l,o),!x&&C&&b.moveTo(m,o),x||C?b.lineTo(m,p):(A||C)&&b.moveTo(m,p),!A&&C&&b.lineTo(n,p),!A&&E&&b.moveTo(n,q),A||E?b.lineTo(m,q):(y||E)&&b.moveTo(m,q),!y&&E&&b.lineTo(m,r),!y&&D&&b.moveTo(l,r),y||D?b.lineTo(l,q):(z||D)&&b.moveTo(l,q),!z&&D&&b.lineTo(k,q),!z&&B&&b.moveTo(k,p),(z||B)&&b.lineTo(l,p),b.stroke()}else b.vhide()}},drawLines:function(){for(var a=this.vinc("line","crispEdges",!0),b=this.range.borders,c=0;c<b.length;c++){var d=b[c],e=this.getLineColor(d);if(a.vid="b_line_"+d.id,e){var f=d.bx*this.bw,g=d.by*this.bh,h=this.board.borderAsLine===d.isVert(),i=this.lm+this.addlw/2;a.fillStyle=e,h?a.fillRectCenter(f,g,i,this.bh+1):a.fillRectCenter(f,g,this.bw+1,i)}else a.vhide()}this.addlw=0},getLineColor:function(a){if(this.addlw=0,a.isLine()){var b=a.error||a.qinfo,c=this.puzzle;return 1===b?(this.addlw=1,this.errlinecolor):-1===b?this.errlinebgcolor:c.execConfig("dispmove")?this.movelinecolor:c.execConfig("irowake")&&a.path&&a.path.color?a.path.color:this.linecolor}return null},drawTip:function(){for(var a=this.vinc("cell_linetip","auto"),b=.3*this.cw,c=.05*this.cw,d=this.range.cells,e=0;e<d.length;e++){var f=d[e],g=0,h=null;if(1===f.lcnt&&-1===f.qnum&&!this.puzzle.execConfig("dispmove")){var i=f.adjborder;i.top.isLine()?(g=2,h=i.top):i.bottom.isLine()?(g=1,h=i.bottom):i.left.isLine()?(g=4,h=i.left):i.right.isLine()&&(g=3,h=i.right)}if(a.vid="c_tip_"+f.id,0!==g){a.lineWidth=this.lw;var j=h.error||h.qinfo;1===j?(a.strokeStyle=this.errlinecolor,a.lineWidth=a.lineWidth+1):-1===j?a.strokeStyle=this.errlinebgcolor:a.strokeStyle=this.linecolor,a.beginPath();var k=f.bx*this.bw+1,l=f.by*this.bh+1;1===g?a.setOffsetLinePath(k,l,-b,b,0,-c,b,b,!1):2===g?a.setOffsetLinePath(k,l,-b,-b,0,c,b,-b,!1):3===g?a.setOffsetLinePath(k,l,b,-b,-c,0,b,b,!1):4===g&&a.setOffsetLinePath(k,l,-b,-b,c,0,-b,b,!1),a.stroke()}else a.vhide()}},drawPekes:function(){var a=this.vinc("border_peke","auto",!0),b=.15*this.cw+1;4>b&&(b=4),a.lineWidth=1+this.cw/40|0,a.strokeStyle=this.pekecolor;for(var c=this.range.borders,d=0;d<c.length;d++){var e=c[d];a.vid="b_peke_"+e.id,2===e.qsub?a.strokeCross(e.bx*this.bw,e.by*this.bh,b-1):a.vhide()}},drawBaseMarks:function(){var a=this.vinc("cross_mark","auto",!0);a.fillStyle=this.quescolor;for(var b=this.range.crosses,c=0;c<b.length;c++){var d=b[c];a.vid="x_cm_"+d.id,a.fillCircle(d.bx*this.bw,d.by*this.bh,1.2*this.lw/2)}},drawTriangle:function(){for(var a=this.vinc("cell_triangle","auto"),b=this.range.cells,c=0;c<b.length;c++){var d=b[c],e=0!==d.ques?d.ques:d.qans;a.vid="c_tri_"+d.id,e>=2&&5>=e?(a.fillStyle=this.getTriangleColor(d),this.drawTriangle1(d.bx*this.bw,d.by*this.bh,e)):a.vhide()}},getTriangleColor:function(a){return this.quescolor},drawTriangle1:function(a,b,c){var d=this.context,e="reflect"===this.pid?1:0,f=this.bw+1-e,g=this.bh+1-e;switch(d.beginPath(),c){case 2:d.setOffsetLinePath(a,b,-f,-g,-f,g,f,g,!0);break;case 3:d.setOffsetLinePath(a,b,f,-g,-f,g,f,g,!0);break;case 4:d.setOffsetLinePath(a,b,-f,-g,f,-g,f,g,!0);break;case 5:d.setOffsetLinePath(a,b,-f,-g,f,-g,-f,g,!0)}d.fill()},drawMBs:function(){var a=this.vinc("cell_mb","auto",!0);a.lineWidth=1,a.strokeStyle=this.mbcolor;for(var b=.35*this.cw,c=this.range.cells,d=0;d<c.length;d++){var e,f,g=c[d];g.qsub>0&&(e=g.bx*this.bw,f=g.by*this.bh),a.vid="c_MB1_"+g.id,1===g.qsub?a.strokeCircle(e,f,b):a.vhide(),a.vid="c_MB2_"+g.id,2===g.qsub?a.strokeCross(e,f,b):a.vhide()}},drawCircles:function(){var a=this.vinc("cell_circle","auto",!0),b=this.circleratio,c=this.cw*(b[0]+b[1])/2,d=this.cw*b[0];"loopsp"===this.pid&&(d-=.1*this.cw);for(var e=this.range.cells,f=0;f<e.length;f++){var g=e[f],h=this.getCircleFillColor(g);a.vid="c_cirb_"+g.id,h?(a.fillStyle=h,a.fillCircle(g.bx*this.bw,g.by*this.bh,d)):a.vhide()}a=this.vinc("cell_circle_stroke","auto",!0),a.lineWidth=Math.max(this.cw*(b[0]-b[1]),1);for(var f=0;f<e.length;f++){var g=e[f],h=this.getCircleStrokeColor(g);a.vid="c_cira_"+g.id,h?(a.strokeStyle=h,a.strokeCircle(g.bx*this.bw,g.by*this.bh,c)):a.vhide()}},getCircleStrokeColor:function(a){var b=this.circlestrokecolor_func||"qnum";return this.getCircleStrokeColor="qnum"===b?this.getCircleStrokeColor_qnum:"qnum2"===b?this.getCircleStrokeColor_qnum2:function(){return null},this.getCircleStrokeColor(a)},getCircleStrokeColor_qnum:function(a){var b=this.puzzle,c=a.error||a.qinfo,d=b.execConfig("dispmove"),e=(d?a.base:a).qnum;return-1!==e?d&&b.mouse.mouseCell===a?this.movecolor:1===c||4===c?this.errcolor1:this.quescolor:null},getCircleStrokeColor_qnum2:function(a){return 1===a.qnum?1===a.error?this.errcolor1:this.quescolor:null},getCircleFillColor:function(a){var b=this.circlefillcolor_func||"qnum";return this.getCircleFillColor="qnum"===b?this.getCircleFillColor_qnum:"qnum2"===b?this.getCircleFillColor_qnum2:"qcmp"===b?this.getCircleFillColor_qcmp:function(){return null},this.getCircleFillColor(a)},getCircleFillColor_qnum:function(a){if(-1!==a.qnum){var b=a.error||a.qinfo;return 1===b||4===b?this.errbcolor1:this.circledcolor}return null},getCircleFillColor_qnum2:function(a){return 1===a.qnum?1===a.error?this.errbcolor1:"white":2===a.qnum?1===a.error?this.errcolor1:this.quescolor:null},getCircleFillColor_qcmp:function(a){var b=this.puzzle,c=a.error||a.qinfo,d=b.execConfig("dispmove"),e=(d?a.base:a).qnum;return-1!==e?1===c||4===c?this.errbcolor1:b.execConfig("autocmp")&&a.isCmp()?this.qcmpcolor:this.circledcolor:null},drawDepartures:function(){var a=this.vinc("cell_depart","auto",!0);a.fillStyle=this.movelinecolor;for(var b=.15*this.cw,c=this.puzzle.execConfig("dispmove"),d=this.range.cells,e=0;e<d.length;e++){var f=d[e];if(a.vid="c_dcir_"+f.id,c&&f.isDeparture()){var g=f.bx*this.bw,h=f.by*this.bh;a.fillCircle(g,h,b)}else a.vhide()}},drawLineParts:function(){var a=this.vinc("cell_lineparts","crispEdges");a.fillStyle=this.borderQuescolor;for(var b=this.lm,c=this.bw,d=this.bh,e=this.range.cells,f=0;f<e.length;f++){var g=e[f],h=g.ques;if(a.vid="c_lp_"+g.id,h>=11&&17>=h){var i=g.bx*this.bw,j=g.by*this.bh,k=i-c-.5,l=i-b,m=i+b,n=i+c+.5,o=j-d-.5,p=j-b,q=j+b,r=j+d+.5,s={11:15,12:3,13:12,14:9,15:5,16:6,17:10}[h];a.beginPath(),a.moveTo(l,p),1&s&&(a.lineTo(l,o),a.lineTo(m,o)),a.lineTo(m,p),8&s&&(a.lineTo(n,p),a.lineTo(n,q)),a.lineTo(m,q),2&s&&(a.lineTo(m,r),a.lineTo(l,r)),a.lineTo(l,q),4&s&&(a.lineTo(k,q),a.lineTo(k,p)),a.closePath(),a.fill()}else a.vhide()}},drawTateyokos:function(){for(var a=this.vinc("cell_tateyoko","crispEdges",!0),b=Math.max(this.cw/6,3)/2,c=this.range.cells,d=0;d<c.length;d++){var e=c[d],f=e.bx*this.bw,g=e.by*this.bh,h=e.qans;a.vid="c_bar1_"+e.id,11===h||12===h?(a.fillStyle=this.getBarColor(e,!0),a.fillRectCenter(f,g,b+this.addlw/2,this.bh)):a.vhide(),a.vid="c_bar2_"+e.id,11===h||13===h?(a.fillStyle=this.getBarColor(e,!1),a.fillRectCenter(f,g,this.bw,b+this.addlw/2)):a.vhide()}this.addlw=0},getBarColor:function(a,b){var c=a.error,d="";return this.addlw=0,1===c||4===c||5===c&&b||6===c&&!b?(d=this.errlinecolor,this.addlw=1):d=0!==c?this.errlinebgcolor:this.linecolor,d},drawQues51:function(){this.drawEXCellGrid(),this.drawSlash51Cells(),this.drawSlash51EXcells(),this.drawTargetTriangle()},drawSlash51Cells:function(){var a=this.vinc("cell_ques51","crispEdges",!0);a.strokeStyle=this.quescolor,a.lineWidth=1;for(var b=this.range.cells,c=0;c<b.length;c++){var d=b[c];if(a.vid="c_slash51_"+d.id,51===d.ques){var e=d.bx*this.bw,f=d.by*this.bh;a.strokeLine(e-this.bw,f-this.bh,e+this.bw,f+this.bh)}else a.vhide()}},drawSlash51EXcells:function(){var a=this.vinc("excell_ques51","crispEdges",!0);a.strokeStyle=this.quescolor,a.lineWidth=1;for(var b=this.range.excells,c=0;c<b.length;c++){var d=b[c],e=d.bx*this.bw,f=d.by*this.bh;a.vid="ex_slash51_"+d.id,a.strokeLine(e-this.bw,f-this.bh,e+this.bw,f+this.bh)}},drawEXCellGrid:function(){var a=this.vinc("grid_excell","crispEdges",!0);a.fillStyle=this.quescolor;for(var b=this.range.excells,c=0;c<b.length;c++){var d=b[c],e=d.bx*this.bw,f=d.by*this.bh;a.vid="ex_bdx_"+d.id,-1===d.by&&d.bx<this.board.maxbx?a.fillRectCenter(e+this.bw,f,.5,this.bh):a.vhide(),a.vid="ex_bdy_"+d.id,-1===d.bx&&d.by<this.board.maxby?a.fillRectCenter(e,f+this.bh,this.bw,.5):a.vhide()}},drawNumbersOn51:function(){this.vinc("cell_number51","auto");for(var a=this.range,b=1|a.x1;b<=a.x2;b+=2)for(var c=1|a.y1;c<=a.y2;c+=2){var d=this.board.getobj(b,c);d.isnull||this.drawNumbersOn51_1(d)}},drawNumbersOn51_1:function(a){var b,c,d=this.context,e=a.bx*this.bw,f=a.by*this.bh,g={ratio:[.45]};d.fillStyle=1===a.error||1===a.qinfo?this.fontErrcolor:this.fontcolor,c=a.relcell(2,0),b=51===a.ques?a.qnum:-1,d.vid=[a.group,a.id,"text_ques51_rt"].join("_"),b>=0&&!c.isnull&&51!==c.ques?(g.position=this.TOPRIGHT,this.disptext(""+b,e,f,g)):d.vhide(),c=a.relcell(0,2),b=51===a.ques?a.qnum2:-1,d.vid=[a.group,a.id,"text_ques51_dn"].join("_"),b>=0&&!c.isnull&&51!==c.ques?(g.position=this.BOTTOMLEFT,this.disptext(""+b,e,f,g)):d.vhide()},drawTarget:function(){this.drawCursor(!0,this.puzzle.editmode)},drawCursor:function(a,b){var c=this.vinc("target_cursor","crispEdges"),d=this.range,e=this.puzzle.cursor;if(!(e.bx<d.x1-1||d.x2+1<e.bx||e.by<d.y1-1||d.y2+1<e.by)){var f,g,h=e.bx*this.bw,i=e.by*this.bh;a!==!1?(f=0|Math.max(this.cw/16,2),g=this.bw-.5):(f=0|Math.max(this.cw/24,1),g=.56*this.bw),b=b!==!1&&this.puzzle.getConfig("cursor")&&!this.outputImage,c.fillStyle=this.puzzle.editmode?this.targetColor1:this.targetColor3,c.vid="ti1_",b?c.fillRect(h-g,i-g,2*g,f):c.vhide(),c.vid="ti2_",b?c.fillRect(h-g,i-g,f,2*g):c.vhide(),c.vid="ti3_",b?c.fillRect(h-g,i+g-f,2*g,f):c.vhide(),c.vid="ti4_",b?c.fillRect(h+g-f,i-g,f,2*g):c.vhide()}},drawTargetTriangle:function(){var a=this.vinc("target_triangle","auto"),b=this.range,c=this.puzzle.cursor;if(!(c.bx<b.x1||b.x2<c.bx||c.by<b.y1||b.y2<c.by)){var d=c.detectTarget(c.getobj());a.vid="target_triangle",a.fillStyle=this.ttcolor,this.puzzle.editmode&&0!==d?this.drawTriangle1(c.bx*this.bw,c.by*this.bh,2===d?4:2):a.vhide()}},drawDashedCenterLines:function(){var a=this.vinc("centerline","crispEdges",!0),b=this.board,c=this.range.x1,d=this.range.y1,e=this.range.x2,f=this.range.y2;c<b.minbx+1&&(c=b.minbx+1),e>b.maxbx-1&&(e=b.maxbx-1),d<b.minby+1&&(d=b.minby+1),f>b.maxby-1&&(f=b.maxby-1),c-=1&~c,d-=1&~d,e+=1&~e,f+=1&~f;var g=0|Math.max(this.cw/(this.cw/10+3),1),h=this.cw/(2*g);a.lineWidth=1,a.strokeStyle=this.gridcolor;for(var i=c;e>=i;i+=2){var j=i*this.bw,k=d*this.bh,l=f*this.bh;a.vid="cliney_"+i,a.strokeDashedLine(j,k,j,l,[h])}for(var i=d;f>=i;i+=2){var m=i*this.bh,n=c*this.bw,o=e*this.bw;a.vid="clinex_"+i,a.strokeDashedLine(n,m,o,m,[h])}},drawGrid:function(a,b){var c=this.vinc("grid","crispEdges",!0),d=this.board,e=this.range.x1,f=this.range.y1,g=this.range.x2,h=this.range.y2;0>e&&(e=0),g>2*d.cols&&(g=2*d.cols),0>f&&(f=0),h>2*d.rows&&(h=2*d.rows),e-=1&e,f-=1&f;var i=2!==d.hasborder&&a!==!1?2:0,j=this.bw,k=this.bh,l=Math.max(e,0+i),m=Math.min(g,2*d.cols-i),n=Math.max(f,0+i),o=Math.min(h,2*d.rows-i);c.lineWidth=1,c.strokeStyle=this.gridcolor;for(var p=l;m>=p;p+=2)if(c.vid="bdy_"+p,b!==!1){var q=p*j,r=f*k,s=h*k;c.strokeLine(q,r,q,s)}else c.vhide();for(var p=n;o>=p;p+=2)if(c.vid="bdx_"+p,b!==!1){var t=p*k,u=e*j,v=g*j;c.strokeLine(u,t,v,t)}else c.vhide()},drawDashedGrid:function(a){var b=this.vinc("grid","crispEdges",!0),c=this.board,d=this.range.x1,e=this.range.y1,f=this.range.x2,g=this.range.y2;0>d&&(d=0),f>2*c.cols&&(f=2*c.cols),0>e&&(e=0),g>2*c.rows&&(g=2*c.rows),d-=1&d,e-=1&e,f+=1&f,g+=1&g;var h=0|Math.max(this.cw/(this.cw/10+3),1),i=this.cw/(2*h),j=a!==!1?2:0,k=this.bw,l=this.bh,m=Math.max(d,c.minbx+j),n=Math.min(f,c.maxbx-j),o=Math.max(e,c.minby+j),p=Math.min(g,c.maxby-j);b.lineWidth=1,b.strokeStyle=this.gridcolor;for(var q=m;n>=q;q+=2){var r=q*k,s=e*l,t=g*l;b.vid="bdy_"+q,b.strokeDashedLine(r,s,r,t,[i])}for(var q=o;p>=q;q+=2){var u=q*l,v=d*k,w=f*k;b.vid="bdx_"+q,b.strokeDashedLine(v,u,w,u,[i])}},drawChassis:function(){var a=this.vinc("chassis","crispEdges",!0),b=this.board,c=this.range.x1,d=this.range.y1,e=this.range.x2,f=this.range.y2;0>c&&(c=0),e>2*b.cols&&(e=2*b.cols),0>d&&(d=0),f>2*b.rows&&(f=2*b.rows);var g="bosanowa"!==this.pid?this.lw:1,h=b.cols*this.cw,i=b.rows*this.ch;a.fillStyle="black",a.vid="chs1_",a.fillRect(-(g-.5),-(g-.5),g,i+2*g-2),a.vid="chs2_",a.fillRect(h-.5,-(g-.5),g,i+2*g-2),a.vid="chs3_",a.fillRect(-(g-.5),-(g-.5),h+2*g-2,g),a.vid="chs4_",a.fillRect(-(g-.5),i-.5,h+2*g-2,g)},drawChassis_ex1:function(a){var b=this.vinc("chassis_ex1","crispEdges",!0),c=this.board,d=this.range.x1,e=this.range.y1,f=this.range.x2,g=this.range.y2;0>=d&&(d=c.minbx),f>c.maxbx&&(f=c.maxbx),0>=e&&(e=c.minby),g>c.maxby&&(g=c.maxby);var h=this.lw,i=this.lm,j=c.cols*this.cw,k=c.rows*this.ch;if(b.fillStyle="black",b.vid="chsex1_1_",b.fillRect(-this.cw-(h-.5),-this.ch-(h-.5),h,k+this.ch+2*h-2),b.vid="chsex1_2_",b.fillRect(j-.5,-this.ch-(h-.5),h,k+this.ch+2*h-2),b.vid="chsex1_3_",b.fillRect(-this.cw-(h-.5),-this.ch-(h-.5),j+this.cw+2*h-2,h),b.vid="chsex1_4_",b.fillRect(-this.cw-(h-.5),k-.5,j+this.cw+2*h-2,h),a)b.vid="chs1_",b.fillRect(-(h-.5),-(h-.5),h,k+h-1),b.vid="chs2_",b.fillRect(-(h-.5),-(h-.5),j+h-1,h);else{b.vid="chs1_",b.fillRect(-.5,-.5,1,k),b.vid="chs2_",b.fillRect(-.5,-.5,j,1);for(var l=this.range.cells,m=0;m<l.length;m++){var n=l[m],o=(n.bx-1)*this.bw,p=(n.by-1)*this.bh;1===n.bx&&(b.vid="chs1_sub_"+n.by,51!==n.ques?b.fillRect(-i-.5,p-i-.5,h,this.ch+h):b.vhide()),1===n.by&&(b.vid="chs2_sub_"+n.bx,51!==n.ques?b.fillRect(o-i-.5,-i-.5,this.cw+h,h):b.vhide())}}}}}),a.classmgr.makeCommon({KeyEvent:{key_inputcross:function(a){var b=this.cursor.getx(),c=b.getmaxnum(),d=-1;if(a>="0"&&"9">=a){var e=+a,f=b.qnum;if((0>=f||10*f+e>c)&&(f=0),d=10*f+e,d>c)return}else if("-"===a)b.setQnum(-2!==b.qnum?-2:-1);else{if(" "!==a)return;b.setQnum(-1)}b.setQnum(d),b.draw()},key_inputqnum:function(a){var b=this.cursor.getc(),c=b,d=this.puzzle,e=d.board;if(d.editmode&&e.roommgr.hastop)c=b=b.room.top;else if(d.execConfig("dispmove"))if(b.isDestination())b=b.base;else if(b.lcnt>0)return;this.key_inputqnum_main(b,a)&&(this.prev=b,d.execConfig("dispmove")&&b.noNum()&&b.eraseMovedLines(),c.draw())},key_inputqnum_main:function(a,b){var c=a.getmaxnum(),d=a.getminnum(),e=-1;if(b>="0"&&"9">=b){var f=+b,g=a.getNum();if((0>=g||10*g+f>c||this.prev!==a)&&(g=0),e=10*g+f,e>c||d>0&&0===e)return!1}else if("BS"===b){var f=a.getNum();e=10>f?-1:f/10|0}else if("-"===b)e=this.puzzle.editmode&&!a.disInputHatena?-2:-1;else if(" "===b)e=-1;else if("s1"===b)e=-2;else{if("s2"!==b)return!1;e=-3}return a.setNum(e),!0},key_inputarrow:function(a){return this.key_inputdirec_common(a,!1)},key_inputdirec:function(a){return this.key_inputdirec_common(a,!0)},key_inputdirec_common:function(a,b){var c=this.cursor.getc();if(b&&-1===c.qnum)return!1;var d=c.NDIR;switch(a){case"shift+up":d=c.UP;break;case"shift+down":d=c.DN;break;case"shift+left":d=c.LT;break;case"shift+right":d=c.RT}return d!==c.NDIR?(c.setQdir(c.qdir!==d?d:c.NDIR),b||c.setQnum(-1),this.cursor.draw(),!0):!1},inputnumber51:function(a,b){var c=this.cursor;if("shift"===a)return void c.chtarget();var d=c.getobj(),e=c.detectTarget(d);if((0===e||"cell"===d.group&&d.is51cell())&&"q"===a&&!d.isnull)return d.is51cell()?d.remove51cell():d.set51cell(),void c.drawaround();if(0!==e){var f=this.klass.Cell.prototype[2===e?"qnum":"qnum2"],g=b[e],h=f;if(a>="0"&&"9">=a){var i=+a,j=this.getnum51(d,e);if((0>=j||10*j+i>g||this.prev!==d)&&(j=0),h=10*j+i,h>g)return}else{if("-"!==a&&" "!==a)return;h=f}this.setnum51(d,e,h),this.prev=d,c.draw()}},setnum51:function(a,b,c){2===b?a.setQnum(c):a.setQnum2(c)},getnum51:function(a,b){return 2===b?a.qnum:a.qnum2}}}),a.classmgr.makeCommon({MouseEvent:{inputcell:function(){var a=this.getcell();if(!a.isnull&&a!==this.mouseCell&&(null===this.inputData&&this.decIC(a),this.mouseCell=a,!a.numberRemainsUnshaded||-1===a.qnum||1!==this.inputData&&(2!==this.inputData||"white"!==this.puzzle.painter.bcolor))){if(this.RBShadeCell&&1===this.inputData){this.firstCell.isnull&&(this.firstCell=a);var b=this.firstCell;if((2&b.bx^2&b.by)!==(2&a.bx^2&a.by))return}(1===this.inputData?a.setShade:a.clrShade).call(a),a.setQsub(2===this.inputData?1:0),a.draw()}},decIC:function(a){1===this.puzzle.getConfig("use")?"left"===this.btn?this.inputData=a.isUnshade()?1:0:"right"===this.btn&&(this.inputData=1!==a.qsub?2:0):2===this.puzzle.getConfig("use")&&(a.numberRemainsUnshaded&&-1!==a.qnum?this.inputData=1!==a.qsub?2:0:"left"===this.btn?a.isShade()?this.inputData=2:1===a.qsub?this.inputData=0:this.inputData=1:"right"===this.btn&&(a.isShade()?this.inputData=0:1===a.qsub?this.inputData=1:this.inputData=2))},inputqnum:function(){var a=this.getcell();a.isnull||a===this.mouseCell||(a!==this.cursor.getc()?this.setcursor(a):this.inputqnum_main(a),this.mouseCell=a)},inputqnum_main:function(a){var b=a,c=this.puzzle,d=c.board;if(c.editmode&&d.roommgr.hastop)b=a=a.room.top;else if(c.execConfig("dispmove"))if(a.isDestination())a=a.base;else if(a.lcnt>0)return;var e=0;if(c.editmode?e=-1:a.numberWithMB?e=2:a.numberAsObject&&(e=1),"roma"===c.pid&&c.playmode&&(e=0),!c.playmode||a.qnum===c.klass.Cell.prototype.qnum){var f=a.getmaxnum(),g=a.getminnum(),h=a.getNum(),i=c.editmode?0:a.qsub,j=-1,k=c.editmode&&!a.disInputHatena;"left"===this.btn?j=h>=f?e>=1?-2:-1:1===i?e>=2?-3:-1:2===i?-1:-1===h?k?-2:g:g>h?g:h+1:"right"===this.btn&&(j=1===i?f:2===i?-2:-1===h?1===e?-2:2===e?-3:f:h>f?f:g>=h?k?-2:-1:-2===h?-1:h-1),a.setNum(j),c.execConfig("dispmove")&&a.noNum()&&a.eraseMovedLines(),b.draw()}},inputQues:function(a){var b=this.getcell();b.isnull||(b!==this.cursor.getc()?this.setcursor(b):this.inputQues_main(a,b))},inputQues_main:function(a,b){var c=b.ques,d=a.length;if("left"===this.btn){for(var e=0;d-1>=e;e++)if(c===a[e]){b.setQues(a[d-1>e?e+1:0]);break}}else if("right"===this.btn)for(var e=d-1;e>=0;e--)if(c===a[e]){b.setQues(a[e>0?e-1:d-1]);break}b.draw()},inputMB:function(){var a=this.getcell();a.isnull||(a.setQsub(("left"===this.btn?[1,2,0]:[2,0,1])[a.qsub]),a.draw())},inputdirec:function(){var a=this.getpos(0);if(!this.prevPos.equals(a)){var b=this.prevPos.getc();if(!b.isnull&&-1!==b.qnum){var c=this.prevPos.getdir(a,2);c!==b.NDIR&&(b.setQdir(b.qdir!==c?c:0),b.draw())}this.prevPos=a}},inputarrow_cell:function(){var a=this.getpos(0);if(!this.prevPos.equals(a)||1!==this.inputData){var b=a.NDIR,c=this.prevPos.getc();if(!c.isnull){var b=this.prevPos.getdir(a,2);if(b!==a.NDIR)return this.inputarrow_cell_main(c,b),c.draw(),void this.mousereset()}this.prevPos=a}},inputarrow_cell_main:function(a,b){a.numberAsObject&&a.setNum(b)},inputtile:function(){var a=this.getcell();if(!a.isnull&&!a.is51cell()&&a!==this.mouseCell){null===this.inputData&&this.decIC(a),this.mouseCell=a;for(var b=a.room.clist,c=0;c<b.length;c++){var d=b[c];(1===this.inputData||3!==d.qsub)&&((1===this.inputData?d.setShade:d.clrShade).call(d),d.setQsub(2===this.inputData?1:0))}b.draw()}},input51:function(){var a=this.getcell_excell();if(!a.isnull){var b=a.group;"excell"===b||"cell"===b&&a!==this.cursor.getc()?this.setcursor(a):"cell"===b&&this.input51_main(a)}},input51_main:function(a){"left"===this.btn?a.is51cell()?this.cursor.chtarget():a.set51cell():"right"===this.btn&&a.remove51cell(),a.drawaround()},inputcross:function(){var a=this.getcross();a.isnull||a===this.mouseCell||(a!==this.cursor.getx()?this.setcursor(a):this.inputcross_main(a),this.mouseCell=a)},inputcross_main:function(a){"left"===this.btn?a.setQnum(4!==a.qnum?a.qnum+1:-2):"right"===this.btn&&a.setQnum(-2!==a.qnum?a.qnum-1:4),a.draw()},inputcrossMark:function(){var a=this.getpos(.24);if(a.oncross()){var b=this.board,c=2===b.hascross?0:2;if(!(a.bx<b.minbx+c||a.bx>b.maxbx-c||a.by<b.minby+c||a.by>b.maxby-c)){var d=a.getx();d.isnull||(this.puzzle.opemgr.disCombine=!0,d.setQnum(1===d.qnum?-1:1),this.puzzle.opemgr.disCombine=!1,d.draw())}}},inputborder:function(){var a=this.getpos(.35);if(!this.prevPos.equals(a)){var b=this.prevPos.getborderobj(a);b.isnull||(null===this.inputData&&(this.inputData=b.isBorder()?0:1),1===this.inputData?b.setBorder():0===this.inputData&&b.removeBorder(),b.draw()),this.prevPos=a}},inputQsubLine:function(){var a=this.getpos(0);if(!this.prevPos.equals(a)){var b=this.prevPos.getnb(a);b.isnull||(null===this.inputData&&(this.inputData=0===b.qsub?1:0),1===this.inputData?b.setQsub(1):0===this.inputData&&b.setQsub(0),b.draw()),this.prevPos=a}},inputLine:function(){var a,b;if(this.board.borderAsLine){if(a=this.getpos(.35),this.prevPos.equals(a))return;b=this.prevPos.getborderobj(a)}else{if(a=this.getpos(0),this.prevPos.equals(a))return;b=this.prevPos.getnb(a)}b.isnull||(null===this.inputData&&(this.inputData=b.isLine()?0:1),1===this.inputData?b.setLine():0===this.inputData&&b.removeLine(),b.draw()),this.prevPos=a},inputMoveLine:function(){
if(!this.puzzle.execConfig("dispmove"))return void this.inputLine();var a=this.getcell();if(!a.isnull){var b=this.mouseCell,c=a.getaddr();if(this.mousestart&&a.isDestination())this.mouseCell=a,this.prevPos=c,a.draw();else if(this.mousemove&&!b.isnull&&!a.isDestination()){var d=this.prevPos.getnb(c);!d.isnull&&(!d.isLine()&&0===a.lcnt||d.isLine()&&1===b.lcnt)&&(this.mouseCell=a,this.prevPos=c,d.isLine()?d.removeLine():d.setLine(),d.draw())}}},inputpeke:function(){var a=this.getpos(.22);if(!this.prevPos.equals(a)){var b=a.getb();b.isnull||(null===this.inputData&&(this.inputData=0===b.qsub?2:3),2===this.inputData&&b.isLine()&&this.puzzle.execConfig("dispmove")||(2===this.inputData?b.setPeke():3===this.inputData&&b.removeLine()),b.draw()),this.prevPos=a}},inputTateyoko:function(){var a=this.getcell();if(!a.isnull){var b="amibo"===this.pid;if(b||1!==a.ques){if(b&&a.isNum());else if(this.mouseCell!==a)this.firstPoint.set(this.inputPoint);else if(null!==this.firstPoint.bx){var c=null,d=this.inputPoint.bx-this.firstPoint.bx,e=this.inputPoint.by-this.firstPoint.by;if(-.5>=e||e>=.5?c=1:(-.5>=d||d>=.5)&&(c=2),null!==c){var f={0:0,11:3,12:1,13:2}[a.qans];(null===this.inputData?f&c:this.inputData<=0)&&(c=b?-c:0),b?c>0?f|=c:f&=~-c:f=c,a.setQans([0,12,13,11][f]),a.draw(),this.inputData=+(c>0),this.firstPoint.reset()}}}else;this.mouseCell=a}},dispRedBlk:function(){var a=this.getcell();this.mousereset(),!a.isnull&&a.isShade()&&(this.RBShadeCell?this.dispRedBlk8(a):a.sblk.clist.setinfo(1),this.board.haserror=!0,this.puzzle.redraw())},dispRedBlk8:function(a){for(var b=[a];b.length>0;){var c=b.pop();if(0===c.qinfo){c.setinfo(1);for(var d=c.bx,e=c.by,f=this.board.cellinside(d-2,e-2,d+2,e+2),g=0;g<f.length;g++){var h=f[g];0===h.qinfo&&h.isShade()&&b.push(h)}}}},dispRedLine:function(){var a=this.board,b=this.getborder(.15);if(this.mousereset(),!b.isnull){if(!b.isLine()){var c=a.borderAsLine?this.getcross():this.getcell();if(c.isnull||a.linegraph.isLineCross&&(3===c.lcnt||4===c.lcnt))return;var d=c.adjborder;if(d.left.isLine())b=d.left;else if(d.right.isLine())b=d.right;else if(d.top.isLine())b=d.top;else{if(!d.bottom.isLine())return;b=d.bottom}}b.isnull||(a.border.setinfo(-1),b.path.setedgeinfo(1),a.haserror=!0,this.puzzle.redraw())}}}}),a.classmgr.makeCommon({AnsCheck:{checkAllCell:function(a,b){for(var c=0;c<this.board.cell.length;c++){var d=this.board.cell[c];if(a(d)){if(this.failcode.add(b),this.checkOnly)break;d.seterr(1)}}},checkNoNumCell:function(){this.checkAllCell(function(a){return 0===a.ques&&a.noNum()},"ceNoNum")},checkIceLines:function(){this.checkAllCell(function(a){return a.ice()&&a.isLineCurve()},"lnCurveOnIce")},checkNotCrossOnMark:function(){this.checkAllCell(function(a){return 4!==a.lcnt&&11===a.ques},"lnNotCrossMk")},checkLineOnShadeCell:function(){this.checkAllCell(function(a){return(1===a.ques||1===a.qans)&&a.lcnt>0},"lnOnShade")},checkNoLineObject:function(){this.checkAllCell(function(a){return 0===a.lcnt&&a.isNum()},"nmNoLine")},checkLineOverLetter:function(){this.checkAllCell(function(a){return a.lcnt>=2&&a.isNum()},this.board.linegraph.moveline?"laOnNum":"lcOnNum")},checkDir4Cell:function(a,b,c){for(var d=0;d<this.board.cell.length;d++){var e=this.board.cell[d];if(e.isValidNum()){var f=e.getNum(),g=e.countDir4Cell(a);if(!(0===b&&f===g||1===b&&g>=f||2===b&&f>=g)){if(this.failcode.add(c),this.checkOnly)break;e.seterr(1)}}}},checkSideCell:function(a,b){for(var c=!0,d=this.board,e=0;e<d.cell.length;e++){var f=d.cell[e],g=f.adjacent.right;if(f.bx<d.maxbx-1&&a(f,g)){if(c=!1,this.checkOnly)break;f.seterr(1),g.seterr(1)}if(g=f.adjacent.bottom,f.by<d.maxby-1&&a(f,g)){if(c=!1,this.checkOnly)break;f.seterr(1),g.seterr(1)}}c||this.failcode.add(b)},checkAdjacentShadeCell:function(){this.checkSideCell(function(a,b){return a.isShade()&&b.isShade()},"csAdjacent")},checkAdjacentDiffNumber:function(){this.checkSideCell(function(a,b){return a.sameNumber(b)},"nmAdjacent")},check2x2Block:function(a,b){for(var c=this.board,d=0;d<c.cell.length;d++){var e=c.cell[d];if(!(e.bx>=c.maxbx-1||e.by>=c.maxby-1)){var f=e.bx,g=e.by,h=c.cellinside(f,g,f+2,g+2).filter(a);if(!(h.length<4)){if(this.failcode.add(b),this.checkOnly)break;h.seterr(1)}}}},check2x2ShadeCell:function(){this.check2x2Block(function(a){return a.isShade()},"cs2x2")},checkSameColorTile:function(){this.checkSameObjectInRoom(this.board.roommgr,function(a){return a.isShade()?1:2},"bkMixed")},checkConnectShade:function(){this.checkOneArea(this.board.sblkmgr,"csDivide")},checkConnectUnshade:function(){this.checkOneArea(this.board.ublkmgr,"cuDivide")},checkConnectNumber:function(){this.checkOneArea(this.board.nblkmgr,"nmDivide")},checkOneArea:function(a,b){a.components.length>1&&(this.failcode.add(b),a.components[0].getnodeobjs().seterr(1))},checkConnectUnshadeRB:function(){if(this.board.ublkmgr.components.length>1){this.failcode.add("cuDivideRB");for(var a=new this.klass.CellList,b=this.board.cell.filter(function(a){return a.isShade()}),c=0;c<b.length;c++)for(var d=b[c],e=d.getdir4clist(),f=null,g=0;g<e.length;g++){var h=e[g][0];if(null===f)f=h.ublk;else if(f!==h.ublk){a.add(d);break}}a.seterr(1)}},checkShadeCellExist:function(){if(!this.puzzle.execConfig("allowempty")){var a=this.board;if(a.sblkmgr.enabled){if(a.sblkmgr.components.length>0)return}else if(a.ublkmgr.enabled){if(0===a.ublkmgr.components.length||a.ublkmgr.components[0].nodes.length!==a.cell.length)return}else if(a.cell.some(function(a){return a.isShade()}))return;this.failcode.add("brNoShade")}},checkOneLoop:function(){var a=this.board,b=a.linegraph.components;b.length>1&&(this.failcode.add("lnPlLoop"),a.border.setnoerr(),b[0].setedgeerr(1))},checkConnectAllNumber:function(){var a=this.board,b=a.linegraph.components;b.length>1&&(this.failcode.add("lcDivided"),a.border.setnoerr(),b[0].setedgeerr(1),b[0].clist.seterr(4))},checkLineExist:function(){if(!this.puzzle.execConfig("allowempty")){var a=this.board;if(a.linegraph.ltotal[0]!==(a.borderAsLine?a.cross:a.cell).length)return;this.failcode.add("brNoLine")}},checkCrossLine:function(){this.checkLineCount(4,"lnCross")},checkBranchLine:function(){this.checkLineCount(3,"lnBranch")},checkDeadendLine:function(){this.checkLineCount(1,"lnDeadEnd")},checkNoLine:function(){this.checkLineCount(0,"ceNoLine")},checkLineCount:function(a,b){var c=!0,d=this.board;if(d.linegraph.ltotal[a])if(d.borderAsLine){for(var e=d.cross,f=0;f<e.length;f++){var g=e[f];if(g.lcnt===a){if(c=!1,this.checkOnly)break;g.seterr(1),d.borderinside(g.bx-1,g.by-1,g.bx+1,g.by+1).seterr(1)}}c||(this.failcode.add(b),d.border.setnoerr())}else this.checkAllCell(function(b){return b.lcnt===a},b)},checkCrossConnectLine:function(){this.checkConnectLineCount(4,"lnCross")},checkBranchConnectLine:function(){this.checkConnectLineCount(3,"lnBranch")},checkDeadendConnectLine:function(){this.checkConnectLineCount(1,"lnDeadEnd")},checkConnectLineCount:function(a,b){this.board.linegraph.ltotal[a]&&this.checkAllCell(function(b){return b.noNum()&&b.lcnt===a},b)},checkenableLineParts:function(){for(var a=this.board,b=0;b<a.cell.length;b++){var c=a.cell[b],d=c.adjborder;if(d.top.isLine()&&c.noLP(c.UP)||d.bottom.isLine()&&c.noLP(c.DN)||d.left.isLine()&&c.noLP(c.LT)||d.right.isLine()&&c.noLP(c.RT)){if(this.failcode.add("ceAddLine"),this.checkOnly)break;c.seterr(1)}}},checkAllArea:function(a,b,c){this.checkAllBlock(a,null,b,c)},checkAllBlock:function(a,b,c,d){for(var e=a.components,f=0;f<e.length;f++){var g=e[f],h=g.clist,i=g.top?g.top:h.getQnumCell(),j=h.getRectSize(),k=(b?h.filter(b):h).length,l=i&&!i.isnull?i.qnum:-1;if(!c(j.cols,j.rows,k,l)){if(this.failcode.add(d),this.checkOnly)break;e!==this.board.linegraph?h.seterr("tateyoko"!==this.pid?1:4):(this.board.border.setnoerr(),g.objs.seterr(1))}}},checkNumberAndSize:function(){this.checkAllArea(this.board.roommgr,function(a,b,c,d){return 0>=d||d===c},"bkSizeNe")},checkRoomRect:function(){this.checkAllArea(this.board.roommgr,function(a,b,c,d){return a*b===c},"bkNotRect")},checkNoNumber:function(){this.checkAllBlock(this.board.roommgr,function(a){return a.isNum()},function(a,b,c,d){return 0!==c},"bkNoNum")},checkDoubleNumber:function(){this.checkAllBlock(this.board.roommgr,function(a){return a.isNum()},function(a,b,c,d){return 2>c},"bkNumGe2")},checkShadeCellCount:function(){this.checkAllBlock(this.board.roommgr,function(a){return a.isShade()},function(a,b,c,d){return 0>d||d===c},"bkShadeNe")},checkNoShadeCellInArea:function(){this.checkAllBlock(this.board.roommgr,function(a){return a.isShade()},function(a,b,c,d){return c>0},"bkNoShade")},checkLinesInArea:function(a,b,c){this.checkAllBlock(a,function(a){return a.lcnt>0},b,c)},checkNoMovedObjectInRoom:function(a){this.checkAllBlock(a,function(a){return-1!==a.base.qnum},function(a,b,c,d){return 0!==c},"bkNoNum")},checkDisconnectLine:function(){this.checkConnectObjectCount(function(a){return a>0},this.board.linegraph.moveline?"laIsolate":"lcIsolate")},checkConnectObject:function(){this.checkConnectObjectCount(function(a){return 2>a},"nmConnected")},checkTripleObject:function(){this.checkConnectObjectCount(function(a){return 3>a},"lcTripleNum")},checkConnectObjectCount:function(a,b){for(var c=!0,d=this.board.linegraph.components,e=0;e<d.length;e++){var f=d[e].clist;if(!a(f.filter(function(a){return a.isNum()}).length)){if(c=!1,this.checkOnly)break;this.board.border.setnoerr(),d[e].setedgeerr(1),d[e].clist.seterr(4)}}c||(this.failcode.add(b),this.board.border.setnoerr())},checkSideAreaSize:function(a,b){for(var c=this.board.roommgr.getSideAreaInfo("room"),d=0;d<c.length;d++){var e=a(c[d][0]),f=a(c[d][1]);if(!(0>=e||0>=f||e!==f)){if(this.failcode.add(b),this.checkOnly)break;c[d][0].clist.seterr(1),c[d][1].clist.seterr(1)}}},checkSideAreaCell:function(a,b,c){for(var d=0;d<this.board.border.length;d++){var e=this.board.border[d];if(e.isBorder()){var f=e.sidecell[0],g=e.sidecell[1];if(!f.isnull&&!g.isnull&&a(f,g)){if(this.failcode.add(c),this.checkOnly)break;b?(f.room.clist.seterr(1),g.room.clist.seterr(1)):(f.seterr(1),g.seterr(1))}}}},checkSameObjectInRoom:function(a,b,c){var d=a.components;a:for(var e=0;e<d.length;e++)for(var f=d[e].clist,g=-1,h=0;h<f.length;h++){var i=f[h],j=b(i);if(-1!==j&&g!==j)if(-1===g)g=j;else{if(this.failcode.add(c),this.checkOnly)break a;d!==this.board.linegraph.components?f.seterr(1):(this.board.border.setnoerr(),d[e].setedgeerr(1))}}},checkDifferentNumberInRoom:function(){this.checkDifferentNumberInRoom_main(this.board.roommgr,this.isDifferentNumberInClist)},checkDifferentNumberInRoom_main:function(a,b){for(var c=a.components,d=0;d<c.length;d++){var e=c[d].clist;if(!b.call(this,e)){if(this.failcode.add("bkDupNum"),this.checkOnly)break;e.seterr(1)}}},isDifferentNumberInClist:function(a){return this.isIndividualObject(a,function(a){return a.getNum()})},isDifferentAnsNumberInClist:function(a){return this.isIndividualObject(a,function(a){return a.anum})},isIndividualObject:function(a,b){if(a.length<=0)return!0;for(var c=!0,d=[],e=[],f=-1,g=a[0].getminnum(),h=0;h<a.length;h++)f<b(a[h])&&(f=b(a[h]));for(var i=g;f>=i;i++)d[i]=0;for(var h=0;h<a.length;h++)e[a[h].id]=b(a[h]);for(var h=0;h<a.length;h++)e[a[h].id]>=g&&d[e[a[h].id]]++;var j=a.filter(function(a){return e[a.id]>=g&&d[e[a.id]]>=2});return j.length>0&&(j.seterr(1),c=!1),c},checkRowsCols:function(a,b){var c=!0,d=this.board;a:do{for(var e=1;e<=d.maxby;e+=2){var f=d.cellinside(d.minbx+1,e,d.maxbx-1,e);if(!a.call(this,f)&&(c=!1,this.checkOnly))break a}for(var g=1;g<=d.maxbx;g+=2){var f=d.cellinside(g,d.minby+1,g,d.maxby-1);if(!a.call(this,f)&&(c=!1,this.checkOnly))break a}}while(0);c||this.failcode.add(b)},checkRowsColsPartly:function(a,b,c){var d,e=!0,f=this.board;a:do{d={keycell:null,key51num:-1,isvert:!1};for(var g=1;g<=f.maxby;g+=2)for(var h=1;h<=f.maxbx;h+=2){for(var i=h;i<=f.maxbx&&!b(f.getc(i,g));i+=2);if(d.keycell=f.getobj(h-2,g),d.key51num=d.keycell.qnum,i>h&&!a.call(this,f.cellinside(h,g,i-2,g),d)&&(e=!1,this.checkOnly))break a;h=i}d={keycell:null,key51num:-1,isvert:!0};for(var h=1;h<=f.maxbx;h+=2)for(var g=1;g<=f.maxby;g+=2){for(var j=g;j<=f.maxby&&!b(f.getc(h,j));j+=2);if(d.keycell=f.getobj(h,g-2),d.key51num=d.keycell.qnum2,j>g&&!a.call(this,f.cellinside(h,g,h,j-2),d)&&(e=!1,this.checkOnly))break a;g=j}}while(0);e||this.failcode.add(c)},checkRowsColsFor51cell:function(a,b){this.checkRowsColsPartly(a,function(a){return a.is51cell()},b)},checkBorderCross:function(){this.checkBorderCount(4,0,"bdCross")},checkBorderDeadend:function(){this.checkBorderCount(1,0,"bdDeadEnd")},checkBorderCount:function(a,b,c){for(var d=!0,e=this.board,f=2===e.hascross?e.cross:e.crossinside(e.minbx+2,e.minby+2,e.maxbx-2,e.maxby-2),g=0;g<f.length;g++){var h=f[g];if(!(h.lcnt!==a||1===b&&1!==h.qnum||2===b&&1===h.qnum)){if(d=!1,this.checkOnly)break;h.setCrossBorderError()}}d||(this.failcode.add(c),e.border.setnoerr())},checkLineShape:function(a,b){for(var c=!0,d=this.getLineShapeInfo(),e=0;e<d.length;e++){var f=d[e];if(f&&a(f)){if(c=!1,this.checkOnly)break;var g=f.cells;g[0]&&null!==g[0]&&g[0].seterr(1),g[1]&&null!==g[1]&&g[1].seterr(1),f.objs.seterr(1)}}c||(this.failcode.add(b),this.board.border.setnoerr())},checkLineShapeDeadend:function(){this.checkLineShape(function(a){return a.cells[1].isnull},"lcDeadEnd")},getLineShapeInfo:function(){if(this._info.num)return this._info.num;for(var a=this.board,b=[],c=[],d=0;d<a.border.length;d++)c[d]=!1;for(var e=a.cell.filter(function(a){return a.isNum()}),f=0;f<e.length;f++)for(var g=e[f],h=g.adjborder,i=[h.top,h.bottom,h.left,h.right],j=0;4>j;j++){var k=i[j];if(!k.isnull){var l=this.serachLineShapeInfo(g,j+1,c);l&&b.push(l)}}return this._info.num=b},serachLineShapeInfo:function(a,b,c){for(var d={objs:new this.klass.BorderList,cells:[a,null],ccnt:0,length:[],dir1:b,dir2:0},e=a.getaddr();;)if(e.movedir(b,1),e.oncell()){var f=e.getc(),g=f.adjborder;if(f.isnull||a===f||f.isNum())break;this.board.linegraph.iscrossing(f)&&f.lcnt>=3||(1!==b&&g.bottom.isLine()?(2!==b&&d.ccnt++,b=2):2!==b&&g.top.isLine()?(1!==b&&d.ccnt++,b=1):3!==b&&g.right.isLine()?(4!==b&&d.ccnt++,b=4):4!==b&&g.left.isLine()&&(3!==b&&d.ccnt++,b=3))}else{var h=e.getb();if(h.isnull||!h.isLine()||c[h.id])break;d.objs.add(h),c[h.id]=!0,isNaN(d.length[d.ccnt])?d.length[d.ccnt]=1:d.length[d.ccnt]++}return d.objs.length>0?(d.cells[1]=e.getc(),d.dir2=[0,2,1,4,3][b],d):null}},FailCode:{cs2x2:["2x2の黒マスのかたまりがあります。","There is a 2x2 block of shaded cells."],csNotSquare:["正方形でない黒マスのカタマリがあります。","A mass of shaded cells is not regular rectangle."],csAdjacent:["黒マスがタテヨコに連続しています。","Shaded cells are adjacent."],csDivide:["黒マスが分断されています。","Shaded cells are devided,"],cuDivide:["白マスが分断されています。","Unshaded cells are devided."],cuDivideRB:["白マスが分断されています。","Unshaded cells are devided."],brNoShade:["盤面に黒マスがありません。","There are no shaded cells on the board."],bkNoNum:["数字のないブロックがあります。","A block has no number."],bkNumGe2:["1つのブロックに2つ以上の数字が入っています。","A block has plural numbers."],bkDupNum:["同じブロックに同じ数字が入っています。","There are same numbers in a block."],bkPlNum:["複数種類の数字が入っているブロックがあります。","A block has two or more kinds of numbers."],bkSepNum:["同じ数字が異なるブロックに入っています。","One kind of numbers is included in dirrerent blocks."],bkSizeNe:["数字とブロックの大きさが違います。","The size of the block is not equal to the number."],bkShadeNe:["部屋の数字と黒マスの数が一致していません。","The number of shaded cells in the room and The number written in the room is different."],bkShadeDivide:["1つの部屋に入る黒マスが2つ以上に分裂しています。","Shaded cells are devided in one room."],bkNoShade:["黒マスがない部屋があります。","A room has no shaded cell."],bkMixed:["白マスと黒マスの混在したタイルがあります。","A tile includes both shaded and unshaded cells."],bkWidthGt1:["幅が１マスではないタタミがあります。","The width of the tatami is not one."],brNoLine:["線が引かれていません。","There is no line on the board."],bkNotRect:["四角形ではない部屋があります。","There is a room whose shape is not square."],bdDeadEnd:["途中で途切れている線があります。","There is a dead-end line."],bdCross:["十字の交差点があります。","There is a crossing border line."],lnDeadEnd:["途中で途切れている線があります。","There is a dead-end line."],lnBranch:["分岐している線があります。","There is a branch line."],lnCross:["線が交差しています。","There is a crossing line."],lnNotCrossMk:["十字の場所で線が交差していません。","A cross-joint cell doesn't have four-way lines."],lnCrossExIce:["氷の部分以外で線が交差しています。","A Line is crossed outside of ice."],lnCurveOnIce:["氷の部分で線が曲がっています。","A Line curve on ice."],lnPlLoop:["輪っかが一つではありません。","There are plural loops."],lnOnShade:["黒マスの上に線が引かれています。","There is a line on the shaded cell."],lcDeadEnd:["線が途中で途切れています。","There is a dead-end line."],lcDivided:["線が全体で一つながりになっていません。","All lines and numbers are not connected each other."],lcTripleNum:["3つ以上の数字がつながっています。","Three or more numbers are connected."],lcIsolate:["数字につながっていない線があります。","A line doesn't connect any number."],lcOnNum:["数字の上を線が通過しています。","A line goes through a number."],nmNoLine:["どこにもつながっていない数字があります。","A number is not connected another number."],nmConnected:["アルファベットが繋がっています。","There are connected letters."],laIsolate:["アルファベットにつながっていない線があります。","A line doesn't connect any letter."],laOnNum:["アルファベットの上を線が通過しています。","A line goes through a letter."],laCurve:["曲がっている線があります。","A line has curve."],laLenNe:["数字と線の長さが違います。","The length of a line is wrong."],ceNoNum:["数字の入っていないマスがあります。","There is an empty cell."],ceNoLine:["線が引かれていないマスがあります。","There is an empty cell."],ceAddLine:["最初から引かれている線があるマスに線が足されています。","Lines are added to the cell that the mark lie in by the question."],anShadeNe:["矢印の方向にある黒マスの数が正しくありません。","The number of shaded cells are not correct."],nmAdjacent:["同じ数字がタテヨコに連続しています。","Same numbers are adjacent."],nmDupRow:["同じ列に同じ数字が入っています。","There are same numbers in a row."],nmDivide:["タテヨコにつながっていない数字があります。","Numbers are devided."]}}),a.classmgr.makeCommon({BoardExec:{adjustNumberArrow:function(a,b){a&this.TURNFLIP&&this.adjustCellQdirArrow(a,b)},adjustCellArrow:function(a,b){a&this.TURNFLIP&&(this.klass.Cell.prototype.numberAsObject?this.adjustCellQnumArrow(a,b):this.adjustCellQdirArrow(a,b))},adjustCellQdirArrow:function(a,b){for(var c=this.getTranslateDir(a),d=this.board.cellinside(b.x1,b.y1,b.x2,b.y2),e=0;e<d.length;e++){var f=d[e],g=c[f.qdir];g&&f.setQdir(g)}},adjustCellQnumArrow:function(a,b){for(var c=this.getTranslateDir(a),d=this.board.cellinside(b.x1,b.y1,b.x2,b.y2),e=0;e<d.length;e++){var f=d[e],g=c[f.qnum];g&&f.setQnum(g);var g=c[f.anum];g&&f.setAnum(g)}},adjustBorderArrow:function(a,b){if(a&this.TURNFLIP)for(var c=this.getTranslateDir(a),d=this.board.borderinside(b.x1,b.y1,b.x2,b.y2),e=0;e<d.length;e++){var f,g=d[e];f=c[g.qdir],f&&g.setQdir(f)}},getTranslateDir:function(a){var b={};switch(a){case this.FLIPY:b={1:2,2:1};break;case this.FLIPX:b={3:4,4:3};break;case this.TURNR:b={1:4,2:3,3:1,4:2};break;case this.TURNL:b={1:3,2:4,3:2,4:1}}return b},adjustQues51_1:function(a,b){var c=1|b.x1,d=1|b.y1;this.qnumw=[],this.qnumh=[];for(var e=this.board,f=d;f<=b.y2;f+=2){this.qnumw[f]=[e.getex(-1,f).qnum];for(var g=c;g<=b.x2;g+=2){var h=e.getc(g,f);h.is51cell()&&this.qnumw[f].push(h.qnum)}}for(var g=c;g<=b.x2;g+=2){this.qnumh[g]=[e.getex(g,-1).qnum2];for(var f=d;f<=b.y2;f+=2){var h=e.getc(g,f);h.is51cell()&&this.qnumh[g].push(h.qnum2)}}},adjustQues51_2:function(a,b){var c,d=b.x1+b.x2,e=b.y1+b.y2,f=1|b.x1,g=1|b.y1,h=this.board;switch(h.disableInfo(),a){case this.FLIPY:for(var i=f;i<=b.x2;i+=2){c=1,this.qnumh[i]=this.qnumh[i].reverse(),h.getex(i,-1).setQnum2(this.qnumh[i][0]);for(var j=g;j<=b.y2;j+=2){var k=h.getc(i,j);k.is51cell()&&(k.setQnum2(this.qnumh[i][c]),c++)}}break;case this.FLIPX:for(var j=g;j<=b.y2;j+=2){c=1,this.qnumw[j]=this.qnumw[j].reverse(),h.getex(-1,j).setQnum(this.qnumw[j][0]);for(var i=f;i<=b.x2;i+=2){var k=h.getc(i,j);k.is51cell()&&(k.setQnum(this.qnumw[j][c]),c++)}}break;case this.TURNR:for(var j=g;j<=b.y2;j+=2){c=1,this.qnumh[j]=this.qnumh[j].reverse(),h.getex(-1,j).setQnum(this.qnumh[j][0]);for(var i=f;i<=b.x2;i+=2){var k=h.getc(i,j);k.is51cell()&&(k.setQnum(this.qnumh[j][c]),c++)}}for(var i=f;i<=b.x2;i+=2){c=1,h.getex(i,-1).setQnum2(this.qnumw[d-i][0]);for(var j=g;j<=b.y2;j+=2){var k=h.getc(i,j);k.is51cell()&&(k.setQnum2(this.qnumw[d-i][c]),c++)}}break;case this.TURNL:for(var j=g;j<=b.y2;j+=2){c=1,h.getex(-1,j).setQnum(this.qnumh[e-j][0]);for(var i=f;i<=b.x2;i+=2){var k=h.getc(i,j);k.is51cell()&&(k.setQnum(this.qnumh[e-j][c]),c++)}}for(var i=f;i<=b.x2;i+=2){c=1,this.qnumw[i]=this.qnumw[i].reverse(),h.getex(i,-1).setQnum2(this.qnumw[i][0]);for(var j=g;j<=b.y2;j+=2){var k=h.getc(i,j);k.is51cell()&&(k.setQnum2(this.qnumw[i][c]),c++)}}}h.enableInfo()},getAfterPos:function(a,b,c){var d,e,f=this.puzzle,g=f.board,h=b.x1+b.x2,i=b.y1+b.y2,j=c.bx,k=c.by;switch(a){case this.FLIPY:d=j,e=i-k;break;case this.FLIPX:d=h-j,e=k;break;case this.TURNR:d=i-k,e=j;break;case this.TURNL:d=k,e=h-j;break;case this.EXPANDUP:d=j,e=k+(k===g.minby?0:2);break;case this.EXPANDDN:d=j,e=k+(k===g.maxby?2:0);break;case this.EXPANDLT:d=j+(j===g.minbx?0:2),e=k;break;case this.EXPANDRT:d=j+(j===g.maxbx?2:0),e=k;break;case this.REDUCEUP:d=j,e=k-(k<=g.minby+2?0:2);break;case this.REDUCEDN:d=j,e=k-(k>=g.maxby-2?2:0);break;case this.REDUCELT:d=j-(j<=g.minbx+2?0:2),e=k;break;case this.REDUCERT:d=j-(j>=g.maxbx-2?2:0),e=k;break;default:d=j,e=k}return{pos:new f.klass.Address(d,e),isdel:this.isdel(a,c)}}}}),a.classmgr.makeCommon({Encode:{include:function(a,b,c){return a>=b&&c>=a},decode4Cell:function(){var a=0,b=0,c=this.outbstr,d=this.board;for(b=0;b<c.length;b++){var e=d.cell[a],f=c.charAt(b);if(this.include(f,"0","4")?e.qnum=parseInt(f,16):this.include(f,"5","9")?(e.qnum=parseInt(f,16)-5,a++):this.include(f,"a","e")?(e.qnum=parseInt(f,16)-10,a+=2):this.include(f,"g","z")?a+=parseInt(f,36)-16:"."===f&&(e.qnum=-2),a++,!d.cell[a])break}this.outbstr=c.substr(b+1)},encode4Cell:function(){for(var a=0,b="",c=this.board,d=0;d<c.cell.length;d++){var e="",f=c.cell[d].qnum;f>=0?c.cell[d+1]&&-1!==c.cell[d+1].qnum?e=""+f.toString(16):c.cell[d+2]&&-1!==c.cell[d+2].qnum?(e=""+(5+f).toString(16),d++):(e=""+(10+f).toString(16),d+=2):-2===f?e=".":a++,0===a?b+=e:(e||20===a)&&(b+=(a+15).toString(36)+e,a=0)}a>0&&(b+=(a+15).toString(36)),this.outbstr+=b},decode4Cross:function(){var a=0,b=0,c=this.outbstr,d=this.board;for(b=0;b<c.length;b++){var e=d.cross[a],f=c.charAt(b);if(this.include(f,"0","4")?e.qnum=parseInt(f,16):this.include(f,"5","9")?(e.qnum=parseInt(f,16)-5,a++):this.include(f,"a","e")?(e.qnum=parseInt(f,16)-10,a+=2):this.include(f,"g","z")?a+=parseInt(f,36)-16:"."===f&&(e.qnum=-2),a++,!d.cross[a])break}this.outbstr=c.substr(b+1)},encode4Cross:function(){for(var a=0,b="",c=this.board,d=0;d<c.cross.length;d++){var e="",f=c.cross[d].qnum;f>=0?c.cross[d+1]&&-1!==c.cross[d+1].qnum?e=""+f.toString(16):c.cross[d+2]&&-1!==c.cross[d+2].qnum?(e=""+(5+f).toString(16),d++):(e=""+(10+f).toString(16),d+=2):-2===f?e=".":a++,0===a?b+=e:(e||20===a)&&(b+=(a+15).toString(36)+e,a=0)}a>0&&(b+=(a+15).toString(36)),this.outbstr+=b},decodeNumber10:function(){var a=0,b=0,c=this.outbstr,d=this.board;for(b=0;b<c.length;b++){var e=d.cell[a],f=c.charAt(b);if("."===f?e.qnum=-2:this.include(f,"0","9")?e.qnum=parseInt(f,10):this.include(f,"a","z")&&(a+=parseInt(f,36)-10),a++,!d.cell[a])break}this.outbstr=c.substr(b+1)},encodeNumber10:function(){for(var a="",b=0,c=this.board,d=0;d<c.cell.length;d++){var e="",f=c.cell[d].qnum;-2===f?e=".":f>=0&&10>f?e=f.toString(10):b++,0===b?a+=e:(e||26===b)&&(a+=(9+b).toString(36)+e,b=0)}b>0&&(a+=(9+b).toString(36)),this.outbstr+=a},decodeNumber16:function(){var a=0,b=0,c=this.outbstr,d=this.board;for(b=0;b<c.length;b++){var e=d.cell[a],f=c.charAt(b);if(this.include(f,"0","9")||this.include(f,"a","f")?e.qnum=parseInt(f,16):"-"===f?(e.qnum=parseInt(c.substr(b+1,2),16),b+=2):"+"===f?(e.qnum=parseInt(c.substr(b+1,3),16),b+=3):"="===f?(e.qnum=parseInt(c.substr(b+1,3),16)+4096,b+=3):"%"===f?(e.qnum=parseInt(c.substr(b+1,3),16)+8192,b+=3):"."===f?e.qnum=-2:f>="g"&&"z">=f&&(a+=parseInt(f,36)-16),a++,!d.cell[a])break}this.outbstr=c.substr(b+1)},encodeNumber16:function(){for(var a=0,b="",c=this.board,d=0;d<c.cell.length;d++){var e="",f=c.cell[d].qnum;-2===f?e=".":f>=0&&16>f?e=f.toString(16):f>=16&&256>f?e="-"+f.toString(16):f>=256&&4096>f?e="+"+f.toString(16):f>=4096&&8192>f?e="="+(f-4096).toString(16):f>=8192?e="%"+(f-8192).toString(16):a++,0===a?b+=e:(e||20===a)&&(b+=(15+a).toString(36)+e,a=0)}a>0&&(b+=(15+a).toString(36)),this.outbstr+=b},decodeRoomNumber16:function(){var a=0,b=0,c=this.outbstr,d=this.board;for(d.roommgr.rebuild(),b=0;b<c.length;b++){var e=c.charAt(b),f=d.roommgr.components[a].top;if(this.include(e,"0","9")||this.include(e,"a","f")?f.qnum=parseInt(e,16):"-"===e?(f.qnum=parseInt(c.substr(b+1,2),16),b+=2):"+"===e?(f.qnum=parseInt(c.substr(b+1,3),16),b+=3):"="===e?(f.qnum=parseInt(c.substr(b+1,3),16)+4096,b+=3):"%"===e?(f.qnum=parseInt(c.substr(b+1,3),16)+8192,b+=3):"*"===e?(f.qnum=parseInt(c.substr(b+1,3),16)+12240,b+=4):"$"===e?(f.qnum=parseInt(c.substr(b+1,3),16)+77776,b+=5):e>="g"&&"z">=e&&(a+=parseInt(e,36)-16),a++,a>=d.roommgr.components.length)break}this.outbstr=c.substr(b+1)},encodeRoomNumber16:function(){var a=0,b="",c=this.board;c.roommgr.rebuild();for(var d=0;d<c.roommgr.components.length;d++){var e="",f=c.roommgr.components[d].top.qnum;f>=0&&16>f?e=f.toString(16):f>=16&&256>f?e="-"+f.toString(16):f>=256&&4096>f?e="+"+f.toString(16):f>=4096&&8192>f?e="="+(f-4096).toString(16):f>=8192&&12240>f?e="%"+(f-8192).toString(16):f>=12240&&77776>f?e="*"+(f-12240).toString(16):f>=77776?e="$"+(f-77776).toString(16):a++,0===a?b+=e:(e||20===a)&&(b+=(15+a).toString(36)+e,a=0)}a>0&&(b+=(15+a).toString(36)),this.outbstr+=b},decodeArrowNumber16:function(){var a=0,b=0,c=this.outbstr,d=this.board;for(b=0;b<c.length;b++){var e=c.charAt(b),f=d.cell[a];if(this.include(e,"0","4")){var g=c.charAt(b+1);f.qdir=parseInt(e,16),f.qnum="."!==g?parseInt(g,16):-2,b++}else this.include(e,"5","9")?(f.qdir=parseInt(e,16)-5,f.qnum=parseInt(c.substr(b+1,2),16),b+=2):e>="a"&&"z">=e&&(a+=parseInt(e,36)-10);if(a++,!d.cell[a])break}this.outbstr=c.substr(b+1)},encodeArrowNumber16:function(){for(var a="",b=0,c=this.board,d=0;d<c.cell.length;d++){var e="",f=c.cell[d].qdir,g=c.cell[d].qnum;-2===g?e=f+".":g>=0&&16>g?e=f+g.toString(16):g>=16&&256>g?e=f+5+g.toString(16):b++,0===b?a+=e:(e||26===b)&&(a+=(b+9).toString(36)+e,b=0)}b>0&&(a+=(b+9).toString(36)),this.outbstr+=a},decodeBorder:function(){var a,b,c,d=this.outbstr,e=[16,8,4,2,1],f=this.board;d?(a=Math.min(((f.cols-1)*f.rows+4)/5|0,d.length),b=Math.min(((f.cols*(f.rows-1)+4)/5|0)+a,d.length)):(a=0,b=0),c=0;for(var g=0;a>g;g++)for(var h=parseInt(d.charAt(g),32),i=0;5>i;i++)c<(f.cols-1)*f.rows&&(f.border[c].ques=h&e[i]?1:0,c++);c=(f.cols-1)*f.rows;for(var g=a;b>g;g++)for(var h=parseInt(d.charAt(g),32),i=0;5>i;i++){var j=f.border[c];j&&j.inside&&(j.ques=h&e[i]?1:0,c++)}f.roommgr.rebuild(),this.outbstr=d.substr(b)},encodeBorder:function(){for(var a="",b=[16,8,4,2,1],c=0,d=0,e=this.board,f=0;f<(e.cols-1)*e.rows;f++)d+=e.border[f].ques*b[c],c++,5===c&&(a+=d.toString(32),c=0,d=0);c>0&&(a+=d.toString(32)),c=0,d=0;for(var f=(e.cols-1)*e.rows;f<2*e.cols*e.rows-e.cols-e.rows;f++)d+=e.border[f].ques*b[c],c++,5===c&&(a+=d.toString(32),c=0,d=0);c>0&&(a+=d.toString(32)),this.outbstr+=a},decodeCrossMark:function(){var a=0,b=0,c=this.outbstr,d=this.board,e=2===d.hascross?1:0,f=e<<1,g=d.rows-1+f,h=d.cols-1+f;for(b=0;b<c.length;b++){var i=c.charAt(b);if(this.include(i,"0","9")||this.include(i,"a","z")){a+=parseInt(i,36);var j=a%h+(1-e)<<1,k=(a/h|0)+(1-e)<<1;if(k>d.maxby-2*(1-e)){b++;break}d.getx(j,k).qnum=1}else"."===i&&(a+=35);if(a++,a>=h*g){b++;break}}this.outbstr=c.substr(b)},encodeCrossMark:function(){for(var a="",b=0,c=this.board,d=2===c.hascross?1:0,e=d<<1,f=c.rows-1+e,g=c.cols-1+e,h=0,i=g*f;i>h;h++){var j="",k=h%g+(1-d)<<1,l=(h/g|0)+(1-d)<<1;1===c.getx(k,l).qnum?j=".":b++,j?(a+=b.toString(36),b=0):36===b&&(a+=".",b=0)}b>0&&(a+=b.toString(36)),this.outbstr+=a},decodeCircle:function(){for(var a=this.board,b=this.outbstr,c=0,d=[9,3,1],e=b?Math.min((a.cols*a.rows+2)/3|0,b.length):0,f=0;e>f;f++)for(var g=parseInt(b.charAt(f),27),h=0;3>h;h++)if(a.cell[c]){var i=(g/d[h]|0)%3;i>0&&(a.cell[c].qnum=i),c++}this.outbstr=b.substr(e)},encodeCircle:function(){for(var a=this.board,b="",c=0,d=0,e=[9,3,1],f=0;f<a.cell.length;f++)a.cell[f].qnum>0&&(d+=a.cell[f].qnum*e[c]),c++,3===c&&(b+=d.toString(27),c=0,d=0);c>0&&(b+=d.toString(27)),this.outbstr+=b},decodeIce:function(){for(var a=this.outbstr,b=this.board,c=0,d=[16,8,4,2,1],e=0;e<a.length;e++){for(var f=parseInt(a.charAt(e),32),g=0;5>g;g++)b.cell[c]&&(b.cell[c].ques=f&d[g]?6:0,c++);if(!b.cell[c])break}this.outbstr=a.substr(e+1)},encodeIce:function(){for(var a="",b=0,c=0,d=[16,8,4,2,1],e=this.board,f=0;f<e.cell.length;f++)6===e.cell[f].ques&&(c+=d[b]),b++,5===b&&(a+=c.toString(32),b=0,c=0);b>0&&(a+=c.toString(32)),this.outbstr+=a},decodecross_old:function(){for(var a=this.outbstr,b=0,c=this.board,d=0;d<a.length;d++){var e=a.charAt(d);if(this.include(e,"0","4")&&(c.cross[b].qnum=parseInt(e,10)),b++,!c.cross[b]){d++;break}}this.outbstr=a.substr(d)}}}),a.classmgr.makeCommon({FileIO:{decodeCellQnum:function(){this.decodeCell(function(a,b){"-"===b?a.qnum=-2:"."!==b&&(a.qnum=+b)})},encodeCellQnum:function(){this.encodeCell(function(a){return a.qnum>=0?a.qnum+" ":-2===a.qnum?"- ":". "})},decodeCellQnumb:function(){this.decodeCell(function(a,b){"5"===b?a.qnum=-2:"."!==b&&(a.qnum=+b)})},encodeCellQnumb:function(){this.encodeCell(function(a){return a.qnum>=0?a.qnum+" ":-2===a.qnum?"5 ":". "})},decodeCellQnumAns:function(){this.decodeCell(function(a,b){"#"===b?a.qans=1:"+"===b?a.qsub=1:"-"===b?a.qnum=-2:"."!==b&&(a.qnum=+b)})},encodeCellQnumAns:function(){this.encodeCell(function(a){return a.qnum>=0?a.qnum+" ":-2===a.qnum?"- ":1===a.qans?"# ":1===a.qsub?"+ ":". "})},decodeCellDirecQnum:function(){this.decodeCell(function(a,b){if("."!==b){var c=b.split(",");a.qdir="0"!==c[0]?+c[0]:0,a.qnum="-"!==c[1]?+c[1]:-2}})},encodeCellDirecQnum:function(){this.encodeCell(function(a){if(-1!==a.qnum){var b=0!==a.qdir?""+a.qdir:"0",c=-2!==a.qnum?""+a.qnum:"-";return[b,",",c," "].join("")}return". "})},decodeCellAns:function(){this.decodeCell(function(a,b){"#"===b?a.qans=1:"+"===b&&(a.qsub=1)})},encodeCellAns:function(){this.encodeCell(function(a){return 1===a.qans?"# ":1===a.qsub?"+ ":". "})},decodeCellQanssub:function(){this.decodeCell(function(a,b){"+"===b?a.qsub=1:"-"===b?a.qsub=2:"="===b?a.qsub=3:"%"===b?a.qsub=4:"."!==b&&(a.qans=+b)})},encodeCellQanssub:function(){this.encodeCell(function(a){return 0!==a.qans?a.qans+" ":1===a.qsub?"+ ":2===a.qsub?"- ":3===a.qsub?"= ":4===a.qsub?"% ":". "})},decodeCellAnumsub:function(){this.decodeCell(function(a,b){"+"===b?a.qsub=1:"-"===b?a.qsub=2:"="===b?a.qsub=3:"%"===b?a.qsub=4:"."!==b&&(a.anum=+b)})},encodeCellAnumsub:function(){this.encodeCell(function(a){return-1!==a.anum?a.anum+" ":1===a.qsub?"+ ":2===a.qsub?"- ":3===a.qsub?"= ":4===a.qsub?"% ":". "})},decodeCellQsub:function(){this.decodeCell(function(a,b){"0"!==b&&(a.qsub=+b)})},encodeCellQsub:function(){this.encodeCell(function(a){return a.qsub>0?a.qsub+" ":"0 "})},decodeCrossNum:function(){this.decodeCross(function(a,b){"-"===b?a.qnum=-2:"."!==b&&(a.qnum=+b)})},encodeCrossNum:function(){this.encodeCross(function(a){return a.qnum>=0?a.qnum+" ":-2===a.qnum?"- ":". "})},decodeBorderQues:function(){this.decodeBorder(function(a,b){"1"===b&&(a.ques=1)})},encodeBorderQues:function(){this.encodeBorder(function(a){return(1===a.ques?"1":"0")+" "})},decodeBorderAns:function(){this.decodeBorder(function(a,b){"2"===b?(a.qans=1,a.qsub=1):"1"===b?a.qans=1:"-1"===b&&(a.qsub=1)})},encodeBorderAns:function(){this.encodeBorder(function(a){return 1===a.qans&&1===a.qsub?"2 ":1===a.qans?"1 ":1===a.qsub?"-1 ":"0 "})},decodeBorderLine:function(){this.decodeBorder(function(a,b){"-1"===b?a.qsub=2:"0"!==b&&(a.line=+b)})},encodeBorderLine:function(){this.encodeBorder(function(a){return a.line>0?a.line+" ":2===a.qsub?"-1 ":"0 "})},decodeAreaRoom:function(){this.decodeAreaRoom_com(!0)},encodeAreaRoom:function(){this.encodeAreaRoom_com(!0)},decodeAreaRoom_com:function(a){this.readLine(),this.rdata2Border(a,this.getItemList(this.board.rows)),this.board.roommgr.rebuild()},encodeAreaRoom_com:function(a){var b=this.board;
b.roommgr.rebuild();var c=b.roommgr.components;this.datastr+=c.length+"\n";for(var d=0;d<b.cell.length;d++){var e=c.indexOf(b.cell[d].room);this.datastr+=""+(e>=0?e:".")+" ",(d+1)%b.cols===0&&(this.datastr+="\n")}},rdata2Border:function(a,b){for(var c=this.board,d=0;d<c.border.length;d++){var e=c.border[d],f=e.sidecell[0],g=e.sidecell[1],h=!f.isnull&&!g.isnull&&b[f.id]!==b[g.id];e[a?"ques":"qans"]=h?1:0}},decodeCellQnum51:function(){var a=this.board,b=this.getItemList(a.rows+1);a.disableInfo();for(var c=0;c<b.length;c++)if("."!==b[c]){var d=2*(c%(a.cols+1)-1)+1,e=2*((c/(a.cols+1)|0)-1)+1;if(-1===d||-1===e){var f=a.getex(d,e),g=-1===f.by?"qnum2":"qnum";f[g]=+b[c]}else{var h=b[c].split(","),i=a.getc(d,e);i.set51cell(),i.qnum=+h[0],i.qnum2=+h[1]}}a.enableInfo()},encodeCellQnum51:function(){for(var a=this.board,b="",c=a.minby+1;c<a.maxby;c+=2){for(var d=a.minbx+1;d<a.maxbx;d+=2)if(-1===d&&-1===c)b+="0 ";else if(-1===d||-1===c){var e=a.getex(d,c),f=-1===e.by?"qnum2":"qnum";b+=e[f]+" "}else{var g=a.getc(d,c);b+=51===g.ques?g.qnum+","+g.qnum2+" ":". "}b+="\n"}this.datastr+=b},decodeCellQnum_kanpen:function(){this.decodeCell(function(a,b){"."!==b&&(a.qnum=+b)})},encodeCellQnum_kanpen:function(){this.encodeCell(function(a){return a.qnum>=0?a.qnum+" ":". "})},decodeCellAnum_kanpen:function(){this.decodeCell(function(a,b){"."!==b&&"0"!==b&&(a.anum=+b)})},encodeCellAnum_kanpen:function(){this.encodeCell(function(a){return-1!==a.qnum?". ":-1===a.anum?"0 ":a.anum+" "})},decodeCellQnumAns_kanpen:function(){this.decodeCell(function(a,b){"#"===b?a.qans=1:"+"===b?a.qsub=1:"?"===b?a.qnum=-2:"."!==b&&(a.qnum=+b)})},encodeCellQnumAns_kanpen:function(){this.encodeCell(function(a){return a.qnum>=0?a.qnum+" ":-2===a.qnum?"? ":1===a.qans?"# ":1===a.qsub?"+ ":". "})},UNDECIDED_NUM_XML:-1,decodeCellQnum_XMLBoard:function(){var a=this.board.cell[0].getminnum()>0?1:0,b=this.UNDECIDED_NUM_XML;this.decodeCellXMLBoard(function(c,d){d===b?c.qnum=-2:d>=a&&(c.qnum=d)})},encodeCellQnum_XMLBoard:function(){var a=this.board.cell[0].getminnum()>0?1:0,b=this.UNDECIDED_NUM_XML;this.encodeCellXMLBoard(function(c){var d=null;return-2===c.qnum?d=b:c.qnum>=a&&(d=c.qnum),d})},decodeCellQnum_XMLBoard_Brow:function(){var a=this.UNDECIDED_NUM_XML;this.decodeCellXMLBrow(function(b,c){c==="n"+a?b.qnum=-2:"s"!==c&&(b.qnum=+c.substr(1))})},encodeCellQnum_XMLBoard_Brow:function(){var a=this.UNDECIDED_NUM_XML;this.encodeCellXMLBrow(function(b){return-2===b.qnum?"n"+a:b.qnum>=0?"n"+b.qnum:"s"})},decodeCellAnum_XMLAnswer:function(){this.decodeCellXMLArow(function(a,b){"n0"===b?a.anum=-1:"s"!==b&&(a.anum=+b.substr(1))})},encodeCellAnum_XMLAnswer:function(){this.encodeCellXMLArow(function(a){return a.anum>0?"n"+a.anum:-1===a.anum?"n0":"s"})},decodeAreaRoom_XMLBoard:function(){var a=[];this.decodeCellXMLBrow(function(b,c){a.push(+c.substr(1))}),this.rdata2Border(!0,a),this.board.roommgr.rebuild()},encodeAreaRoom_XMLBoard:function(){var a=this.board;a.roommgr.rebuild();var b=a.roommgr.components;this.xmldoc.querySelector("board").appendChild(this.createXMLNode("areas",{N:b.length})),this.encodeCellXMLBrow(function(a){var c=b.indexOf(a.room);return"n"+(c>0?c:-1)})},decodeCellAns_XMLAnswer:function(){this.decodeCellXMLArow(function(a,b){"w"===b?a.qans=1:"s"===b&&(a.qsub=1)})},encodeCellAns_XMLAnswer:function(){this.encodeCellXMLArow(function(a){return 1===a.qans?"w":1===a.qsub?"s":"u"})},decodeBorderLine_XMLAnswer:function(){this.decodeCellXMLArow(function(a,b){var c=0,d=a.adjborder.bottom,e=a.adjborder.right;"n"===b.charAt(0)?c=+b.substr(1):(b.match(/h/)&&(c+=1),b.match(/v/)&&(c+=2)),1&c&&(d.line=1),2&c&&(e.line=1),4&c&&(d.qsub=2),8&c&&(e.qsub=2)})},encodeBorderLine_XMLAnswer:function(){this.encodeCellXMLArow(function(a){var b=0,c="",d=a.adjborder.bottom,e=a.adjborder.right;return 1===d.line&&(b+=1),1===e.line&&(b+=2),2===d.qsub&&(b+=4),2===e.qsub&&(b+=8),c=0===b?"s":1===b?"h":2===b?"v":3===b?"hv":"n"+b})}}})}();